<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Build and Run - FreeTensor</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Build and Run";
        var mkdocs_page_input_path = "guide/build-and-run.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../..">
          <img src="../../resource/logo-light.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">FreeTensor</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://github.com/roastduck/FreeTensor">GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">User Guide</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../">Get Started</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Build and Run</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../first-program/">Your First Program with FreeTenor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../schedules/">Optimize a Program with Schedules</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../hint/">Optimize a Program with Hints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gpu/">Running on a GPU</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ad/">Automatic Differentiation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/">Python API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../doxygen/html/">Internal C++ Interface</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">About</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../about/contrib/">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../about/pub/">Publication</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://github.com/roastduck/FreeTensor/blob/master/LICENSE">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">FreeTensor</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>User Guide &raquo;</li>
      <li>Build and Run</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="build-and-run">Build and Run<a class="headerlink" href="#build-and-run" title="Permanent link">&para;</a></h1>
<div class="toc">
<ul>
<li><a href="#dependencies">Dependencies</a></li>
<li><a href="#build">Build</a></li>
<li><a href="#global-configurations">Global Configurations</a></li>
<li><a href="#run-the-tests">Run the Tests</a></li>
<li><a href="#build-this-document">Build this Document</a></li>
</ul>
</div>
<h2 id="dependencies">Dependencies<a class="headerlink" href="#dependencies" title="Permanent link">&para;</a></h2>
<ul>
<li>Linux</li>
<li>Python (&gt;= 3.8, for the Python frontend)</li>
<li>C++ compiler (GCC &gt;= 11 or Clang &gt;= 16, to have enough C++20 support and the "unroll" pragma)</li>
<li>CUDA (&gt;= 11.4.1, to support GCC 11, Optional, only supported with GCC)</li>
<li>MKL (Optional)</li>
<li>PyTorch (Optional, see below)</li>
<li>Java (= 11, Build-time dependency only)</li>
</ul>
<p>Other Python dependencies can be installed automatically when installing FreeTensor.</p>
<div class="admonition note">
<p class="admonition-title">Note on Python version</p>
<p>Because we are analyzing Python AST, which is sensitive to Python version, there may be potential bugs for Python strictly later than 3.8. Please file an issue if something goes wrong</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Conflict with PyTorch</p>
<p>FreeTensor can be used together with PyTorch, and FreeTensor provides an optional integration with PyTorch. <em>With or without</em> this integration, FreeTensor may conflict with PyTorch if they both linked against some common dependencies but these dependencies are of different versions. This conflict can lead to weird error both at compile time and run time, and silent performance drop. Thus we highly recommand to build FreeTensor and PyTorch locally in the same environment. We also provide scripts to build a docker container for this purpose (see below).</p>
</div>
<h2 id="build">Build<a class="headerlink" href="#build" title="Permanent link">&para;</a></h2>
<p>First, clone this repo. Don't forget there are some submodules.</p>
<pre><code class="language-sh">git clone --recursive &lt;path/to/this/repo&gt;
</code></pre>
<p>Then, build and install.</p>
<pre><code class="language-sh">pip3 install .
</code></pre>
<p>This command will build FreeTensor with minimal dependencies. To build with a larger feature set, append one or more following <code>-C--local=???.toml</code> options to the command. Please note that these options requires a new enough <code>pip</code>.</p>
<ul>
<li><code>pip3 install . -C--local=with-cuda.toml</code>: Build with CUDA.</li>
<li><code>pip3 install . -C--local=with-mkl.toml</code>: Build with MKL.</li>
<li><code>pip3 install . -C--local=with-pytorch.toml</code>: Build with PyTorch.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note if building with PyTorch</p>
<p>Since there are conflicts with PyTorch as described above, we do not manage PyTorch as a dependency in the Python project, and it should be installed manually before installing FreeTensor. However, this breaks the requirement of <code>pip</code> that all dependencies should be declared, so <code>pip</code> must be called with <code>--no-build-isolation</code>, and this further requires installing the following build-time dependencies manally: <code>pip3 install py-build-cmake~=0.1.8 z3-solver setuptools</code>.</p>
</div>
<p>The <code>.toml</code> files in these options can be found in the root directory of this repository, in which options to CMake are set. The full set of CMake options of FreeTensor are:</p>
<ul>
<li><code>-DFT_WITH_CUDA=ON/OFF</code>: build with/without CUDA (defaults to <code>ON</code>).</li>
<li>
<p><code>-DFT_WITH_MKL=ON/&lt;path/to/mkl/root&gt;/OFF</code>: build with MKL (defaults to <code>OFF</code>).</p>
<p>The path accepts by CMake should be a raw unescaped path; i.e. <code>-DFT_WITH_MKL="/some path"</code> is good since the quotes are resolved by the shell but <code>-DFT_WITH_MKL=\"/some\ path\"</code> is not.</p>
</li>
<li>
<p><code>-DFT_WITH_PYTORCH=ON/OFF</code>: build with/without PyTorch integration (including copy-free interface from/to PyTorch), requring PyTorch installed on the system (defaults to <code>OFF</code>).</p>
</li>
<li><code>-DFT_COMPILER_PORTABLE=ON/OFF</code>: do not build FreeTensor itself and its dependencies with non-portable instructions (defaults to <code>OFF</code>).</li>
<li><code>-DFT_WITH_CCACHE=ON/OFF/AUTO</code>: use ccache to speed up compilation, which is useful for compiling behind py-build-cmake (defaults to <code>AUTO</code>).</li>
<li><code>-DFT_DEBUG_BLAME_AST=ON</code> (for developers): enables tracing to tell by which pass a specific AST node is modified.</li>
<li><code>-DFT_DEBUG_PROFILE=ON</code> (for developers): profiles some heavy functions in the compiler.</li>
<li><code>-DFT_DEBUG_SANITIZE=&lt;sanitizer_name&gt;</code> (for developers): build with GCC sanitizer (set it to a sanitizer name to use, e.g. address).</li>
</ul>
<p>You can create your own <code>.toml</code> files to set them explicitly.</p>
<p>Alternatively, you can build our docker images by <code>make -f docker.Makefile &lt;variant&gt;</code>, where <code>&lt;variant&gt;</code> can be:</p>
<ul>
<li><code>minimal-dev</code>, for <code>-DFT_WITH_CUDA=OFF -DFT_WITH_MKL=OFF -DFT_WITH_PYTORCH=OFF</code>, or</li>
<li><code>cuda-mkl-dev</code>, for <code>-DFT_WITH_CUDA=ON -DFT_WITH_MKL=ON -DFT_WITH_PYTORCH=OFF</code>, or</li>
<li><code>cuda-mkl-pytorch-dev</code>, for <code>-DFT_WITH_CUDA=ON -DFT_WITH_MKL=ON -DFT_WITH_PYTORCH=ON</code>.</li>
</ul>
<p>After installation, simply <code>import freetensor</code> to Python to use.</p>
<h2 id="global-configurations">Global Configurations<a class="headerlink" href="#global-configurations" title="Permanent link">&para;</a></h2>
<p>There are serveral global configurations can be set via environment variables:</p>
<ul>
<li><code>FT_PRETTY_PRINT=ON/OFF</code>. Enable/disable colored printing. If omitted, FreeTensor will guess this option with runtime information.</li>
<li><code>FT_PRINT_ALL_ID=ON/OFF</code>. Print (or not) IDs of all statements in an AST. Defaults to <code>OFF</code>.</li>
<li><code>FT_PRINT_SOURCE_LOCATION=ON/OFF</code>. Print (or not) Python source location of all statements in an AST. Defaults to <code>OFF</code>.</li>
<li><code>FT_FAST_MATH=ON/OFF</code>. Run (or not) <code>pass/float_simplify</code> optimization pass, and enable (or not) fast math on backend compilers. Defaults to <code>ON</code>.</li>
<li><code>FT_WERROR=ON/OFF</code>. Treat warnings as errors (or not). Defaults to <code>OFF</code>.</li>
<li><code>FT_BACKEND_COMPILER_CXX=&lt;path/to/compiler&gt;</code>. The C++ compiler used to compile the optimized program. Default to the same compiler found when building FreeTensor itself, and compilers found in the <code>PATH</code> enviroment variable. This environment variable should be set to a colon-separated list of paths, in which the paths are searched from left to right.</li>
<li><code>FT_BACKEND_COMPILER_NVCC=&lt;path/to/compiler&gt;</code>. The CUDA compiler used to compile the optimized program (if built with CUDA). Default to the same compiler found when building FreeTensor itself, and compilers found in the <code>PATH</code> enviroment variable. This environment variable should be set to a colon-separated list of paths, in which the paths are searched from left to right.</li>
<li><code>FT_BACKEND_OPENMP</code>. Path to an OpenMP library linked to the optimized program. Default to the same library linked to FreeTensor itself. This environment variable should be set to a colon-separated list of paths, in which the libraries are linked from left to right.</li>
<li><code>FT_DEBUG_RUNTIME_CHECK=ON/OFF</code>. If <code>ON</code>, check out-of-bound access and integer overflow at the generated code at runtime. This option is only for debugging, and will introduce significant runtime overhead. Currently the checker cannot print the error site, please also enable <code>FT_DEBUG_BINARY</code> and then use GDB to locate the error site (by setting a breakpoint on <code>exit</code>). Defaults to <code>OFF</code>.</li>
<li><code>FT_DEBUG_BINARY=ON/OFF</code> (for developers). If <code>ON</code>, compile with <code>-g</code> at backend. FreeTensor will not delete the binary file after loading it. Defaults to <code>OFF</code>.</li>
<li><code>FT_DEBUG_CUDA_WITH_UM=ON/OFF</code>. If <code>ON</code>, allocate CUDA buffers on Unified Memory, for faster (debugging) access of GPU <code>Array</code> from CPU, but with slower <code>Array</code> allocations and more synchronizations. No performance effect on normal in-kernel computations. Defaults to <code>OFF</code>.</li>
</ul>
<p>This configurations can also set at runtime in <a href="../../api/#freetensor.core.config"><code>ft.config</code></a>.</p>
<h2 id="run-the-tests">Run the Tests<a class="headerlink" href="#run-the-tests" title="Permanent link">&para;</a></h2>
<p>To run the test, first change into the <code>test/</code> directory, then</p>
<pre><code class="language-sh">pytest
</code></pre>
<p>To run a single test case, specify the test case name, and optionally use <code>pytest -s</code> to display the standard output. E.g,</p>
<pre><code class="language-sh">pytest -s 00.hello_world/test_basic.py::test_hello_world
</code></pre>
<div class="admonition note">
<p class="admonition-title">Debugging (for developers)</p>
<p>If using GDB, one should invoke PyTest with <code>python3 -m</code>:</p>
<p><code>gdb --args python3 -m pytest</code></p>
<p>If using Valgrind, one should set Python to use the system malloc:</p>
<p><code>PYTHONMALLOC=malloc valgrind python3 -m pytest</code></p>
<p>Sometimes Valgrind is not enough to detect some errors. An alternative is to use the sanitizer from GCC. For example, if you are using the "address" sanitizer, first set <code>-DFT_DEBUG_SANITIZE=address</code> to <code>cmake</code>, and then:</p>
<p><code>LD_PRELOAD=`gcc -print-file-name=libasan.so` pytest -s</code></p>
<p>If you are using another sanitizer, change the string set to <code>FT_DEBUG_SANITIZE</code> and the library's name. For example, <code>-DFT_DEBUG_SANITIZE=undefined</code> and <code>libubsan.so</code>.</p>
</div>
<h2 id="build-this-document">Build this Document<a class="headerlink" href="#build-this-document" title="Permanent link">&para;</a></h2>
<p>First install some dependencies:</p>
<pre><code class="language-sh">pip3 install --user mkdocs mkdocstrings==0.18.1 &quot;pytkdocs[numpy-style]&quot;
</code></pre>
<p>From the root directory of FreeTensor, run a HTTP server to serve the document (recommended, but without document on C++ interface due to <a href="https://github.com/mkdocs/mkdocs/issues/1901">a limitation</a>):</p>
<pre><code class="language-sh">mkdocs serve
</code></pre>
<p>Or build and save the pages (with document on C++ interface, requiring Doxygen and Graphviz):</p>
<pre><code class="language-sh">doxygen Doxyfile &amp;&amp; mkdocs build
</code></pre>
<div class="admonition note">
<p class="admonition-title">Publish the documents to GitHub Pages (for developers)</p>
<p><code>doxygen Doxyfile &amp;&amp; mkdocs gh-deploy</code></p>
</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../" class="btn btn-neutral float-left" title="Get Started"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../first-program/" class="btn btn-neutral float-right" title="Your First Program with FreeTenor">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../first-program/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../javascripts/mathjax.js" defer></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
