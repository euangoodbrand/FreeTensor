<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Python API - FreeTensor</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Python API";
        var mkdocs_page_input_path = "api.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../resource/logo-light.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">FreeTensor</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://github.com/roastduck/FreeTensor">GitHub</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">User Guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../guide/">Get Started</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guide/build-and-run/">Build and Run</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guide/first-program/">Your First Program with FreeTenor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guide/schedules/">Optimize a Program with Schedules</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guide/hint/">Optimize a Program with Hints</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guide/gpu/">Running on a GPU</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../guide/ad/">Automatic Differentiation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Python API</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../doxygen/html/">Internal C++ Interface</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">About</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../about/contrib/">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../about/pub/">Publication</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://github.com/roastduck/FreeTensor/blob/master/LICENSE">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">FreeTensor</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>API Reference &raquo;</li>
      <li>Python API</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="python-api">Python API<a class="headerlink" href="#python-api" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">


<a id="freetensor"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h2 id="freetensor.core" class="doc doc-heading">
          <code>core</code>


<a href="#freetensor.core" class="headerlink" title="Permanent link">&para;</a></h2>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="freetensor.core.autograd" class="doc doc-heading">
          <code>autograd</code>


<a href="#freetensor.core.autograd" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="freetensor.core.autograd.ArgRetDict" class="doc doc-heading">
        <code>ArgRetDict</code>


<a href="#freetensor.core.autograd.ArgRetDict" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">

  
      <p>Look an object using either a function argument or return value's name or its position</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/autograd.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ArgRetDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Look an object using either a function argument or return value&#39;s name or its position &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">d</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Return</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="c1"># Python&#39;s auto fallback from __getitem__ to __contains__ only works for</span>
        <span class="c1"># integer index</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Return</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.autograd.Return" class="doc doc-heading">
        <code>Return</code>


<a href="#freetensor.core.autograd.Return" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">

  
      <p>Alias of a return value of a function</p>
<p><code>Return(n)</code> represents the n-th return value (counted from 0)</p>
<p><code>Return()</code> can be used if there is only one return value</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/autograd.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Return</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Alias of a return value of a function</span>

<span class="sd">    `Return(n)` represents the n-th return value (counted from 0)</span>

<span class="sd">    `Return()` can be used if there is only one return value</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has no return value&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">returns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">func</span><span class="o">.</span><span class="n">returns</span>
            <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has more than one return value, and you need to specify the number of a return value&quot;</span>
            <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">returns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Return(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h4 id="freetensor.core.autograd.grad" class="doc doc-heading">
<code class="highlight language-python"><span class="n">grad</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">requires</span><span class="p">,</span> <span class="n">provides</span><span class="p">,</span> <span class="n">tapes</span><span class="o">=</span><span class="n">GradTapeMode</span><span class="o">.</span><span class="n">NoReuseOnly</span><span class="p">,</span> <span class="n">tape_in_closure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user_grads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.core.autograd.grad" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Reverse mode automatic differentiation</p>
<p>It returns a forward function and a backward function. The forward has the same
interface of the original function, but it will store some intermediate tensors
(the tape) to be reused by the backward function in some global states. The
backward function computes the gradients.</p>
<p><code>grad</code> is an out-of-place version. The resulting gradient are returned from the
backward function.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>func</code></td>
          <td>
                <code>AST</code>
          </td>
          <td><p>The original function</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>requires</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[str]</code>
          </td>
          <td><p>Name of input variables that need gradients</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>provides</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[<span title="typing.Union">Union</span>[str, <a class="autorefs autorefs-internal" title="freetensor.core.autograd.Return" href="#freetensor.core.autograd.Return">Return</a>]]</code>
          </td>
          <td><p>Name of output variables whose gradients are known. A return value of a
function can be specified with a <code>Return</code> object</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tapes</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<span title="typing.Sequence">Sequence</span>, <span title="freetensor_ffi.GradTapeMode">GradTapeMode</span>]</code>
          </td>
          <td><p>Intermediate variables that need to be stored from the forward pass and
reused in the backward pass. This parameter can be a sequence, which contains
VarDef selectors of them. It can also be a <code>GradTapeMode</code>, then it will determine
which intermediate variables to be stored by heuristics. Avail <code>GradTapeMode</code>s
are: All: store all variables including local scalars; None: store nothing;
NoReuseOnly: store variables that only hold one version of data, which means
we do not have to store each version of them in their history</p></td>
          <td>
                <code>GradTapeMode.NoReuseOnly</code>
          </td>
        </tr>
        <tr>
          <td><code>tape_in_closure</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>True to pass taped tensors from the forward function to the backward function in
implicit I/O parameters, i.e. in closure. False to pass these tensors as
explicit I/O parameters. Default to True</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>invert</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If set to true, it can reduce the amount of recomputation or taping required.
However, this may result in a loss of precision for floating-point numbers. Defaults</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>user_grads</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Sequence">Sequence</span>[<span title="freetensor_ffi">ffi</span>.<span title="freetensor_ffi.StmtSetToUserGrad">StmtSetToUserGrad</span>]]</code>
          </td>
          <td><p>For custom gradient. You do not have to explicitly set this parameter unless you
are manipulating <code>func</code> by yourself (not getting it from the Python frontend). See
<code>UserGrad</code> for details</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>verbose</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>Verbosity level</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>tuple</code>
          </td>
          <td><p>(
0. Forward AST.
1. Backward AST.
2. Mapping from names in requries to its gradient name.
3. Mapping from names in provides to its gradient name.
)</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/autograd.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">grad</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">ffi</span><span class="o">.</span><span class="n">Func</span><span class="p">,</span>
         <span class="n">requires</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
         <span class="n">provides</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Return</span><span class="p">]],</span>
         <span class="n">tapes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">,</span> <span class="n">GradTapeMode</span><span class="p">]</span> <span class="o">=</span> <span class="n">GradTapeMode</span><span class="o">.</span><span class="n">NoReuseOnly</span><span class="p">,</span>
         <span class="n">tape_in_closure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
         <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
         <span class="n">user_grads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ffi</span><span class="o">.</span><span class="n">StmtSetToUserGrad</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Reverse mode automatic differentiation</span>

<span class="sd">    It returns a forward function and a backward function. The forward has the same</span>
<span class="sd">    interface of the original function, but it will store some intermediate tensors</span>
<span class="sd">    (the tape) to be reused by the backward function in some global states. The</span>
<span class="sd">    backward function computes the gradients.</span>

<span class="sd">    `grad` is an out-of-place version. The resulting gradient are returned from the</span>
<span class="sd">    backward function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func : AST</span>
<span class="sd">        The original function</span>
<span class="sd">    requires : Sequence[str]</span>
<span class="sd">        Name of input variables that need gradients</span>
<span class="sd">    provides : Sequence[Union[str, Return]]</span>
<span class="sd">        Name of output variables whose gradients are known. A return value of a</span>
<span class="sd">        function can be specified with a `Return` object</span>
<span class="sd">    tapes : Union[Sequence, GradTapeMode]</span>
<span class="sd">        Intermediate variables that need to be stored from the forward pass and</span>
<span class="sd">        reused in the backward pass. This parameter can be a sequence, which contains</span>
<span class="sd">        VarDef selectors of them. It can also be a `GradTapeMode`, then it will determine</span>
<span class="sd">        which intermediate variables to be stored by heuristics. Avail `GradTapeMode`s</span>
<span class="sd">        are: All: store all variables including local scalars; None: store nothing;</span>
<span class="sd">        NoReuseOnly: store variables that only hold one version of data, which means</span>
<span class="sd">        we do not have to store each version of them in their history</span>
<span class="sd">    tape_in_closure : bool</span>
<span class="sd">        True to pass taped tensors from the forward function to the backward function in</span>
<span class="sd">        implicit I/O parameters, i.e. in closure. False to pass these tensors as</span>
<span class="sd">        explicit I/O parameters. Default to True</span>
<span class="sd">    invert: bool</span>
<span class="sd">        If set to true, it can reduce the amount of recomputation or taping required.</span>
<span class="sd">        However, this may result in a loss of precision for floating-point numbers. Defaults</span>
<span class="sd">    user_grads: List[ffi.StmtSetToUserGrad]</span>
<span class="sd">        For custom gradient. You do not have to explicitly set this parameter unless you</span>
<span class="sd">        are manipulating `func` by yourself (not getting it from the Python frontend). See</span>
<span class="sd">        `UserGrad` for details</span>
<span class="sd">    verbose: int</span>
<span class="sd">        Verbosity level</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (</span>
<span class="sd">         0. Forward AST.</span>
<span class="sd">         1. Backward AST.</span>
<span class="sd">         2. Mapping from names in requries to its gradient name.</span>
<span class="sd">         3. Mapping from names in provides to its gradient name.</span>
<span class="sd">        )</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">_grad_func</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span>
                      <span class="n">func</span><span class="p">,</span>
                      <span class="n">requires</span><span class="p">,</span>
                      <span class="n">provides</span><span class="p">,</span>
                      <span class="n">tapes</span><span class="p">,</span>
                      <span class="n">tape_in_closure</span><span class="p">,</span>
                      <span class="n">invert</span><span class="p">,</span>
                      <span class="n">user_grads</span><span class="p">,</span>
                      <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.autograd.grad_" class="doc doc-heading">
<code class="highlight language-python"><span class="n">grad_</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">requires</span><span class="p">,</span> <span class="n">provides</span><span class="p">,</span> <span class="n">tapes</span><span class="o">=</span><span class="n">GradTapeMode</span><span class="o">.</span><span class="n">NoReuseOnly</span><span class="p">,</span> <span class="n">tape_in_closure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user_grads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.core.autograd.grad_" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Reverse mode automatic differentiation</p>
<p>It returns a forward function and a backward function. The forward has the same
interface of the original function, but it will store some intermediate tensors
(the tape) to be reused by the backward function in some global states. The
backward function computes the gradients.</p>
<p><code>grad_</code> is an inplace version. The resulting gradient are mutable arguments of
the backward function.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>func</code></td>
          <td>
                <code>AST</code>
          </td>
          <td><p>The original function</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>requires</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[str]</code>
          </td>
          <td><p>Name of input variables that need gradients</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>provides</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[<span title="typing.Union">Union</span>[str, <a class="autorefs autorefs-internal" title="freetensor.core.autograd.Return" href="#freetensor.core.autograd.Return">Return</a>]]</code>
          </td>
          <td><p>Name of output variables whose gradients are known. A return value of a
function can be specified with a <code>Return</code> object</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>tapes</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<span title="typing.Sequence">Sequence</span>, <span title="freetensor_ffi.GradTapeMode">GradTapeMode</span>]</code>
          </td>
          <td><p>Intermediate variables that need to be stored from the forward pass and
reused in the backward pass. This parameter can be a sequence, which contains
VarDef selectors of them. It can also be a <code>GradTapeMode</code>, then it will determine
which intermediate variables to be stored by heuristics. Avail <code>GradTapeMode</code>s
are: All: store all variables including local scalars; None: store nothing;
NoReuseOnly: store variables that only hold one version of data, which means
we do not have to store each version of them in their history</p></td>
          <td>
                <code>GradTapeMode.NoReuseOnly</code>
          </td>
        </tr>
        <tr>
          <td><code>tape_in_closure</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>True to pass taped tensors from the forward function to the backward function in
implicit I/O parameters, i.e. in closure. False to pass these tensors as
explicit I/O parameters. Default to True</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>invert</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If set to true, it can reduce the amount of recomputation or taping required.
However, this may result in a loss of precision for floating-point numbers. Defaults
to true.</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>user_grads</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Sequence">Sequence</span>[<span title="freetensor_ffi">ffi</span>.<span title="freetensor_ffi.StmtSetToUserGrad">StmtSetToUserGrad</span>]]</code>
          </td>
          <td><p>For custom gradient. You do not have to explicitly set this parameter unless you
are manipulating <code>func</code> by yourself (not getting it from the Python frontend). See
<code>UserGrad</code> for details</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>verbose</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td><p>Verbosity level</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>tuple</code>
          </td>
          <td><p>(
0. Forward AST.
1. Backward AST.
2. Mapping from names in requries to its gradient name.
3. Mapping from names in provides to its gradient name.
)</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/autograd.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">grad_</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">ffi</span><span class="o">.</span><span class="n">Func</span><span class="p">,</span>
          <span class="n">requires</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
          <span class="n">provides</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Return</span><span class="p">]],</span>
          <span class="n">tapes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">,</span> <span class="n">GradTapeMode</span><span class="p">]</span> <span class="o">=</span> <span class="n">GradTapeMode</span><span class="o">.</span><span class="n">NoReuseOnly</span><span class="p">,</span>
          <span class="n">tape_in_closure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
          <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
          <span class="n">user_grads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ffi</span><span class="o">.</span><span class="n">StmtSetToUserGrad</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Reverse mode automatic differentiation</span>

<span class="sd">    It returns a forward function and a backward function. The forward has the same</span>
<span class="sd">    interface of the original function, but it will store some intermediate tensors</span>
<span class="sd">    (the tape) to be reused by the backward function in some global states. The</span>
<span class="sd">    backward function computes the gradients.</span>

<span class="sd">    `grad_` is an inplace version. The resulting gradient are mutable arguments of</span>
<span class="sd">    the backward function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func : AST</span>
<span class="sd">        The original function</span>
<span class="sd">    requires : Sequence[str]</span>
<span class="sd">        Name of input variables that need gradients</span>
<span class="sd">    provides : Sequence[Union[str, Return]]</span>
<span class="sd">        Name of output variables whose gradients are known. A return value of a</span>
<span class="sd">        function can be specified with a `Return` object</span>
<span class="sd">    tapes : Union[Sequence, GradTapeMode]</span>
<span class="sd">        Intermediate variables that need to be stored from the forward pass and</span>
<span class="sd">        reused in the backward pass. This parameter can be a sequence, which contains</span>
<span class="sd">        VarDef selectors of them. It can also be a `GradTapeMode`, then it will determine</span>
<span class="sd">        which intermediate variables to be stored by heuristics. Avail `GradTapeMode`s</span>
<span class="sd">        are: All: store all variables including local scalars; None: store nothing;</span>
<span class="sd">        NoReuseOnly: store variables that only hold one version of data, which means</span>
<span class="sd">        we do not have to store each version of them in their history</span>
<span class="sd">    tape_in_closure : bool</span>
<span class="sd">        True to pass taped tensors from the forward function to the backward function in</span>
<span class="sd">        implicit I/O parameters, i.e. in closure. False to pass these tensors as</span>
<span class="sd">        explicit I/O parameters. Default to True</span>
<span class="sd">    invert: bool</span>
<span class="sd">        If set to true, it can reduce the amount of recomputation or taping required.</span>
<span class="sd">        However, this may result in a loss of precision for floating-point numbers. Defaults</span>
<span class="sd">        to true.</span>
<span class="sd">    user_grads: List[ffi.StmtSetToUserGrad]</span>
<span class="sd">        For custom gradient. You do not have to explicitly set this parameter unless you</span>
<span class="sd">        are manipulating `func` by yourself (not getting it from the Python frontend). See</span>
<span class="sd">        `UserGrad` for details</span>
<span class="sd">    verbose: int</span>
<span class="sd">        Verbosity level</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (</span>
<span class="sd">         0. Forward AST.</span>
<span class="sd">         1. Backward AST.</span>
<span class="sd">         2. Mapping from names in requries to its gradient name.</span>
<span class="sd">         3. Mapping from names in provides to its gradient name.</span>
<span class="sd">        )</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">_grad_func</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">grad_</span><span class="p">,</span>
                      <span class="n">func</span><span class="p">,</span>
                      <span class="n">requires</span><span class="p">,</span>
                      <span class="n">provides</span><span class="p">,</span>
                      <span class="n">tapes</span><span class="p">,</span>
                      <span class="n">tape_in_closure</span><span class="p">,</span>
                      <span class="n">invert</span><span class="p">,</span>
                      <span class="n">user_grads</span><span class="p">,</span>
                      <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.autograd.grad_body" class="doc doc-heading">
<code class="highlight language-python"><span class="n">grad_body</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">requires</span><span class="p">,</span> <span class="n">provides</span><span class="p">,</span> <span class="n">tapes</span><span class="o">=</span><span class="n">GradTapeMode</span><span class="o">.</span><span class="n">NoReuseOnly</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user_grads</span><span class="o">=</span><span class="p">[])</span></code>

<a href="#freetensor.core.autograd.grad_body" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p><code>grad</code> or <code>grad_</code> on a function body (for internal tests only)</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/autograd.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">grad_body</span><span class="p">(</span><span class="n">stmt</span><span class="p">:</span> <span class="n">ffi</span><span class="o">.</span><span class="n">Stmt</span><span class="p">,</span>
              <span class="n">requires</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Return</span><span class="p">]],</span>
              <span class="n">provides</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Return</span><span class="p">]],</span>
              <span class="n">tapes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">,</span> <span class="n">GradTapeMode</span><span class="p">]</span> <span class="o">=</span> <span class="n">GradTapeMode</span><span class="o">.</span><span class="n">NoReuseOnly</span><span class="p">,</span>
              <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
              <span class="n">user_grads</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ffi</span><span class="o">.</span><span class="n">StmtSetToUserGrad</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; `grad` or `grad_` on a function body (for internal tests only) &#39;&#39;&#39;</span>

    <span class="n">req</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">requires</span><span class="p">)</span>
    <span class="n">prov</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">provides</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tapes</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">GradTapeMode</span><span class="p">:</span>
        <span class="n">tapes</span> <span class="o">=</span> <span class="p">{</span><span class="n">find_stmt</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tapes</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">grad_body</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">prov</span><span class="p">,</span> <span class="n">tapes</span><span class="p">,</span> <span class="n">invert</span><span class="p">,</span> <span class="n">user_grads</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="freetensor.core.codegen" class="doc doc-heading">
          <code>codegen</code>


<a href="#freetensor.core.codegen" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="freetensor.core.codegen.codegen" class="doc doc-heading">
<code class="highlight language-python"><span class="n">codegen</span><span class="p">(</span><span class="n">ast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.core.codegen.codegen" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Generate native code</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>ast</code></td>
          <td>
                <code>AST</code>
          </td>
          <td><p>The AST to be lowered. It must includes function signature to determine
parameters and return values. If not specified, a partial function is
returned, which can be used as a decorator</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>target</code></td>
          <td>
                <code><span title="freetensor.core.driver.Target">Target</span>(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>The target architecture. If omitted, use the default one in config</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/codegen.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">codegen</span><span class="p">(</span><span class="n">ast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">target</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ffi</span><span class="o">.</span><span class="n">Target</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NativeCode</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate native code</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ast : AST</span>
<span class="sd">        The AST to be lowered. It must includes function signature to determine</span>
<span class="sd">        parameters and return values. If not specified, a partial function is</span>
<span class="sd">        returned, which can be used as a decorator</span>
<span class="sd">    target : Target (Optional)</span>
<span class="sd">        The target architecture. If omitted, use the default one in config</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">ast</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">default_target</span><span class="p">()</span>
        <span class="n">raw_code</span> <span class="o">=</span> <span class="n">ffi</span><span class="o">.</span><span class="n">code_gen</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">debug</span><span class="o">.</span><span class="n">with_line_no</span><span class="p">(</span><span class="n">raw_code</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">NativeCode</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">raw_code</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">codegen</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="freetensor.core.config" class="doc doc-heading">
          <code>config</code>


<a href="#freetensor.core.config" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">
  
      <p>Global configurations</p>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="freetensor.core.context" class="doc doc-heading">
          <code>context</code>


<a href="#freetensor.core.context" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">
  
      <p>Facility to pick statements to build an AST</p>
<p>Classes and functions in this module are internally used by <code>transformer</code> to construct ASTs.
They are also used by some internal tests. API of these classes and functions are subject to changes.
End users are encouraged to use <code>transformer</code>, instead of this module.</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="freetensor.core.context.ContextStack" class="doc doc-heading">
        <code>ContextStack</code>


<a href="#freetensor.core.context.ContextStack" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">



        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ContextStack</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">Context</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_grads</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># [fn(ffi.Stmt)], invoked for every `append_stmt`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_stmt_callbacks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">top</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Context</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">push</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">caller_metadata</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Context</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>

    <span class="k">def</span> <span class="nf">set_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Context</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span>

    <span class="k">def</span> <span class="nf">get_last_stmt_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Can be used inside the staged code, to get the ID of the immediately preceding statement</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">stmt_seq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">stmt_seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
        <span class="k">raise</span> <span class="n">ft</span><span class="o">.</span><span class="n">InvalidProgram</span><span class="p">(</span><span class="s2">&quot;There is no statement yet&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">push_append_stmt_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ffi</span><span class="o">.</span><span class="n">Stmt</span><span class="p">],</span> <span class="kc">None</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add a callback to be called with all next statements to be appended. For `If` statement, it</span>
<span class="sd">        can be called twice, one without &quot;else&quot; branch, and then maybe one more with &quot;else&quot; branch</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_stmt_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop_append_stmt_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_stmt_callbacks</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h5 id="freetensor.core.context.ContextStack.get_last_stmt_id" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_last_stmt_id</span><span class="p">()</span></code>

<a href="#freetensor.core.context.ContextStack.get_last_stmt_id" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Can be used inside the staged code, to get the ID of the immediately preceding statement</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/context.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_last_stmt_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Can be used inside the staged code, to get the ID of the immediately preceding statement</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">ctx</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">stmt_seq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">stmt_seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
    <span class="k">raise</span> <span class="n">ft</span><span class="o">.</span><span class="n">InvalidProgram</span><span class="p">(</span><span class="s2">&quot;There is no statement yet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.context.ContextStack.push_append_stmt_callback" class="doc doc-heading">
<code class="highlight language-python"><span class="n">push_append_stmt_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span></code>

<a href="#freetensor.core.context.ContextStack.push_append_stmt_callback" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Add a callback to be called with all next statements to be appended. For <code>If</code> statement, it
can be called twice, one without "else" branch, and then maybe one more with "else" branch</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/context.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">push_append_stmt_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ffi</span><span class="o">.</span><span class="n">Stmt</span><span class="p">],</span> <span class="kc">None</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Add a callback to be called with all next statements to be appended. For `If` statement, it</span>
<span class="sd">    can be called twice, one without &quot;else&quot; branch, and then maybe one more with &quot;else&quot; branch</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">append_stmt_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.context.StmtRange" class="doc doc-heading">
        <code>StmtRange</code>


<a href="#freetensor.core.context.StmtRange" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">

  
      <p>Record a set of statement in a program, can be used for custom gradient</p>
<p>Usage:</p>
<pre><code>with StmtRange() as rng:
    # Some statements
</code></pre>
<p><code>StmtRange</code> can be used interleaved with AST scopes. In these cases, you can directly call
<code>__enter__</code> and <code>__exit__</code>. E.g.,</p>
<pre><code>rng = StmtRange()
rng.__enter__()
# Some statements
with VarDef(...)  # Some scopes
    # Some other statements
    rng.__exit__(None, None, None)

</code></pre>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">StmtRange</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Record a set of statement in a program, can be used for custom gradient</span>

<span class="sd">    Usage:</span>

<span class="sd">    ```</span>
<span class="sd">    with StmtRange() as rng:</span>
<span class="sd">        # Some statements</span>
<span class="sd">    ```</span>

<span class="sd">    `StmtRange` can be used interleaved with AST scopes. In these cases, you can directly call</span>
<span class="sd">    `__enter__` and `__exit__`. E.g.,</span>

<span class="sd">    ```</span>
<span class="sd">    rng = StmtRange()</span>
<span class="sd">    rng.__enter__()</span>
<span class="sd">    # Some statements</span>
<span class="sd">    with VarDef(...)  # Some scopes</span>
<span class="sd">        # Some other statements</span>
<span class="sd">        rng.__exit__(None, None, None)</span>

<span class="sd">    ```</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exited</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">push_append_stmt_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entered</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">pop_append_stmt_callback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exited</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">entered</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ffi</span><span class="o">.</span><span class="n">InvalidProgram</span><span class="p">(</span><span class="s2">&quot;StmtRange is not properly entered&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exited</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ffi</span><span class="o">.</span><span class="n">InvalidProgram</span><span class="p">(</span><span class="s2">&quot;StmtRange is not properly exited&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h4 id="freetensor.core.context.pop_ast" class="doc doc-heading">
<code class="highlight language-python"><span class="n">pop_ast</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#freetensor.core.context.pop_ast" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Get AST and reset context</p>
<p>Internally used by <code>transformer</code> and tests</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/context.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">pop_ast</span><span class="p">(</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get AST and reset context</span>

<span class="sd">    Internally used by `transformer` and tests</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">make_stmt</span><span class="p">()</span>
    <span class="n">ctx_stack</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The popped AST is:&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.context.pop_ast_and_user_grads" class="doc doc-heading">
<code class="highlight language-python"><span class="n">pop_ast_and_user_grads</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#freetensor.core.context.pop_ast_and_user_grads" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Get AST and reset context. Return an extra list for custom gradients</p>
<p>Set <code>UserGrad</code> for details</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/context.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">pop_ast_and_user_grads</span><span class="p">(</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get AST and reset context. Return an extra list for custom gradients</span>

<span class="sd">    Set `UserGrad` for details</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">make_stmt</span><span class="p">()</span>
    <span class="n">user_grads</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">user_grads</span>
    <span class="n">ctx_stack</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The popped AST is:&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ast</span><span class="p">,</span> <span class="n">user_grads</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="freetensor.core.driver" class="doc doc-heading">
          <code>driver</code>


<a href="#freetensor.core.driver" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="freetensor.core.driver.Device" class="doc doc-heading">
        <code>Device</code>


<a href="#freetensor.core.driver.Device" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="freetensor_ffi">ffi</span>.<span title="freetensor_ffi.Device">Device</span></code></p>

  
      <p>A computing device can be constructed from
     1. (TargetType, DeviceNumber)
     2. (TargetType, getDeviceByName): cuda uses best matches criteria.
     3. (TargetType, FullName, nth): get nth(from 0) device named <code>Fullname</code>.</p>
<p>E.g. Device(TargetType::GPU, 0) means the 0-th GPU (device)
     Device(TargetType::GPU, "V100") means a GPU which best matches "V100"
     Device(TargetType::GPU, "NVIDIA GeForce RTX 3060 Laptop GPU", 0)</p>
<p>A Device can be used as a "with" scope, then all the <code>Array</code>s and <code>Driver</code>s
will use it by default. In this style, it also sets the default Target. E.g:</p>
<pre><code>with Device(...):
    ast = lower(ast)  # Use the Target of the Device above by default
    a = Array(...)  # Use the Device above by default
</code></pre>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/driver.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Device</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    A computing device can be constructed from</span>
<span class="sd">         1. (TargetType, DeviceNumber)</span>
<span class="sd">         2. (TargetType, getDeviceByName): cuda uses best matches criteria.</span>
<span class="sd">         3. (TargetType, FullName, nth): get nth(from 0) device named `Fullname`.</span>

<span class="sd">    E.g. Device(TargetType::GPU, 0) means the 0-th GPU (device)</span>
<span class="sd">         Device(TargetType::GPU, &quot;V100&quot;) means a GPU which best matches &quot;V100&quot;</span>
<span class="sd">         Device(TargetType::GPU, &quot;NVIDIA GeForce RTX 3060 Laptop GPU&quot;, 0)</span>

<span class="sd">    A Device can be used as a &quot;with&quot; scope, then all the `Array`s and `Driver`s</span>
<span class="sd">    will use it by default. In this style, it also sets the default Target. E.g:</span>

<span class="sd">    ```</span>
<span class="sd">    with Device(...):</span>
<span class="sd">        ast = lower(ast)  # Use the Target of the Device above by default</span>
<span class="sd">        a = Array(...)  # Use the Device above by default</span>
<span class="sd">    ```</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_old_target_device_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">default_target</span><span class="p">(),</span> <span class="n">config</span><span class="o">.</span><span class="n">default_device</span><span class="p">()))</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set_default_target</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">())</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set_default_device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">old_target</span><span class="p">,</span> <span class="n">old_device</span> <span class="o">=</span> <span class="n">_old_target_device_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set_default_target</span><span class="p">(</span><span class="n">old_target</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set_default_device</span><span class="p">(</span><span class="n">old_device</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.driver.Driver" class="doc doc-heading">
        <code>Driver</code>


<a href="#freetensor.core.driver.Driver" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="freetensor_ffi">ffi</span>.<span title="freetensor_ffi.Driver">Driver</span></code></p>



        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/driver.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Driver</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">Driver</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">func</span><span class="p">:</span> <span class="n">ffi</span><span class="o">.</span><span class="n">Func</span><span class="p">,</span>
                 <span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">host_device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compile a program using a backend compiler and load it into memory</span>

<span class="sd">        This class is for internal use. Please consider using `build_binary`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func : ffi.Func</span>
<span class="sd">            AST of the function, where the function signature is needed to</span>
<span class="sd">            determine the parameters and return values</span>
<span class="sd">        src : str</span>
<span class="sd">            Native code generated from codegen</span>
<span class="sd">        device : Device (Optional)</span>
<span class="sd">            The device to run the program. If omitted, use the default device</span>
<span class="sd">            in config</span>
<span class="sd">        verbose : bool (Optional)</span>
<span class="sd">            True to print extra infomation</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">default_device</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">host_device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">host_device</span><span class="p">,</span>
                                         <span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>

        <span class="c1"># When we pass numpy or pytorch tensors to `set_args`, they are</span>
        <span class="c1"># converted to `Array` objects by reference. In `Array`&#39;s FFI, we</span>
        <span class="c1"># keep these tensors alive whenever the `Array`&#39;s PYTHON objects</span>
        <span class="c1"># alive. We need to also keep the `Array`&#39;s PYTHON objects here.</span>
        <span class="c1"># Please note that we cannot hold the reference count in `Driver`&#39;s</span>
        <span class="c1"># C++ implementation, where we can only hold the `Array`&#39;s C++</span>
        <span class="c1"># objects alive.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args_ref_cnt_holder</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">native_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Get native code compiled by backend compiler &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span>

    <span class="k">def</span> <span class="nf">set_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Set argument for an invocation &#39;&#39;&#39;</span>

        <span class="c1"># No need to hold reference of the last run any more</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args_ref_cnt_holder</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kws</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
            <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">dont_drop_borrow</span><span class="o">=</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Array</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kws</span><span class="p">:</span>
            <span class="n">kws</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">kws</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                             <span class="n">dont_drop_borrow</span><span class="o">=</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kws</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Array</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args_ref_cnt_holder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kws</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args_ref_cnt_holder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kws</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kws</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">collect_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">always_return_pack</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Collect return values from an invocation</span>

<span class="sd">        Return values must be collect. Otherwise there will be memory leaks</span>

<span class="sd">        If there is only one return value, it is returned directly. Otherwise,</span>
<span class="sd">        or if `always_return_pack` is set, the return values are packed in a</span>
<span class="sd">        ReturnValuesPack</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect_returns</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">always_return_pack</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">always_return_pack</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ReturnValuesPack</span><span class="p">(</span>
                <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">is_in_closure</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">return_closure</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">returns</span><span class="p">)),</span> <span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set argument, execute the binary code, and collect the returns</span>

<span class="sd">        If there is only one return value, it is returned directly. Otherwise,</span>
<span class="sd">        the return values are packed in a ReturnValuesPack</span>

<span class="sd">        This function will introduce some overhaed handling arguments and return</span>
<span class="sd">        values. For an accurate execution time measurement, plase call</span>
<span class="sd">        `self.set_args` first, then `self.time`, and finally `self.collect_returns`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_returns</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h5 id="freetensor.core.driver.Driver.__call__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span></code>

<a href="#freetensor.core.driver.Driver.__call__" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Set argument, execute the binary code, and collect the returns</p>
<p>If there is only one return value, it is returned directly. Otherwise,
the return values are packed in a ReturnValuesPack</p>
<p>This function will introduce some overhaed handling arguments and return
values. For an accurate execution time measurement, plase call
<code>self.set_args</code> first, then <code>self.time</code>, and finally <code>self.collect_returns</code></p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/driver.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Set argument, execute the binary code, and collect the returns</span>

<span class="sd">    If there is only one return value, it is returned directly. Otherwise,</span>
<span class="sd">    the return values are packed in a ReturnValuesPack</span>

<span class="sd">    This function will introduce some overhaed handling arguments and return</span>
<span class="sd">    values. For an accurate execution time measurement, plase call</span>
<span class="sd">    `self.set_args` first, then `self.time`, and finally `self.collect_returns`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_returns</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.driver.Driver.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">host_device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.core.driver.Driver.__init__" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Compile a program using a backend compiler and load it into memory</p>
<p>This class is for internal use. Please consider using <code>build_binary</code></p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>func</code></td>
          <td>
                <code><span title="freetensor_ffi">ffi</span>.<span title="freetensor_ffi.Func">Func</span></code>
          </td>
          <td><p>AST of the function, where the function signature is needed to
determine the parameters and return values</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>src</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Native code generated from codegen</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>device</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.driver.Device" href="#freetensor.core.driver.Device">Device</a>(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>The device to run the program. If omitted, use the default device
in config</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>verbose</code></td>
          <td>
                <code>bool(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>True to print extra infomation</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/driver.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">func</span><span class="p">:</span> <span class="n">ffi</span><span class="o">.</span><span class="n">Func</span><span class="p">,</span>
             <span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
             <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">host_device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compile a program using a backend compiler and load it into memory</span>

<span class="sd">    This class is for internal use. Please consider using `build_binary`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func : ffi.Func</span>
<span class="sd">        AST of the function, where the function signature is needed to</span>
<span class="sd">        determine the parameters and return values</span>
<span class="sd">    src : str</span>
<span class="sd">        Native code generated from codegen</span>
<span class="sd">    device : Device (Optional)</span>
<span class="sd">        The device to run the program. If omitted, use the default device</span>
<span class="sd">        in config</span>
<span class="sd">    verbose : bool (Optional)</span>
<span class="sd">        True to print extra infomation</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">default_device</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">host_device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">host_device</span><span class="p">,</span>
                                     <span class="n">verbose</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>

    <span class="c1"># When we pass numpy or pytorch tensors to `set_args`, they are</span>
    <span class="c1"># converted to `Array` objects by reference. In `Array`&#39;s FFI, we</span>
    <span class="c1"># keep these tensors alive whenever the `Array`&#39;s PYTHON objects</span>
    <span class="c1"># alive. We need to also keep the `Array`&#39;s PYTHON objects here.</span>
    <span class="c1"># Please note that we cannot hold the reference count in `Driver`&#39;s</span>
    <span class="c1"># C++ implementation, where we can only hold the `Array`&#39;s C++</span>
    <span class="c1"># objects alive.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">args_ref_cnt_holder</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.driver.Driver.collect_returns" class="doc doc-heading">
<code class="highlight language-python"><span class="n">collect_returns</span><span class="p">(</span><span class="n">always_return_pack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#freetensor.core.driver.Driver.collect_returns" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Collect return values from an invocation</p>
<p>Return values must be collect. Otherwise there will be memory leaks</p>
<p>If there is only one return value, it is returned directly. Otherwise,
or if <code>always_return_pack</code> is set, the return values are packed in a
ReturnValuesPack</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/driver.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">collect_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">always_return_pack</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Collect return values from an invocation</span>

<span class="sd">    Return values must be collect. Otherwise there will be memory leaks</span>

<span class="sd">    If there is only one return value, it is returned directly. Otherwise,</span>
<span class="sd">    or if `always_return_pack` is set, the return values are packed in a</span>
<span class="sd">    ReturnValuesPack</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">collect_returns</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">always_return_pack</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">always_return_pack</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ReturnValuesPack</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">is_in_closure</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">return_closure</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">returns</span><span class="p">)),</span> <span class="n">values</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.driver.Driver.native_code" class="doc doc-heading">
<code class="highlight language-python"><span class="n">native_code</span><span class="p">()</span></code>

<a href="#freetensor.core.driver.Driver.native_code" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Get native code compiled by backend compiler</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/driver.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">native_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Get native code compiled by backend compiler &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.driver.Driver.set_args" class="doc doc-heading">
<code class="highlight language-python"><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span></code>

<a href="#freetensor.core.driver.Driver.set_args" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Set argument for an invocation</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/driver.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Set argument for an invocation &#39;&#39;&#39;</span>

    <span class="c1"># No need to hold reference of the last run any more</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">args_ref_cnt_holder</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kws</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
        <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">dont_drop_borrow</span><span class="o">=</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Array</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kws</span><span class="p">:</span>
        <span class="n">kws</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">kws</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                         <span class="n">dont_drop_borrow</span><span class="o">=</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kws</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">Array</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args_ref_cnt_holder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kws</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args_ref_cnt_holder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kws</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kws</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.driver.ReturnValuesPack" class="doc doc-heading">
        <code>ReturnValuesPack</code>


<a href="#freetensor.core.driver.ReturnValuesPack" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">

  
      <p>Hold return values from a Driver invocation</p>
<p>Return values can be retrieved in an anonymous manner: <code>x, y, z = pack</code>,
or in a named manner: <code>pack['x']</code></p>
<p>Please note that a ReturnValuesPack is different from a OrderedDict, as
OrderedDict unpacks to keys rather than values</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/driver.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ReturnValuesPack</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Hold return values from a Driver invocation</span>

<span class="sd">    Return values can be retrieved in an anonymous manner: `x, y, z = pack`,</span>
<span class="sd">    or in a named manner: `pack[&#39;x&#39;]`</span>

<span class="sd">    Please note that a ReturnValuesPack is different from a OrderedDict, as</span>
<span class="sd">    OrderedDict unpacks to keys rather than values</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Array</span><span class="p">]):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Get all return values in the order declared in Func &#39;&#39;&#39;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Get a return value with a name. Tuple is supported for multiple values &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span>
        <span class="k">raise</span> <span class="n">ffi</span><span class="o">.</span><span class="n">DriverError</span><span class="p">(</span><span class="s2">&quot;No such return value named &quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Test if a return value exists &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h5 id="freetensor.core.driver.ReturnValuesPack.__contains__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__contains__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#freetensor.core.driver.ReturnValuesPack.__contains__" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Test if a return value exists</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/driver.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Test if a return value exists &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.driver.ReturnValuesPack.__getitem__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#freetensor.core.driver.ReturnValuesPack.__getitem__" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Get a return value with a name. Tuple is supported for multiple values</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/driver.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Get a return value with a name. Tuple is supported for multiple values &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ret</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
    <span class="k">raise</span> <span class="n">ffi</span><span class="o">.</span><span class="n">DriverError</span><span class="p">(</span><span class="s2">&quot;No such return value named &quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.driver.ReturnValuesPack.__iter__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__iter__</span><span class="p">()</span></code>

<a href="#freetensor.core.driver.ReturnValuesPack.__iter__" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Get all return values in the order declared in Func</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/driver.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Get all return values in the order declared in Func &#39;&#39;&#39;</span>
    <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h4 id="freetensor.core.driver.array" class="doc doc-heading">
<code class="highlight language-python"><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dont_drop_borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">moved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#freetensor.core.driver.array" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Factory function for Array</p>
<p>This function is preferred over directly calling <code>Array</code>'s constructor, because
it accepts more data format.</p>
<ul>
<li>If <code>data</code> is another FreeTensor <code>Array</code>, the original object will be returned,
with <code>dont_drop_borrow</code> and <code>moved</code> set to new values. If <code>dtype</code> is set and
different from the original data type, the <code>Array</code> will be copied first to convert
the data type.</li>
<li>If <code>data</code> is Numpy <code>Array</code> or PyTorch <code>Tensor</code>, it will be converted to FreeTensor
<code>Array</code>. Memory copy will be avoided in most cases, but it is inevitable if the
data is strided. If <code>dtype</code> is set and different from the original data type, the
<code>Array</code> or <code>Tensor</code> will be copied first to convert the data type.</li>
<li>Otherwise, the data will be treated as an n-dimensional array-like object, and
will be parsed according the rules in NumPy. The data type is also set accordingly,
unless <code>dtype</code> is set.</li>
</ul>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>data</code></td>
          <td>
                <code>FreeTensor Array, Numpy Array, PyTorch Tensor, or other array-like objects</code>
          </td>
          <td><p>Data to be copied to or borrowed by the new Array object</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code>ft.DataType or str</code>
          </td>
          <td><p>If <code>data</code> is not in <code>dtype</code>, convert it to <code>dtype</code> first before constructing
the <code>Array</code></p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>dont_drop_borrow</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If true, report an error if we have to drop a borrwed data. This flag is set
to true when the Array is cunstructed IMPLICITLY (not by this function) from
a user object by borrowing from it, where users may expect they are acutually
manipulating the their user object, instead of this Array</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>moved</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If true, it means we do not care about data in this Array any more after the
program runs. Variables with "input-mutable" access type may modify the Array</p></td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/driver.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
          <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">dont_drop_borrow</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
          <span class="n">moved</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Factory function for Array</span>

<span class="sd">    This function is preferred over directly calling `Array`&#39;s constructor, because</span>
<span class="sd">    it accepts more data format.</span>

<span class="sd">    - If `data` is another FreeTensor `Array`, the original object will be returned,</span>
<span class="sd">    with `dont_drop_borrow` and `moved` set to new values. If `dtype` is set and</span>
<span class="sd">    different from the original data type, the `Array` will be copied first to convert</span>
<span class="sd">    the data type.</span>
<span class="sd">    - If `data` is Numpy `Array` or PyTorch `Tensor`, it will be converted to FreeTensor</span>
<span class="sd">    `Array`. Memory copy will be avoided in most cases, but it is inevitable if the</span>
<span class="sd">    data is strided. If `dtype` is set and different from the original data type, the</span>
<span class="sd">    `Array` or `Tensor` will be copied first to convert the data type.</span>
<span class="sd">    - Otherwise, the data will be treated as an n-dimensional array-like object, and</span>
<span class="sd">    will be parsed according the rules in NumPy. The data type is also set accordingly,</span>
<span class="sd">    unless `dtype` is set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : FreeTensor Array, Numpy Array, PyTorch Tensor, or other array-like objects</span>
<span class="sd">        Data to be copied to or borrowed by the new Array object</span>
<span class="sd">    dtype : ft.DataType or str</span>
<span class="sd">        If `data` is not in `dtype`, convert it to `dtype` first before constructing</span>
<span class="sd">        the `Array`</span>
<span class="sd">    dont_drop_borrow : bool</span>
<span class="sd">        If true, report an error if we have to drop a borrwed data. This flag is set</span>
<span class="sd">        to true when the Array is cunstructed IMPLICITLY (not by this function) from</span>
<span class="sd">        a user object by borrowing from it, where users may expect they are acutually</span>
<span class="sd">        manipulating the their user object, instead of this Array</span>
<span class="sd">    moved : bool</span>
<span class="sd">        If true, it means we do not care about data in this Array any more after the</span>
<span class="sd">        program runs. Variables with &quot;input-mutable&quot; access type may modify the Array</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">DataType</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Array</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="c1"># Must be contiguous</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">to_numpy_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">set_dont_drop_borrow</span><span class="p">(</span><span class="n">dont_drop_borrow</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">set_moved</span><span class="p">(</span><span class="n">moved</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="c1"># For NumPy, Although Pybind11&#39;s `array_t` type provides a flag `forcecast` to</span>
    <span class="c1"># cast from a strided array to a contiguous one. But it always casts to a specific</span>
    <span class="c1"># type, e.g. float64. I have no idea how to support multiple types. Therfore,</span>
    <span class="c1"># we have to call NumPy&#39;s `.copy(order=&#39;C&#39;)` to make a new NumPy array. This</span>
    <span class="c1"># function can only be called from Python side (not from PyBind11&#39;s `py::array`</span>
    <span class="c1"># type).</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">to_numpy_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">to_numpy_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;C_CONTIGUOUS&#39;</span><span class="p">]:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dont_drop_borrow</span><span class="p">,</span> <span class="n">moved</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;torch&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">torch</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">with_pytorch</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ffi</span><span class="o">.</span><span class="n">InvalidIO</span><span class="p">(</span>
                    <span class="s2">&quot;FreeTensor should be built with WITH_PYTORCH to accept a PyTorch tensor&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">to_torch_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">to_torch_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span>
                               <span class="n">memory_format</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">contiguous_format</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">is_contiguous</span><span class="p">():</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dont_drop_borrow</span><span class="p">,</span> <span class="n">moved</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">to_numpy_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)),</span>
                 <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                 <span class="n">dont_drop_borrow</span><span class="o">=</span><span class="n">dont_drop_borrow</span><span class="p">,</span>
                 <span class="n">moved</span><span class="o">=</span><span class="n">moved</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.driver.build_binary" class="doc doc-heading">
<code class="highlight language-python"><span class="n">build_binary</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">host_device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.core.driver.build_binary" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Compile a program using a backend compiler and load it into memory</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>code</code></td>
          <td>
                <code><span title="freetensor.core.codegen.NativeCode">NativeCode</span></code>
          </td>
          <td><p>Native code generated by <code>codegen</code>. If not specified, a partial
function is returned, which can be used as a decorator</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>device</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.driver.Device" href="#freetensor.core.driver.Device">Device</a>(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>The device to run the program. If omitted, use the default device
in config</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/driver.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">build_binary</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NativeCode</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">host_device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compile a program using a backend compiler and load it into memory</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    code : NativeCode</span>
<span class="sd">        Native code generated by `codegen`. If not specified, a partial</span>
<span class="sd">        function is returned, which can be used as a decorator</span>
<span class="sd">    device : Device (Optional)</span>
<span class="sd">        The device to run the program. If omitted, use the default device</span>
<span class="sd">        in config</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">default_device</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">target</span><span class="p">()</span> <span class="o">!=</span> <span class="n">code</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ffi</span><span class="o">.</span><span class="n">DriverError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Codegen target (</span><span class="si">{</span><span class="n">code</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">) is inconsistent with device target (</span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">target</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">Driver</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">host_device</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">build_binary</span>
        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">host_device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">host_device</span><span class="o">=</span><span class="n">host_device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.driver.move" class="doc doc-heading">
<code class="highlight language-python"><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

<a href="#freetensor.core.driver.move" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Alias for array(data, dont_drop_borrow=False, moved=True)</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/driver.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Alias for array(data, dont_drop_borrow=False, moved=True) &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dont_drop_borrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">moved</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="freetensor.core.expr" class="doc doc-heading">
          <code>expr</code>


<a href="#freetensor.core.expr" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">
  
      <p>Facility to build AST expressions</p>
<p>Classes and functions in this module are not only used internally for constructing AST nodes,
and also exposed to users via multi-stage programming</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="freetensor.core.expr.AlreadyMadeReduceTo" class="doc doc-heading">
        <code>AlreadyMadeReduceTo</code>


<a href="#freetensor.core.expr.AlreadyMadeReduceTo" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">

  
      <p>A single-value type that marks a ReduceTo node is already made, and there is no need to
make another Store node</p>
<p>In standard Python data model, functions like <strong>iadd</strong> returns the modified self, and
<strong>setitem</strong> does a self-assignment. We do the augmenting assignment directly in <strong>iadd</strong>
and return AlreadyMadeReduceTo, so we do not have to Store it again</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">AlreadyMadeReduceTo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A single-value type that marks a ReduceTo node is already made, and there is no need to</span>
<span class="sd">    make another Store node</span>

<span class="sd">    In standard Python data model, functions like __iadd__ returns the modified self, and</span>
<span class="sd">    __setitem__ does a self-assignment. We do the augmenting assignment directly in __iadd__</span>
<span class="sd">    and return AlreadyMadeReduceTo, so we do not have to Store it again</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
        </details>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.expr.VarRef" class="doc doc-heading">
        <code>VarRef</code>


<a href="#freetensor.core.expr.VarRef" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="freetensor_ffi">ffi</span>.<span title="freetensor_ffi.FrontendVar">FrontendVar</span></code></p>

  
      <p>Variable of FreeTensor</p>
<p>All variables in FreeTensor DSL (declared via <code>Var</code>, created by <code>empty</code> or <code>var</code>,
returned by <code>libop</code>, etc.), and their slices, are <code>VarRef</code> objects. Operations
on <code>VarRef</code> objects generates AST nodes</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">VarRef</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">FrontendVar</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Variable of FreeTensor</span>

<span class="sd">    All variables in FreeTensor DSL (declared via `Var`, created by `empty` or `var`,</span>
<span class="sd">    returned by `libop`, etc.), and their slices, are `VarRef` objects. Operations</span>
<span class="sd">    on `VarRef` objects generates AST nodes</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">full_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">,</span>
                 <span class="n">dtype</span><span class="p">:</span> <span class="n">ffi</span><span class="o">.</span><span class="n">DataType</span><span class="p">,</span>
                 <span class="n">mtype</span><span class="p">:</span> <span class="n">ffi</span><span class="o">.</span><span class="n">MemType</span><span class="p">,</span>
                 <span class="n">indices</span><span class="p">:</span> <span class="n">Sequence</span> <span class="o">=</span> <span class="p">[],</span>
                 <span class="n">is_load_at_version</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VarRef</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">full_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span>
                                     <span class="n">is_load_at_version</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">.stmt</span> <span class="kn">import</span> <span class="n">find_borrowed_vardefs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">borrowed_vardefs</span> <span class="o">=</span> <span class="n">find_borrowed_vardefs</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">borrowed_vardefs</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">lend_out</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">borrowed_vardefs</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">reclaim</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">mtype</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">chain_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_key</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtype</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">chain_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_key</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">AlreadyMadeReduceTo</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="n">libop</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">AlreadyMadeReduceTo</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
        <span class="n">top</span><span class="o">.</span><span class="n">append_stmt</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">as_store</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span> <span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">as_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ffi</span><span class="o">.</span><span class="n">AnyExpr</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">ffi</span><span class="o">.</span><span class="n">up_cast</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">base</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>
            <span class="c1"># Add explicit cast node, to avoid confusion after propagation</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VarRef</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">as_store</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_reduce_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reduce_op</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">atomic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ffi</span><span class="o">.</span><span class="n">AnyExpr</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">ffi</span><span class="o">.</span><span class="n">up_cast</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">base</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base</span><span class="p">):</span>
            <span class="c1"># Add explicit cast node, to avoid confusion after propagation</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VarRef</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">as_reduce_to</span><span class="p">(</span><span class="n">reduce_op</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
                                                <span class="n">atomic</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">dim</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dim</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">dim</span> <span class="k">else</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return lengths of all dimensions or the length of one dimension</span>

<span class="sd">        `.shape()` -&gt; list of lengths of all dimensions</span>

<span class="sd">        `.shape(dim)` -&gt; length of dimension `dim`, where `dim` can be `int`</span>
<span class="sd">        or `Expr`</span>

<span class="sd">        All lengths can be `Expr` (if the length is dynamically decided) or</span>
<span class="sd">        `int` (if statically decided)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">intOrExpr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">val</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ffi</span><span class="o">.</span><span class="n">IntConst</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">intOrExpr</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">VarRef</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">intOrExpr</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">VarRef</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dim</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_parse_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">is</span> <span class="o">...</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">key</span><span class="p">,)</span>
        <span class="n">ffiIdx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">length</span>
                <span class="k">assert</span> <span class="n">idx</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">idx</span><span class="o">.</span><span class="n">step</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">ffiIdx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">FrontendVarIdx</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">full_shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">indices</span><span class="p">):</span>
                    <span class="n">ffiIdx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">FrontendVarIdx</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">as_load</span><span class="p">()))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span>
                        <span class="n">key</span>
                    <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Shape of an index of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> should be 1-D, instead of </span><span class="si">{</span><span class="n">idx</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span>
                        <span class="n">idx</span><span class="o">.</span><span class="n">full_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span> <span class="ow">is</span> <span class="n">ffi</span><span class="o">.</span><span class="n">IntConst</span><span class="p">,</span> <span class="s2">&quot;Dynamic number of dimensions is not supported&quot;</span>
                    <span class="n">ndim</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">full_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
                    <span class="n">ffiIdx</span> <span class="o">+=</span> <span class="p">[</span>
                        <span class="n">ffi</span><span class="o">.</span><span class="n">FrontendVarIdx</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">as_load</span><span class="p">())</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>
                    <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ffiIdx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">FrontendVarIdx</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ffiIdx</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span> <span class="o">+</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">other</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="n">libop</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">AlreadyMadeReduceTo</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
        <span class="n">top</span><span class="o">.</span><span class="n">append_stmt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">as_reduce_to</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">Add</span><span class="p">,</span> <span class="n">top</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span> <span class="n">other</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">AlreadyMadeReduceTo</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span> <span class="o">-</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">other</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__isub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="n">libop</span><span class="o">.</span><span class="n">sub_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">AlreadyMadeReduceTo</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
        <span class="n">top</span><span class="o">.</span><span class="n">append_stmt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">as_reduce_to</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">Add</span><span class="p">,</span> <span class="n">top</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span> <span class="o">-</span><span class="n">other</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">AlreadyMadeReduceTo</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span> <span class="o">*</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">other</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__imul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="n">libop</span><span class="o">.</span><span class="n">mul_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">AlreadyMadeReduceTo</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
        <span class="n">top</span><span class="o">.</span><span class="n">append_stmt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">as_reduce_to</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">Mul</span><span class="p">,</span> <span class="n">top</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span> <span class="n">other</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">AlreadyMadeReduceTo</span>

    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">truediv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span> <span class="o">/</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__rtruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">truediv</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">other</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__itruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="n">libop</span><span class="o">.</span><span class="n">truediv_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">AlreadyMadeReduceTo</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
        <span class="n">top</span><span class="o">.</span><span class="n">append_stmt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">as_reduce_to</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">Mul</span><span class="p">,</span> <span class="n">top</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">other</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">AlreadyMadeReduceTo</span>

    <span class="k">def</span> <span class="fm">__floordiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">floordiv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span> <span class="o">//</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__rfloordiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">floordiv</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">other</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__ifloordiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="n">libop</span><span class="o">.</span><span class="n">floordiv_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">AlreadyMadeReduceTo</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>  <span class="c1"># Fallback to x = x // y</span>

    <span class="k">def</span> <span class="fm">__mod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span> <span class="o">%</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__rmod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">other</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__imod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="n">libop</span><span class="o">.</span><span class="n">mod_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">AlreadyMadeReduceTo</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>  <span class="c1"># Fallback to x = x % y</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span> <span class="o">!=</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">neg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_load</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__matmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__rmatmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h5 id="freetensor.core.expr.VarRef.shape" class="doc doc-heading">
<code class="highlight language-python"><span class="n">shape</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.VarRef.shape" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Return lengths of all dimensions or the length of one dimension</p>
<p><code>.shape()</code> -&gt; list of lengths of all dimensions</p>
<p><code>.shape(dim)</code> -&gt; length of dimension <code>dim</code>, where <code>dim</code> can be <code>int</code>
or <code>Expr</code></p>
<p>All lengths can be <code>Expr</code> (if the length is dynamically decided) or
<code>int</code> (if statically decided)</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return lengths of all dimensions or the length of one dimension</span>

<span class="sd">    `.shape()` -&gt; list of lengths of all dimensions</span>

<span class="sd">    `.shape(dim)` -&gt; length of dimension `dim`, where `dim` can be `int`</span>
<span class="sd">    or `Expr`</span>

<span class="sd">    All lengths can be `Expr` (if the length is dynamically decided) or</span>
<span class="sd">    `int` (if statically decided)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">intOrExpr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">val</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ffi</span><span class="o">.</span><span class="n">IntConst</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">intOrExpr</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">VarRef</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">intOrExpr</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">VarRef</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dim</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.expr.VarRefFromVarDef" class="doc doc-heading">
        <code>VarRefFromVarDef</code>


<a href="#freetensor.core.expr.VarRefFromVarDef" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="freetensor.core.expr.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code></p>

  
      <p>VarRef with extra checks</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">VarRefFromVarDef</span><span class="p">(</span><span class="n">VarRef</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    VarRef with extra checks</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">vardef</span><span class="p">,</span>
                 <span class="n">full_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">,</span>
                 <span class="n">dtype</span><span class="p">:</span> <span class="n">ffi</span><span class="o">.</span><span class="n">DataType</span><span class="p">,</span>
                 <span class="n">mtype</span><span class="p">:</span> <span class="n">ffi</span><span class="o">.</span><span class="n">MemType</span><span class="p">,</span>
                 <span class="n">indices</span><span class="p">:</span> <span class="n">Sequence</span> <span class="o">=</span> <span class="p">[]):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VarRefFromVarDef</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">full_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span>
                                               <span class="n">indices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vardef</span> <span class="o">=</span> <span class="n">vardef</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">VarRefFromVarDef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vardef</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_shape</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtype</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">chain_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_key</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">VarRefFromVarDef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vardef</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_shape</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtype</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">chain_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_key</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">AlreadyMadeReduceTo</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
            <span class="n">libop</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_writable</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">vardef</span><span class="o">.</span><span class="n">atype</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ffi</span><span class="o">.</span><span class="n">InvalidProgram</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot modify an </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">vardef</span><span class="o">.</span><span class="n">atype</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> tensor `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">vardef</span><span class="o">.</span><span class="n">borrower_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ffi</span><span class="o">.</span><span class="n">InvalidProgram</span><span class="p">(</span>
                <span class="s2">&quot;Cannot modify tensor `&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span>
                <span class="s2">&quot;` becuase it has been borrowed in another tensor&#39;s shape, &quot;</span>
                <span class="s2">&quot;a tensor slice, or a range of a loop&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">AlreadyMadeReduceTo</span><span class="p">:</span>  <span class="c1"># Following the checks above</span>
            <span class="k">return</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
        <span class="n">top</span><span class="o">.</span><span class="n">append_stmt</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">as_store</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span> <span class="n">value</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.expr.VarVersionRef" class="doc doc-heading">
        <code>VarVersionRef</code>


<a href="#freetensor.core.expr.VarVersionRef" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="freetensor.core.expr.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code></p>

  
      <p>Special VarRef used for custom gradient, generated from <code>mark_version</code></p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">VarVersionRef</span><span class="p">(</span><span class="n">VarRef</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Special VarRef used for custom gradient, generated from `mark_version`</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">full_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">,</span>
                 <span class="n">dtype</span><span class="p">:</span> <span class="n">ffi</span><span class="o">.</span><span class="n">DataType</span><span class="p">,</span>
                 <span class="n">mtype</span><span class="p">:</span> <span class="n">ffi</span><span class="o">.</span><span class="n">MemType</span><span class="p">,</span>
                 <span class="n">indices</span><span class="p">:</span> <span class="n">Sequence</span> <span class="o">=</span> <span class="p">[]):</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">full_shape</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">ffi</span><span class="o">.</span><span class="n">IntConst</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ffi</span><span class="o">.</span><span class="n">InvalidAutoGrad</span><span class="p">(</span>
                    <span class="s2">&quot;`mark_version` on dynamic-shaped variables is not supported&quot;</span>
                    <span class="s2">&quot; yet&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VarVersionRef</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">full_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span>
                                            <span class="n">indices</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.abs" class="doc doc-heading">
<code class="highlight language-python"><span class="nb">abs</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.abs" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Absolute value</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.abs</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>expr</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The absolute value</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">abs</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Absolute value</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.abs</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr : VarRef or Number</span>
<span class="sd">        The operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The absolute value</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">builtins</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeAbs</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.add" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.add" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p><code>lhs + rhs</code></p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.add</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The sum</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    `lhs + rhs`</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.add</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The sum</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">+</span> <span class="n">rhs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.any" class="doc doc-heading">
<code class="highlight language-python"><span class="nb">any</span><span class="p">()</span></code>

<a href="#freetensor.core.expr.any" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Create an AnyExpr node (only for testing and type inference)</p>
<p>Any nodes matches any expression nodes in <code>ast.match</code></p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">any</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create an AnyExpr node (only for testing and type inference)</span>

<span class="sd">    Any nodes matches any expression nodes in `ast.match`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeAnyExpr</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.cast" class="doc doc-heading">
<code class="highlight language-python"><span class="n">cast</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.cast" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Cast to another type</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>expr</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code>DataTypr or str</code>
          </td>
          <td><p>The target data type</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The result</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">cast</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Cast to another type</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr : VarRef or Number</span>
<span class="sd">        The operand</span>
<span class="sd">    dtype : DataTypr or str</span>
<span class="sd">        The target data type</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The result</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeCast</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">ffi</span><span class="o">.</span><span class="n">DataType</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.ceil" class="doc doc-heading">
<code class="highlight language-python"><span class="n">ceil</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.ceil" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Round a float up to an interger (towards +inf)</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.ceil</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>expr</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The result</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ceil</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Round a float up to an interger (towards +inf)</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.ceil</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr : VarRef or Number</span>
<span class="sd">        The operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The result</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeCeil</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.ceildiv" class="doc doc-heading">
<code class="highlight language-python"><span class="n">ceildiv</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.ceildiv" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Ceiling integer division of <code>lhs</code> dividing by <code>rhs</code></p>
<p>The result rounds towards positive infinity</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.ceildiv</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The quotient</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ceildiv</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Ceiling integer division of `lhs` dividing by `rhs`</span>

<span class="sd">    The result rounds towards positive infinity</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.ceildiv</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The quotient</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">rhs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">ceildiv</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lhs</span> <span class="o">//</span> <span class="n">rhs</span> <span class="o">+</span> <span class="p">(</span><span class="n">lhs</span> <span class="o">%</span> <span class="n">rhs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeCeilDiv</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.dtype" class="doc doc-heading">
<code class="highlight language-python"><span class="n">dtype</span><span class="p">(</span><span class="n">var</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.dtype" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Get element data type of a variable</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Get element data type of a variable &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">var</span><span class="o">.</span><span class="n">dtype</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">ffi</span><span class="o">.</span><span class="n">Expr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">var</span><span class="o">.</span><span class="n">dtype</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO: Config default type</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="c1"># NOTE: before int, because bool in Python is a sub-class of int</span>
            <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">DataType</span><span class="p">(</span><span class="s2">&quot;bool&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">DataType</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">DataType</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unknown scalar type: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">var</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.eq" class="doc doc-heading">
<code class="highlight language-python"><span class="n">eq</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.eq" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p><code>lhs == rhs</code></p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.eq</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The comparison</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">eq</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    `lhs == rhs`</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.eq</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The comparison</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">==</span> <span class="n">rhs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.exp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">exp</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.exp" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Natural exponent</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.exp</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>expr</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The exponent</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">exp</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Natural exponent</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.exp</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr : VarRef or Number</span>
<span class="sd">        The operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The exponent</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeExp</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.floor" class="doc doc-heading">
<code class="highlight language-python"><span class="n">floor</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.floor" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Round a float down to an interger (towards -inf)</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.floor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>expr</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The result</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">floor</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Round a float down to an interger (towards -inf)</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.floor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr : VarRef or Number</span>
<span class="sd">        The operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The result</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeFloor</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.floordiv" class="doc doc-heading">
<code class="highlight language-python"><span class="n">floordiv</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.floordiv" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Floored integer division of <code>lhs</code> dividing by <code>rhs</code></p>
<p>The result rounds towards negative infinity (following Python convention, instead of C)
This function is recommended over <code>round_towards_0_div</code>, as it enjoys more optimizations</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.floordiv</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The quotient</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">floordiv</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Floored integer division of `lhs` dividing by `rhs`</span>

<span class="sd">    The result rounds towards negative infinity (following Python convention, instead of C)</span>
<span class="sd">    This function is recommended over `round_towards_0_div`, as it enjoys more optimizations</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.floordiv</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The quotient</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">//</span> <span class="n">rhs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.ge" class="doc doc-heading">
<code class="highlight language-python"><span class="n">ge</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.ge" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p><code>lhs &gt;= rhs</code></p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.ge</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The comparison</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ge</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    `lhs &gt;= rhs`</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.ge</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The comparison</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">&gt;=</span> <span class="n">rhs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.gt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">gt</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.gt" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p><code>lhs &gt; rhs</code></p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.gt</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The comparison</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">gt</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    `lhs &gt; rhs`</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.gt</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The comparison</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">&gt;</span> <span class="n">rhs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.if_then_else" class="doc doc-heading">
<code class="highlight language-python"><span class="n">if_then_else</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">then_case</span><span class="p">,</span> <span class="n">else_case</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.if_then_else" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Similar to <code>then_case if cond else else_case</code></p>
<p>NOTE: there is NO guarantee that only one branch will be executed. In some cases,
both branches will be executed and the result of one of them will be picked.
Therefore, please do NOT use <code>if_then_else</code> to guard an out-of-bound array indexing</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>cond</code></td>
          <td>
                <code>VarRef of Number</code>
          </td>
          <td><p>Condition</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>Then-case experssion</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>Else-case expression</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The result</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">if_then_else</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">then_case</span><span class="p">,</span> <span class="n">else_case</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Similar to `then_case if cond else else_case`</span>

<span class="sd">    NOTE: there is NO guarantee that only one branch will be executed. In some cases,</span>
<span class="sd">    both branches will be executed and the result of one of them will be picked.</span>
<span class="sd">    Therefore, please do NOT use `if_then_else` to guard an out-of-bound array indexing</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cond : VarRef of Number</span>
<span class="sd">        Condition</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        Then-case experssion</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        Else-case expression</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The result</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">then_case</span> <span class="k">if</span> <span class="n">cond</span> <span class="k">else</span> <span class="n">else_case</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeIfExpr</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">then_case</span><span class="p">,</span> <span class="n">else_case</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.intrinsic" class="doc doc-heading">
<code class="highlight language-python"><span class="n">intrinsic</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.intrinsic" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Invoke whatever target code</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>fmt</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>What to run. "%" is filled by parameters one by one. E.g. sinf(%)</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>The</code></td>
          <td>
          </td>
          <td><p>Parameters to <code>fmt</code></p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ret_type</code></td>
          <td>
                <code>DataType or str</code>
          </td>
          <td><p>(Keyword argument only) The return type. Void for no return type. Defaults to Void</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>has_side_effect</code></td>
          <td>
          </td>
          <td><p>(Keyword argument only) True to indicate the intrinsic modifes something other than the return value. Defaults to false</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">intrinsic</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Invoke whatever target code</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fmt : str</span>
<span class="sd">        What to run. &quot;%&quot; is filled by parameters one by one. E.g. sinf(%)</span>
<span class="sd">    The following variadic arguments : Expr</span>
<span class="sd">        Parameters to `fmt`</span>
<span class="sd">    ret_type : DataType or str</span>
<span class="sd">        (Keyword argument only) The return type. Void for no return type. Defaults to Void</span>
<span class="sd">    has_side_effect: bool</span>
<span class="sd">        (Keyword argument only) True to indicate the intrinsic modifes something other than the return value. Defaults to false</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret_type</span> <span class="o">=</span> <span class="n">ffi</span><span class="o">.</span><span class="n">DataType</span><span class="p">(</span><span class="s2">&quot;void&quot;</span><span class="p">)</span>
    <span class="n">has_side_effect</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s2">&quot;ret_type&quot;</span> <span class="ow">in</span> <span class="n">kws</span><span class="p">:</span>
        <span class="n">ret_type</span> <span class="o">=</span> <span class="n">ffi</span><span class="o">.</span><span class="n">DataType</span><span class="p">(</span><span class="n">kws</span><span class="p">[</span><span class="s2">&quot;ret_type&quot;</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">kws</span><span class="p">[</span><span class="s2">&quot;ret_type&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;has_side_effect&quot;</span> <span class="ow">in</span> <span class="n">kws</span><span class="p">:</span>
        <span class="n">has_side_effect</span> <span class="o">=</span> <span class="n">kws</span><span class="p">[</span><span class="s2">&quot;has_side_effect&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">kws</span><span class="p">[</span><span class="s2">&quot;has_side_effect&quot;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">kws</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Unrecognized keyword arguments: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">kws</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeIntrinsic</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">ret_type</span><span class="p">,</span> <span class="n">has_side_effect</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.l_and" class="doc doc-heading">
<code class="highlight language-python"><span class="n">l_and</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.l_and" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Logical and of <code>lhs</code> and <code>rhs</code></p>
<p>NOTE: Short-circuit evaluation is NOT supported</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.l_and</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The logical and</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">l_and</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Logical and of `lhs` and `rhs`</span>

<span class="sd">    NOTE: Short-circuit evaluation is NOT supported</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.l_and</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The logical and</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">rhs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">l_and</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lhs</span> <span class="ow">and</span> <span class="n">rhs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeLAnd</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.l_not" class="doc doc-heading">
<code class="highlight language-python"><span class="n">l_not</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.l_not" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Logical not</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.l_not</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>expr</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The logical not</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">l_not</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Logical not</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.l_not</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr : VarRef or Number</span>
<span class="sd">        The operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The logical not</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">l_not</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">expr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeLNot</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.l_or" class="doc doc-heading">
<code class="highlight language-python"><span class="n">l_or</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.l_or" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Logical or of <code>lhs</code> and <code>rhs</code></p>
<p>NOTE: Short-circuit evaluation is NOT supported</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.l_or</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The logical or</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">l_or</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Logical or of `lhs` and `rhs`</span>

<span class="sd">    NOTE: Short-circuit evaluation is NOT supported</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.l_or</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The logical or</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">rhs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">l_or</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lhs</span> <span class="ow">or</span> <span class="n">rhs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeLOr</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.le" class="doc doc-heading">
<code class="highlight language-python"><span class="n">le</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.le" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p><code>lhs &lt;= rhs</code></p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.le</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The comparison</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">le</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    `lhs &lt;= rhs`</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.le</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The comparison</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">&lt;=</span> <span class="n">rhs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.ln" class="doc doc-heading">
<code class="highlight language-python"><span class="n">ln</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.ln" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Natural logarithm</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.ln</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>expr</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The exponent</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ln</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Natural logarithm</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.ln</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr : VarRef or Number</span>
<span class="sd">        The operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The exponent</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">ln</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>  <span class="c1"># Defaults to ln without the base</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeLn</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.load_at_version" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_at_version</span><span class="p">(</span><span class="n">tape_name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">*</span><span class="n">indices</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.load_at_version" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Create an LoadAtVersion node (only for custom gradient)</p>
<p>This node is only used for custom gradient. See <code>UserGradForPrevStmt</code>.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_at_version</span><span class="p">(</span><span class="n">tape_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="o">*</span><span class="n">indices</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create an LoadAtVersion node (only for custom gradient)</span>

<span class="sd">    This node is only used for custom gradient. See `UserGradForPrevStmt`.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeLoadAtVersion</span><span class="p">(</span><span class="n">tape_name</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">ffi</span><span class="o">.</span><span class="n">DataType</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.lt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">lt</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.lt" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p><code>lhs &lt; rhs</code></p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.lt</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The comparison</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">lt</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    `lhs &lt; rhs`</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.lt</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The comparison</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">&lt;</span> <span class="n">rhs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.max" class="doc doc-heading">
<code class="highlight language-python"><span class="nb">max</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.max" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Maximum of <code>lhs</code> and <code>rhs</code></p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.max</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The maximum</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Maximum of `lhs` and `rhs`</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.max</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The maximum</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">rhs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">builtins</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeMax</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.min" class="doc doc-heading">
<code class="highlight language-python"><span class="nb">min</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.min" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Minimum of <code>lhs</code> and <code>rhs</code></p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.min</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The minimum</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Minimum of `lhs` and `rhs`</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.min</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The minimum</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">rhs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">builtins</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeMin</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.mod" class="doc doc-heading">
<code class="highlight language-python"><span class="n">mod</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.mod" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p><code>lhs</code> modulus <code>rhs</code></p>
<p>The result is always non-negative (following Python convention, instead of C).
This function is recommended over <code>remainder</code>, as it enjoys more optimizations</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.mod</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The modulo</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mod</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    `lhs` modulus `rhs`</span>

<span class="sd">    The result is always non-negative (following Python convention, instead of C).</span>
<span class="sd">    This function is recommended over `remainder`, as it enjoys more optimizations</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.mod</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The modulo</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">%</span> <span class="n">rhs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.mtype" class="doc doc-heading">
<code class="highlight language-python"><span class="n">mtype</span><span class="p">(</span><span class="n">var</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.mtype" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Get memory type of a variable</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mtype</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Get memory type of a variable &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">var</span><span class="o">.</span><span class="n">mtype</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;byvalue&#39;</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.mul" class="doc doc-heading">
<code class="highlight language-python"><span class="n">mul</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.mul" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p><code>lhs * rhs</code></p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.mul</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The product</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mul</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    `lhs * rhs`</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.mul</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The product</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">*</span> <span class="n">rhs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.ndim" class="doc doc-heading">
<code class="highlight language-python"><span class="n">ndim</span><span class="p">(</span><span class="n">var</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.ndim" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Get the number of dimensions of a variable</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Get the number of dimensions of a variable &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">var</span><span class="o">.</span><span class="n">ndim</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.ne" class="doc doc-heading">
<code class="highlight language-python"><span class="n">ne</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.ne" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p><code>lhs != rhs</code></p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.ne</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The comparison</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ne</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    `lhs != rhs`</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.ne</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The comparison</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">!=</span> <span class="n">rhs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.remainder" class="doc doc-heading">
<code class="highlight language-python"><span class="n">remainder</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.remainder" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Remainder of <code>lhs</code> dividing <code>rhs</code></p>
<p>The result can be positive or negative (following C convention, instead of Python).
End users are encouraged to use <code>lhs % rhs</code> instead, which follows Python convetion,
and enjoys better optimization in FreeTensor</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.remainder</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The remainder</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">remainder</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Remainder of `lhs` dividing `rhs`</span>

<span class="sd">    The result can be positive or negative (following C convention, instead of Python).</span>
<span class="sd">    End users are encouraged to use `lhs % rhs` instead, which follows Python convetion,</span>
<span class="sd">    and enjoys better optimization in FreeTensor</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.remainder</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The remainder</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">rhs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeRemainder</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.round_towards_0_div" class="doc doc-heading">
<code class="highlight language-python"><span class="n">round_towards_0_div</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.round_towards_0_div" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>C-style integer division of <code>lhs</code> dividing by <code>rhs</code></p>
<p>The result rounds towards 0 (following C convention, instead of Python)
End users are encouraged to use <code>lhs // rhs</code> instead, which follows Python convetion,
and enjoys better optimization in FreeTensor</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.round_towards_0_div</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The quotient</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">round_towards_0_div</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    C-style integer division of `lhs` dividing by `rhs`</span>

<span class="sd">    The result rounds towards 0 (following C convention, instead of Python)</span>
<span class="sd">    End users are encouraged to use `lhs // rhs` instead, which follows Python convetion,</span>
<span class="sd">    and enjoys better optimization in FreeTensor</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.round_towards_0_div</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The quotient</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">lhs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">rhs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">round_towards_0_div</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeRoundTowards0Div</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.shape" class="doc doc-heading">
<code class="highlight language-python"><span class="n">shape</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.shape" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>shape(var, i): Get size of specified dimension of a variable
shape(var): Get sizes of all dimensions of a variable</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; shape(var, i): Get size of specified dimension of a variable</span>
<span class="sd">        shape(var): Get sizes of all dimensions of a variable &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Getting size of dimension </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> of scalar </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.sigmoid" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sigmoid</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.sigmoid" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Sigmoid</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.sigmoid</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>expr</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The result</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sigmoid</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.sigmoid</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr : VarRef or Number</span>
<span class="sd">        The operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The result</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeSigmoid</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.sqrt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sqrt</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.sqrt" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Square root</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.sqrt</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>expr</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The square root</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Square root</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.sqrt</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr : VarRef or Number</span>
<span class="sd">        The operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The square root</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeSqrt</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.square" class="doc doc-heading">
<code class="highlight language-python"><span class="n">square</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.square" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Square</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.square</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>expr</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The square</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">square</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Square</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.square</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr : VarRef or Number</span>
<span class="sd">        The operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The square</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expr</span> <span class="o">*</span> <span class="n">expr</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeSquare</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.sub" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sub</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.sub" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p><code>lhs - rhs</code></p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.sub</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The difference</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">sub</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    `lhs - rhs`</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.sub</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The difference</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">-</span> <span class="n">rhs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.tanh" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tanh</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.tanh" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Hyperbolic tangent</p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.tanh</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>expr</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The result</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">tanh</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Hyperbolic tangent</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.tanh</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr : VarRef or Number</span>
<span class="sd">        The operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The result</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">_istensor</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">libop</span>
        <span class="k">return</span> <span class="n">libop</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeTanh</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.expr.truediv" class="doc doc-heading">
<code class="highlight language-python"><span class="n">truediv</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></code>

<a href="#freetensor.core.expr.truediv" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Floating point division of <code>lhs</code> dividing by <code>rhs</code></p>
<p>For scalar operands, it emit an expression node in AST. For non-scalar operands,
it calls libop.truediv</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>lhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>rhs</code></td>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>VarRef or Number</code>
          </td>
          <td><p>The quotient</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/expr.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">truediv</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Floating point division of `lhs` dividing by `rhs`</span>

<span class="sd">    For scalar operands, it emit an expression node in AST. For non-scalar operands,</span>
<span class="sd">    it calls libop.truediv</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lhs : VarRef or Number</span>
<span class="sd">        The left-hand-side operand</span>
<span class="sd">    rhs : VarRef or Number</span>
<span class="sd">        The right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef or Number</span>
<span class="sd">        The quotient</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">lhs</span> <span class="o">/</span> <span class="n">rhs</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="freetensor.core.frontend" class="doc doc-heading">
          <code>frontend</code>


<a href="#freetensor.core.frontend" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">
  
      <p>A frontend transforming user Python functions to ASTs via staging.</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="freetensor.core.frontend.FreeTensorOverload" class="doc doc-heading">
        <code>FreeTensorOverload</code>


<a href="#freetensor.core.frontend.FreeTensorOverload" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="freetensor.core.staging.StagingOverload" href="#freetensor.core.staging.StagingOverload">StagingOverload</a></code></p>

  
      <p>Helper class managing context in IR staging.</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/frontend.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">FreeTensorOverload</span><span class="p">(</span><span class="n">StagingOverload</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Helper class managing context in IR staging.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lifetime_stack</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">LifetimeScope</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closure</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register_vardef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">name</span><span class="p">,</span>
                        <span class="n">shape</span><span class="p">,</span>
                        <span class="n">dtype</span><span class="p">,</span>
                        <span class="n">atype</span><span class="p">,</span>
                        <span class="n">mtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">capture</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">fullname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">capture</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closure</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span> <span class="o">=</span> <span class="n">capture</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lifetime_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">register_inner_scope</span><span class="p">(</span>
            <span class="n">_VarDef</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">mtype</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">register_inlined_invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">func</span><span class="p">:</span> <span class="n">ffi</span><span class="o">.</span><span class="n">Func</span><span class="p">,</span>
                                <span class="n">args</span><span class="p">,</span> <span class="n">kvs</span><span class="p">):</span>
        <span class="n">ret_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fullname</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ret_names</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lifetime_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">register_inner_scope</span><span class="p">(</span>
            <span class="n">Invoke</span><span class="p">(</span><span class="n">ret_names</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kvs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">register_assert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lifetime_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">register_inner_scope</span><span class="p">(</span><span class="n">Assert</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">fullname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Get distinct name.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">in_staging</span><span class="p">(</span><span class="bp">self</span><span class="p">,):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lifetime_stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">custom_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;ndim&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ndim</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;shape&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">:</span> <span class="n">shape</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;dtype&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;mtype&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mtype</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">functiondef_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">basic_wrapped</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">functiondef_wrapper</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">__freetensor_transform_outermost__</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">__freetensor_transform_outermost__</span><span class="p">:</span>
                <span class="n">call_metadata</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">call_metadata</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span>
            <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">clear_metadata</span><span class="p">()</span>

            <span class="n">prev</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">caller_metadata</span>
            <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">set_caller_metadata</span><span class="p">(</span><span class="n">call_metadata</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">basic_wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">set_caller_metadata</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">wrapped</span>

    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">key</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;label:&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;no_deps:&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">back</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span>

                <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">back</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="n">back</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">back</span><span class="o">.</span><span class="n">f_globals</span><span class="p">:</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="n">back</span><span class="o">.</span><span class="n">f_globals</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Variable </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1"> not found for annotating comment (</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">)&#39;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Variable </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> is not a VarRef, which is required by annotating comment (</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">)&#39;</span>
                    <span class="p">)</span>
                <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">add_next_no_deps</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;prefer_libs&#39;</span><span class="p">:</span>
            <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">set_next_prefer_libs</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">raise</span> <span class="n">ffi</span><span class="o">.</span><span class="n">InvalidProgram</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;Invalid metadata. Possible metadata are:</span>
<span class="s1">`label: &lt;label_name&gt;`: to label the following statement,</span>
<span class="s1">`no_deps: &lt;variable_name&gt;`: to mark a variable to have no dependence along the following loop,</span>
<span class="s1">`prefer_libs`: to indicate the following statement should preferably be executed using external libraries.</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">at_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">set_next_location</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h5 id="freetensor.core.frontend.FreeTensorOverload.fullname" class="doc doc-heading">
<code class="highlight language-python"><span class="n">fullname</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>

<a href="#freetensor.core.frontend.FreeTensorOverload.fullname" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Get distinct name.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/frontend.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fullname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Get distinct name.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">name</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.frontend.LifetimeScope" class="doc doc-heading">
        <code>LifetimeScope</code>


<a href="#freetensor.core.frontend.LifetimeScope" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">

  
      <p>This scope is used to register multiple scopes inside a single lifetime scope.
The inner scopes might be used to register variables, etc.
They will be exited in reverse order of their registration.</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/frontend.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">LifetimeScope</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;This scope is used to register multiple scopes inside a single lifetime scope.</span>
<span class="sd">    The inner scopes might be used to register variables, etc.</span>
<span class="sd">    They will be exited in reverse order of their registration.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inner_scopes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lang_overload</span><span class="o">.</span><span class="n">lifetime_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_scopes</span><span class="p">):</span>
            <span class="n">scope</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
        <span class="n">popped</span> <span class="o">=</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">lifetime_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">popped</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;LifetimeScope enter/exit not match, must be FILO&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_inner_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inner_scopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scope</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.frontend.UserGrad" class="doc doc-heading">
        <code>UserGrad</code>


<a href="#freetensor.core.frontend.UserGrad" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><a class="autorefs autorefs-internal" title="freetensor.core.stmt.UserGradStaged" href="#freetensor.core.stmt.UserGradStaged">UserGradStaged</a></code></p>

  
      <p>Define a custom gradient</p>
<p>Follow the following steps to define custom gradient:</p>
<ol>
<li>Add some <code>mark_version</code> statements in the program. <code>mark_version('y0', y)</code> marks the specific
versions of variable <code>y</code> <strong>at the program position of the statement</strong> and <strong>at all iterations</strong>
as <code>'y0'</code>.</li>
<li>Add a <code>UserGrad</code> scope.
2.1. <code>UserGrad</code> optionally receives parameter <code>stmt_range</code>, recorded by the <code>StmtRange</code> helper class,
which means the gradient is for the code specified in the range. Ignoring the parameter means setting
gradient for the previous statement of the scope.
2.2. Other parameters of <code>UserGrad</code> sets the mapping from original variables to gradient variables.
<code>with UserGradForPrevStmt(x, y) as (dx, dy)</code> provides <code>VarRef</code> <code>dx</code> and <code>dy</code> as gradient variables
to be used inside the scope.</li>
<li>In order to use the value from the forward pass in the backward pass, do not access the forward
variables directly in the scope. Instead, use <code>load_at_version</code> expressions. <code>load_at_version(y0, i, j)</code>
loads from <code>y[i, j]</code> <strong>at the specific version marked by <code>y0 = mark_version(y)</code></strong>, saved from <strong>the same
iteration in the forward pass</strong>. (If directly writing staged code, it is <code>MarkVersion('y0', y)</code>). In
other words, after AD, the position of <code>mark_version</code> and the dynamic loop iterator together makes up
the actual version number for the tape.</li>
<li>Build the AST with <code>pop_ast_and_user_grads</code> instead of <code>pop_ast</code>. An extra list will be returned
together with the AST, which you need to pass as <code>grad</code>'s <code>user_grads</code> argument. This list records
the forward-to-backward relation of the nodes.</li>
</ol>
<p>If you are directly writing staged code, use <code>UserGradStaged</code> instead.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>stmt_range</code></td>
          <td>
          </td>
          <td><p>The range in the original program that we are setting custom gradient for</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>args</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="freetensor.core.stmt.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a>]</code>
          </td>
          <td><p>(Positional variadic) Mapping from original variables to gradient variables</p></td>
          <td>
                <code>()</code>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/frontend.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">UserGrad</span><span class="p">(</span><span class="n">UserGradStaged</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Define a custom gradient</span>

<span class="sd">    Follow the following steps to define custom gradient:</span>

<span class="sd">    1. Add some `mark_version` statements in the program. `mark_version(&#39;y0&#39;, y)` marks the specific</span>
<span class="sd">    versions of variable `y` **at the program position of the statement** and **at all iterations**</span>
<span class="sd">    as `&#39;y0&#39;`.</span>
<span class="sd">    2. Add a `UserGrad` scope.</span>
<span class="sd">    2.1. `UserGrad` optionally receives parameter `stmt_range`, recorded by the `StmtRange` helper class,</span>
<span class="sd">    which means the gradient is for the code specified in the range. Ignoring the parameter means setting</span>
<span class="sd">    gradient for the previous statement of the scope.</span>
<span class="sd">    2.2. Other parameters of `UserGrad` sets the mapping from original variables to gradient variables.</span>
<span class="sd">    `with UserGradForPrevStmt(x, y) as (dx, dy)` provides `VarRef` `dx` and `dy` as gradient variables</span>
<span class="sd">    to be used inside the scope.</span>
<span class="sd">    3. In order to use the value from the forward pass in the backward pass, do not access the forward</span>
<span class="sd">    variables directly in the scope. Instead, use `load_at_version` expressions. `load_at_version(y0, i, j)`</span>
<span class="sd">    loads from `y[i, j]` **at the specific version marked by `y0 = mark_version(y)`**, saved from **the same</span>
<span class="sd">    iteration in the forward pass**. (If directly writing staged code, it is `MarkVersion(&#39;y0&#39;, y)`). In</span>
<span class="sd">    other words, after AD, the position of `mark_version` and the dynamic loop iterator together makes up</span>
<span class="sd">    the actual version number for the tape.</span>
<span class="sd">    4. Build the AST with `pop_ast_and_user_grads` instead of `pop_ast`. An extra list will be returned</span>
<span class="sd">    together with the AST, which you need to pass as `grad`&#39;s `user_grads` argument. This list records</span>
<span class="sd">    the forward-to-backward relation of the nodes.</span>

<span class="sd">    If you are directly writing staged code, use `UserGradStaged` instead.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stmt_range: Optional[StmtRange]</span>
<span class="sd">        The range in the original program that we are setting custom gradient for</span>
<span class="sd">    args: Sequence[VarRef]</span>
<span class="sd">        (Positional variadic) Mapping from original variables to gradient variables</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">VarRef</span><span class="p">],</span> <span class="o">**</span><span class="n">kvs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UserGrad</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kvs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lifetime_scope</span> <span class="o">=</span> <span class="n">LifetimeScope</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">UserGrad</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lifetime_scope</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lifetime_scope</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">UserGrad</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.frontend.Var" class="doc doc-heading">
        <code>Var</code>


<a href="#freetensor.core.frontend.Var" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="freetensor.core.staging.StagedTypeAnnotation">StagedTypeAnnotation</span></code></p>



        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/frontend.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Var</span><span class="p">(</span><span class="n">StagedTypeAnnotation</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">atype</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">mtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Declare a variable</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the variable</span>
<span class="sd">        shape : Sequence[Expr] or Var</span>
<span class="sd">            Shape of the variable. A variable can be created using a literal shape,</span>
<span class="sd">            or another fixed-length VarRef as a shape</span>
<span class="sd">        dtype : str or DataType</span>
<span class="sd">            Data type of the variable</span>
<span class="sd">        atype : str or AccessType</span>
<span class="sd">            Access type of the variable. It specifies whether (and how) the variable</span>
<span class="sd">            is an I/O variable of the function it belongs to. Defaults to &quot;input&quot;</span>
<span class="sd">        mtype : str or MemType (Optional)</span>
<span class="sd">            Memory type of the variable. If omitted, the main memory type of the</span>
<span class="sd">            default Target in config will be used</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtype</span> <span class="o">=</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">mtype</span>

    <span class="k">def</span> <span class="nf">annotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VarRef</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">register_vardef</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">atype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtype</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h5 id="freetensor.core.frontend.Var.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">atype</span><span class="o">=</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">mtype</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.core.frontend.Var.__init__" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Declare a variable</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>name</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Name of the variable</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>shape</code></td>
          <td>
                <code>Sequence[Expr] or Var</code>
          </td>
          <td><p>Shape of the variable. A variable can be created using a literal shape,
or another fixed-length VarRef as a shape</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code>str or DataType</code>
          </td>
          <td><p>Data type of the variable</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>atype</code></td>
          <td>
                <code>str or AccessType</code>
          </td>
          <td><p>Access type of the variable. It specifies whether (and how) the variable
is an I/O variable of the function it belongs to. Defaults to "input"</p></td>
          <td>
                <code>&#39;input&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>mtype</code></td>
          <td>
                <code>str or MemType (Optional)</code>
          </td>
          <td><p>Memory type of the variable. If omitted, the main memory type of the
default Target in config will be used</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/frontend.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">atype</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">mtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Declare a variable</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of the variable</span>
<span class="sd">    shape : Sequence[Expr] or Var</span>
<span class="sd">        Shape of the variable. A variable can be created using a literal shape,</span>
<span class="sd">        or another fixed-length VarRef as a shape</span>
<span class="sd">    dtype : str or DataType</span>
<span class="sd">        Data type of the variable</span>
<span class="sd">    atype : str or AccessType</span>
<span class="sd">        Access type of the variable. It specifies whether (and how) the variable</span>
<span class="sd">        is an I/O variable of the function it belongs to. Defaults to &quot;input&quot;</span>
<span class="sd">    mtype : str or MemType (Optional)</span>
<span class="sd">        Memory type of the variable. If omitted, the main memory type of the</span>
<span class="sd">        default Target in config will be used</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtype</span> <span class="o">=</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">mtype</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.frontend.VarCreator" class="doc doc-heading">
        <code>VarCreator</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#freetensor.core.frontend.VarCreator" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="freetensor.core.staging.StagedAssignable">StagedAssignable</span></code></p>



        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/frontend.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">VarCreator</span><span class="p">(</span><span class="n">StagedAssignable</span><span class="p">):</span>
    <span class="n">shape</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">,</span> <span class="n">VarRef</span><span class="p">]</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">mtype</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">assigned</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VarRef</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Customized assign behavior. Creates a VarDef with its full name.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assigned</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">register_vardef</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                                 <span class="s1">&#39;cache&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Create new tensors in an `a = b = c`-like multi-assignment &quot;</span>
                <span class="s2">&quot;is not supported&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h5 id="freetensor.core.frontend.VarCreator.assign" class="doc doc-heading">
<code class="highlight language-python"><span class="n">assign</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>

<a href="#freetensor.core.frontend.VarCreator.assign" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Customized assign behavior. Creates a VarDef with its full name.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/frontend.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VarRef</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Customized assign behavior. Creates a VarDef with its full name.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assigned</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">register_vardef</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                             <span class="s1">&#39;cache&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Create new tensors in an `a = b = c`-like multi-assignment &quot;</span>
            <span class="s2">&quot;is not supported&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.frontend.VersionMarker" class="doc doc-heading">
        <code>VersionMarker</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#freetensor.core.frontend.VersionMarker" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="freetensor.core.staging.StagedAssignable">StagedAssignable</span></code></p>



        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/frontend.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">VersionMarker</span><span class="p">(</span><span class="n">StagedAssignable</span><span class="p">):</span>
    <span class="n">var</span><span class="p">:</span> <span class="n">VarRef</span>
    <span class="n">assigned</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VarRef</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Customized assign behavior. Creates a MarkVersion with its full name.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assigned</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">full_tape_name</span> <span class="o">=</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">fullname</span><span class="p">(</span><span class="n">tape_name</span><span class="p">)</span>
            <span class="n">MarkVersion</span><span class="p">(</span><span class="n">full_tape_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">VarVersionRef</span><span class="p">(</span><span class="n">full_tape_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">full_shape</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">mtype</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Marking version in an `a = b = c`-like multi-assignment is not&quot;</span>
                <span class="s2">&quot; supported&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h5 id="freetensor.core.frontend.VersionMarker.assign" class="doc doc-heading">
<code class="highlight language-python"><span class="n">assign</span><span class="p">(</span><span class="n">tape_name</span><span class="p">)</span></code>

<a href="#freetensor.core.frontend.VersionMarker.assign" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Customized assign behavior. Creates a MarkVersion with its full name.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/frontend.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tape_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VarRef</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Customized assign behavior. Creates a MarkVersion with its full name.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assigned</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">full_tape_name</span> <span class="o">=</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">fullname</span><span class="p">(</span><span class="n">tape_name</span><span class="p">)</span>
        <span class="n">MarkVersion</span><span class="p">(</span><span class="n">full_tape_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">VarVersionRef</span><span class="p">(</span><span class="n">full_tape_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">full_shape</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">mtype</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Marking version in an `a = b = c`-like multi-assignment is not&quot;</span>
            <span class="s2">&quot; supported&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.frontend.dynamic_range" class="doc doc-heading">
        <code>dynamic_range</code>


<a href="#freetensor.core.frontend.dynamic_range" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="freetensor.core.staging.StagedIterable">StagedIterable</span></code></p>

  
      <p>Dynamic range that generates For loop in IR tree.</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/frontend.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">dynamic_range</span><span class="p">(</span><span class="n">StagedIterable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Dynamic range that generates For loop in IR tree.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Initialize a dynamic range.</span>
<span class="sd">        Arguments semantic identical to builtin `range`.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">stop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>

    <span class="k">def</span> <span class="nf">foreach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Customized foreach behavior. Creates a For loop.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;dynamic_range only supports exactly one target variable&#39;</span><span class="p">)</span>

        <span class="c1"># Early optimizations</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">LifetimeScope</span><span class="p">():</span>
                    <span class="n">body</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">with</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">allow_shortcut_scope</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">For</span><span class="p">(</span><span class="n">lang_overload</span><span class="o">.</span><span class="n">fullname</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="k">as</span> <span class="n">iter_var</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">LifetimeScope</span><span class="p">():</span>
                    <span class="n">body</span><span class="p">(</span><span class="n">iter_var</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h5 id="freetensor.core.frontend.dynamic_range.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

<a href="#freetensor.core.frontend.dynamic_range.__init__" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Initialize a dynamic range.
Arguments semantic identical to builtin <code>range</code>.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/frontend.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Initialize a dynamic range.</span>
<span class="sd">    Arguments semantic identical to builtin `range`.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">stop</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">start</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.frontend.dynamic_range.foreach" class="doc doc-heading">
<code class="highlight language-python"><span class="n">foreach</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span></code>

<a href="#freetensor.core.frontend.dynamic_range.foreach" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Customized foreach behavior. Creates a For loop.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/frontend.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">foreach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Customized foreach behavior. Creates a For loop.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;dynamic_range only supports exactly one target variable&#39;</span><span class="p">)</span>

    <span class="c1"># Early optimizations</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">LifetimeScope</span><span class="p">():</span>
                <span class="n">body</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="k">with</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">allow_shortcut_scope</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">For</span><span class="p">(</span><span class="n">lang_overload</span><span class="o">.</span><span class="n">fullname</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)</span> <span class="k">as</span> <span class="n">iter_var</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">LifetimeScope</span><span class="p">():</span>
                <span class="n">body</span><span class="p">(</span><span class="n">iter_var</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h4 id="freetensor.core.frontend.push_for_backward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">push_for_backward</span><span class="p">(</span><span class="n">var</span><span class="p">)</span></code>

<a href="#freetensor.core.frontend.push_for_backward" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Push the current value from the forward pass to be used at the backward pass</p>
<p>This function is for custom gradients. See <code>UserGrad</code> for details on how to provide custom
gradients.</p>
<p>You may imagine there is a virtual stack for each variable. Each time you call <code>x_handle =
push_for_backward(x)</code> in the forward pass, the value of <code>x</code> <strong>at the current iteration</strong>
will be "pushed" to the virtual stack. You can access <code>x_handle</code> at the backward pass. Each
time you access <code>x_handle</code>, you will "pop" the stack and get the value of <code>x</code> <strong>pushed at
the same iteration</strong>. Since the "stack" is virtual, you do NOT need to "pop" the same count
as "push"es: the version numbering is fully automatic. Besides, there may not be a real
stack at runtime: it can be compiled to any data structure.</p>
<p>This function will be staged to <code>mark_version</code> statement in the IR.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/frontend.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">push_for_backward</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="n">VarRef</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Push the current value from the forward pass to be used at the backward pass</span>

<span class="sd">    This function is for custom gradients. See `UserGrad` for details on how to provide custom</span>
<span class="sd">    gradients.</span>

<span class="sd">    You may imagine there is a virtual stack for each variable. Each time you call `x_handle =</span>
<span class="sd">    push_for_backward(x)` in the forward pass, the value of `x` **at the current iteration**</span>
<span class="sd">    will be &quot;pushed&quot; to the virtual stack. You can access `x_handle` at the backward pass. Each</span>
<span class="sd">    time you access `x_handle`, you will &quot;pop&quot; the stack and get the value of `x` **pushed at</span>
<span class="sd">    the same iteration**. Since the &quot;stack&quot; is virtual, you do NOT need to &quot;pop&quot; the same count</span>
<span class="sd">    as &quot;push&quot;es: the version numbering is fully automatic. Besides, there may not be a real</span>
<span class="sd">    stack at runtime: it can be compiled to any data structure.</span>

<span class="sd">    This function will be staged to `mark_version` statement in the IR.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">VersionMarker</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="freetensor.core.func" class="doc doc-heading">
          <code>func</code>


<a href="#freetensor.core.func" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="freetensor.core.func.Func" class="doc doc-heading">
        <code>Func</code>


<a href="#freetensor.core.func.Func" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="freetensor_ffi">ffi</span>.<span title="freetensor_ffi.Func">Func</span></code></p>



        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/func.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Func</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">Func</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">params</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">FuncParam</span><span class="p">],</span>
                 <span class="n">returns</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">FuncRet</span><span class="p">],</span>
                 <span class="n">body</span><span class="p">:</span> <span class="n">ffi</span><span class="o">.</span><span class="n">Stmt</span><span class="p">,</span>
                 <span class="n">extra_closure</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">user_grads</span><span class="o">=</span><span class="p">[]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">returns</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">extra_closure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_grads</span> <span class="o">=</span> <span class="n">user_grads</span>

        <span class="c1"># Mimic a Python function</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kvs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Enable invoking a transformed AST in another function being transformed, via</span>
<span class="sd">        `inlined_invoke`</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">in_staging</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">register_inlined_invoke</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kvs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Unexpected call on a transformed AST. A transformed AST can only &#39;</span>
                <span class="s1">&#39;be called in the following two ways: 1) called with actual data &#39;</span>
                <span class="s1">&#39;after `@optimize`, and 2) called from another function to be &#39;</span>
                <span class="s1">&#39;`@transform`ed&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h5 id="freetensor.core.func.Func.__call__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kvs</span><span class="p">)</span></code>

<a href="#freetensor.core.func.Func.__call__" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Enable invoking a transformed AST in another function being transformed, via
<code>inlined_invoke</code></p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/func.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kvs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Enable invoking a transformed AST in another function being transformed, via</span>
<span class="sd">    `inlined_invoke`</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">in_staging</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">register_inlined_invoke</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kvs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">lang_overload</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Unexpected call on a transformed AST. A transformed AST can only &#39;</span>
            <span class="s1">&#39;be called in the following two ways: 1) called with actual data &#39;</span>
            <span class="s1">&#39;after `@optimize`, and 2) called from another function to be &#39;</span>
            <span class="s1">&#39;`@transform`ed&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="freetensor.core.optimize" class="doc doc-heading">
          <code>optimize</code>


<a href="#freetensor.core.optimize" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="freetensor.core.optimize.optimize" class="doc doc-heading">
<code class="highlight language-python"><span class="n">optimize</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schedule_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_dynamic_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.core.optimize.optimize" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>An one-click optimization from Python function to binary executable</p>
<p>Usage:</p>
<pre><code>@optimize
def f(...):
    ...
</code></pre>
<p>It is equivalent to:</p>
<pre><code>@build_binary
@codegen
@lower
@transform
def f(...):
    ...
</code></pre>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>func</code></td>
          <td>
                <code>Python function or AST</code>
          </td>
          <td><p>The user function to optimize. If not specified, a partial function will
be returend, which can be used as a decorator</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>schedule_callback</code></td>
          <td>
                <code><span title="typing.Callable">Callable</span>(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Schedule(s) to apply</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>target</code></td>
          <td>
                <code><span title="freetensor.core.driver.Target">Target</span>(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>The target architecture. You don't have to set target if you set device</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>device</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.driver.Device" href="#freetensor.core.driver.Device">Device</a>(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Where to run the program</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>default_dynamic_range</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the built-in range is replaced with freetensor.dynamic_range.
Defaults to True</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>verbose</code></td>
          <td>
                <code>int(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Verbosity level. Can be 0, 1 or 2</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/optimize.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">schedule_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Schedule</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">target</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Target</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">default_dynamic_range</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    An one-click optimization from Python function to binary executable</span>

<span class="sd">    Usage:</span>

<span class="sd">    ```</span>
<span class="sd">    @optimize</span>
<span class="sd">    def f(...):</span>
<span class="sd">        ...</span>
<span class="sd">    ```</span>

<span class="sd">    It is equivalent to:</span>

<span class="sd">    ```</span>
<span class="sd">    @build_binary</span>
<span class="sd">    @codegen</span>
<span class="sd">    @lower</span>
<span class="sd">    @transform</span>
<span class="sd">    def f(...):</span>
<span class="sd">        ...</span>
<span class="sd">    ```</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func : Python function or AST</span>
<span class="sd">        The user function to optimize. If not specified, a partial function will</span>
<span class="sd">        be returend, which can be used as a decorator</span>
<span class="sd">    schedule_callback : Callable (Optional)</span>
<span class="sd">        Schedule(s) to apply</span>
<span class="sd">    target : Target (Optional)</span>
<span class="sd">        The target architecture. You don&#39;t have to set target if you set device</span>
<span class="sd">    device : Device (Optional)</span>
<span class="sd">        Where to run the program</span>
<span class="sd">    default_dynamic_range : bool</span>
<span class="sd">        If True, the built-in range is replaced with freetensor.dynamic_range.</span>
<span class="sd">        Defaults to True</span>
<span class="sd">    verbose : int (Optional)</span>
<span class="sd">        Verbosity level. Can be 0, 1 or 2</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">target</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="n">ffi</span><span class="o">.</span><span class="n">AST</span><span class="p">):</span>
            <span class="n">ast</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">func</span><span class="p">,</span>
                            <span class="n">default_dynamic_range</span><span class="o">=</span><span class="n">default_dynamic_range</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ast</span> <span class="o">=</span> <span class="n">func</span>
        <span class="n">ast</span> <span class="o">=</span> <span class="n">schedule</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">schedule_callback</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">ast</span> <span class="o">=</span> <span class="n">lower</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">codegen</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">exe</span> <span class="o">=</span> <span class="n">build_binary</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exe</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">optimize</span><span class="p">,</span>
                                 <span class="n">schedule_callback</span><span class="o">=</span><span class="n">schedule_callback</span><span class="p">,</span>
                                 <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
                                 <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
                                 <span class="n">default_dynamic_range</span><span class="o">=</span><span class="n">default_dynamic_range</span><span class="p">,</span>
                                 <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.optimize.optimize_to_pytorch" class="doc doc-heading">
<code class="highlight language-python"><span class="n">optimize_to_pytorch</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tapes</span><span class="o">=</span><span class="n">GradTapeMode</span><span class="o">.</span><span class="n">NoReuseOnly</span><span class="p">,</span> <span class="n">forward_schedule_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backward_schedule_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_dynamic_range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.core.optimize.optimize_to_pytorch" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Compile a FreeTensor function to a PyTorch call, whose gradient can be
recognized by PyTorch</p>
<p>The compiled function will be a typical PyTorch's "function" (rather than
a PyTorch's "module"). Technically, this means it is a wrapper function
around a PyTorch's <code>Function</code>'s <code>apply</code> method</p>
<p>Schedules (if any) must be applied to the forward function and the backward
function separated. For this reason, currently only first-order gradient
is supported</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>func</code></td>
          <td>
                <code>Python function or AST</code>
          </td>
          <td><p>The user function to optimize. If not specified, a partial function will
be returend, which can be used as a decorator</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>tapes</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<span title="typing.Sequence">Sequence</span>, <span title="freetensor_ffi.GradTapeMode">GradTapeMode</span>]</code>
          </td>
          <td><p>Intermediate variables that need to be stored from the forward pass and
reused in the backward pass. This parameter can be a sequence, which contains
VarDef selectors of them. It can also be a <code>GradTapeMode</code>, then it will determine
which intermediate variables to be stored by heuristics. Avail <code>GradTapeMode</code>s
are: All: store all variables including local scalars; None: store nothing;
NoReuseOnly: store variables that only hold one version of data, which means
we do not have to store each version of them in their history</p></td>
          <td>
                <code>GradTapeMode.NoReuseOnly</code>
          </td>
        </tr>
        <tr>
          <td><code>forward_schedule_callback</code></td>
          <td>
                <code><span title="typing.Callable">Callable</span>(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Schedule(s) to apply to the forward function</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>backward_schedule_callback</code></td>
          <td>
                <code><span title="typing.Callable">Callable</span>(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Schedule(s) to apply to the backward function</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>target</code></td>
          <td>
                <code><span title="freetensor.core.driver.Target">Target</span>(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>The target architecture. You don't have to set target if you set device</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>device</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.driver.Device" href="#freetensor.core.driver.Device">Device</a>(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Where to run the program</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>default_dynamic_range</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>If True, the built-in range is replaced with freetensor.dynamic_range.
Defaults to True</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>verbose</code></td>
          <td>
                <code>int(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Verbosity level. Can be 0, 1 or 2</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/optimize.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">optimize_to_pytorch</span><span class="p">(</span>
        <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tapes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">,</span> <span class="n">GradTapeMode</span><span class="p">]</span> <span class="o">=</span> <span class="n">GradTapeMode</span><span class="o">.</span><span class="n">NoReuseOnly</span><span class="p">,</span>
        <span class="n">forward_schedule_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Schedule</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">backward_schedule_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Schedule</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Target</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_dynamic_range</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compile a FreeTensor function to a PyTorch call, whose gradient can be</span>
<span class="sd">    recognized by PyTorch</span>

<span class="sd">    The compiled function will be a typical PyTorch&#39;s &quot;function&quot; (rather than</span>
<span class="sd">    a PyTorch&#39;s &quot;module&quot;). Technically, this means it is a wrapper function</span>
<span class="sd">    around a PyTorch&#39;s `Function`&#39;s `apply` method</span>

<span class="sd">    Schedules (if any) must be applied to the forward function and the backward</span>
<span class="sd">    function separated. For this reason, currently only first-order gradient</span>
<span class="sd">    is supported</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func : Python function or AST</span>
<span class="sd">        The user function to optimize. If not specified, a partial function will</span>
<span class="sd">        be returend, which can be used as a decorator</span>
<span class="sd">    tapes : Union[Sequence, GradTapeMode]</span>
<span class="sd">        Intermediate variables that need to be stored from the forward pass and</span>
<span class="sd">        reused in the backward pass. This parameter can be a sequence, which contains</span>
<span class="sd">        VarDef selectors of them. It can also be a `GradTapeMode`, then it will determine</span>
<span class="sd">        which intermediate variables to be stored by heuristics. Avail `GradTapeMode`s</span>
<span class="sd">        are: All: store all variables including local scalars; None: store nothing;</span>
<span class="sd">        NoReuseOnly: store variables that only hold one version of data, which means</span>
<span class="sd">        we do not have to store each version of them in their history</span>
<span class="sd">    forward_schedule_callback : Callable (Optional)</span>
<span class="sd">        Schedule(s) to apply to the forward function</span>
<span class="sd">    backward_schedule_callback : Callable (Optional)</span>
<span class="sd">        Schedule(s) to apply to the backward function</span>
<span class="sd">    target : Target (Optional)</span>
<span class="sd">        The target architecture. You don&#39;t have to set target if you set device</span>
<span class="sd">    device : Device (Optional)</span>
<span class="sd">        Where to run the program</span>
<span class="sd">    default_dynamic_range : bool</span>
<span class="sd">        If True, the built-in range is replaced with freetensor.dynamic_range.</span>
<span class="sd">        Defaults to True</span>
<span class="sd">    verbose : int (Optional)</span>
<span class="sd">        Verbosity level. Can be 0, 1 or 2</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">torch</span>

        <span class="c1"># Transform from Python source to AST</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="n">ffi</span><span class="o">.</span><span class="n">AST</span><span class="p">):</span>
            <span class="n">ast</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">func</span><span class="p">,</span>
                            <span class="n">default_dynamic_range</span><span class="o">=</span><span class="n">default_dynamic_range</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ast</span> <span class="o">=</span> <span class="n">func</span>

        <span class="c1"># Compile lazily because we know `requires` and `provides` only when</span>
        <span class="c1"># executing. Re-compile when gradient requirements changes</span>
        <span class="n">saved_requires</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">saved_provides</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">cur_requires</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cur_provides</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fwd_exe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">bwd_exe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">input_grad_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">output_grad_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tape_rets</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">lazy_compile</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">saved_requires</span><span class="p">,</span> <span class="n">saved_provides</span><span class="p">,</span> <span class="n">cur_requires</span><span class="p">,</span> <span class="n">cur_provides</span>
            <span class="k">nonlocal</span> <span class="n">fwd_exe</span><span class="p">,</span> <span class="n">bwd_exe</span><span class="p">,</span> <span class="n">input_grad_map</span><span class="p">,</span> <span class="n">output_grad_map</span><span class="p">,</span> <span class="n">tape_rets</span>
            <span class="k">if</span> <span class="n">saved_requires</span> <span class="o">==</span> <span class="n">cur_requires</span> <span class="ow">and</span> <span class="n">saved_provides</span> <span class="o">==</span> <span class="n">cur_provides</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">saved_requires</span> <span class="o">=</span> <span class="n">cur_requires</span>
            <span class="n">saved_provides</span> <span class="o">=</span> <span class="n">cur_provides</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_requires</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fwd_ast</span><span class="p">,</span> <span class="n">bwd_ast</span><span class="p">,</span> <span class="n">input_grad_map</span><span class="p">,</span> <span class="n">output_grad_map</span> <span class="o">=</span> <span class="n">grad</span><span class="p">(</span>
                    <span class="n">ast</span><span class="p">,</span>
                    <span class="n">requires</span><span class="o">=</span><span class="n">saved_requires</span><span class="p">,</span>
                    <span class="n">provides</span><span class="o">=</span><span class="n">saved_provides</span><span class="p">,</span>
                    <span class="n">tapes</span><span class="o">=</span><span class="n">tapes</span><span class="p">,</span>
                    <span class="c1"># PyTorch requires explicitly marking saved states via</span>
                    <span class="c1"># `save_for_backward()`</span>
                    <span class="n">tape_in_closure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">tape_rets</span> <span class="o">=</span> <span class="n">fwd_ast</span><span class="o">.</span><span class="n">returns</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">returns</span><span class="p">):]</span>
                <span class="n">fwd_exe</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">(</span><span class="n">fwd_ast</span><span class="p">,</span> <span class="n">forward_schedule_callback</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
                                   <span class="n">device</span><span class="p">,</span> <span class="n">default_dynamic_range</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="n">bwd_exe</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">(</span><span class="n">bwd_ast</span><span class="p">,</span> <span class="n">backward_schedule_callback</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
                                   <span class="n">device</span><span class="p">,</span> <span class="n">default_dynamic_range</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No one needs grad. No need to do autograd</span>
                <span class="n">fwd_ast</span> <span class="o">=</span> <span class="n">ast</span>
                <span class="n">fwd_exe</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">(</span><span class="n">fwd_ast</span><span class="p">,</span> <span class="n">forward_schedule_callback</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
                                   <span class="n">device</span><span class="p">,</span> <span class="n">default_dynamic_range</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="n">bwd_exe</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">input_grad_map</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">output_grad_map</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">tape_rets</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Generate a PyTorch Function</span>
        <span class="k">class</span> <span class="nc">GeneratedPyTorchFunction</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">Function</span><span class="p">):</span>

            <span class="nd">@staticmethod</span>
            <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kvs</span><span class="p">):</span>
                <span class="k">nonlocal</span> <span class="n">cur_requires</span><span class="p">,</span> <span class="n">cur_provides</span>

                <span class="c1"># We only get to know provided gradients of output tensors when we</span>
                <span class="c1"># run `backward`, but we need to run autograd and compile the program</span>
                <span class="c1"># here in `forward`. We can only assume gradients are provided for</span>
                <span class="c1"># every output tensors, even if they are unrelated to the inputs.</span>
                <span class="c1"># Setting this option to True makes PyTorch generate zero gradient</span>
                <span class="c1"># for such outputs. (TODO: better solution?)</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">set_materialize_grads</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Gather required gradients of the inputs</span>
                <span class="n">cur_requires</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
                        <span class="n">cur_requires</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kvs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
                        <span class="n">cur_requires</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

                <span class="c1"># For the reason above, we assume gradients are provided for every</span>
                <span class="c1"># output tensors</span>
                <span class="n">cur_provides</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">returns</span><span class="p">:</span>
                    <span class="n">cur_provides</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="n">lazy_compile</span><span class="p">()</span>
                <span class="n">fwd_exe</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kvs</span><span class="p">)</span>
                <span class="n">fwd_exe</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
                <span class="n">returns</span> <span class="o">=</span> <span class="n">fwd_exe</span><span class="o">.</span><span class="n">collect_returns</span><span class="p">(</span><span class="n">always_return_pack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">returns</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">torch</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">)</span>

                <span class="c1"># Save states for 1) all inputs and 2) all taped tensors (taped</span>
                <span class="c1"># outputs are also taped tensors). For taped tensors, we need to</span>
                <span class="c1"># make them output tensors, so PyTorch can recognize them. This is</span>
                <span class="c1"># an officially recommanded trick at</span>
                <span class="c1"># https://pytorch.org/tutorials/intermediate/custom_function_double_backward_tutorial.html#saving-intermediate-results</span>
                <span class="c1"># So, please be aware that only the first part in `returns` are real</span>
                <span class="c1"># return tensors</span>
                <span class="n">saved_tensors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>  <span class="c1"># 1)</span>
                    <span class="n">saved_tensors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">returns</span><span class="p">:</span>  <span class="c1"># 2) and maybe other junks</span>
                    <span class="n">saved_tensors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">save_for_backward</span><span class="p">(</span><span class="o">*</span><span class="n">saved_tensors</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">returns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">returns</span>

            <span class="nd">@staticmethod</span>
            <span class="nd">@torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">once_differentiable</span>
            <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kvs</span><span class="p">):</span>
                <span class="n">saved_tensors</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">saved_tensors</span>
                <span class="n">internal_kvs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">ret</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">returns</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
                    <span class="n">internal_kvs</span><span class="p">[</span><span class="n">output_grad_map</span><span class="p">[</span><span class="n">ret</span><span class="o">.</span><span class="n">name</span><span class="p">]]</span> <span class="o">=</span> <span class="n">arg</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kvs</span><span class="p">:</span>
                    <span class="n">internal_kvs</span><span class="p">[</span><span class="n">output_grad_map</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">saved</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">saved_tensors</span><span class="p">):</span>
                    <span class="c1"># NOTE: Now we only support &quot;input&quot; parameters for PyTorch</span>
                    <span class="c1"># interface (no &quot;inout&quot; or &quot;output&quot;), so we can forward all</span>
                    <span class="c1"># parameters. If we support &quot;inout&quot; or &quot;output&quot; in the future,</span>
                    <span class="c1"># we need to filter only &quot;input&quot; parameters here</span>
                    <span class="n">internal_kvs</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">saved</span>
                <span class="k">for</span> <span class="n">tape_ret</span><span class="p">,</span> <span class="n">saved</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="n">tape_rets</span><span class="p">,</span>
                        <span class="n">saved_tensors</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">params</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">returns</span><span class="p">):]):</span>
                    <span class="n">internal_kvs</span><span class="p">[</span><span class="n">tape_ret</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">saved</span>

                <span class="n">bwd_exe</span><span class="o">.</span><span class="n">set_args</span><span class="p">(</span><span class="o">**</span><span class="n">internal_kvs</span><span class="p">)</span>
                <span class="n">bwd_exe</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
                <span class="n">input_grads</span> <span class="o">=</span> <span class="n">bwd_exe</span><span class="o">.</span><span class="n">collect_returns</span><span class="p">(</span><span class="n">always_return_pack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># PyTorch requires returning gradient of inputs in their original</span>
                <span class="c1"># order. If no gradient is required for an input, set it to None</span>
                <span class="n">returns</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">input_grads</span><span class="p">[</span><span class="n">input_grad_map</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">]]</span><span class="o">.</span><span class="n">torch</span><span class="p">(</span>
                <span class="p">)</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">input_grad_map</span> <span class="k">else</span> <span class="kc">None</span>
                                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">returns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">returns</span>

        <span class="c1"># Wrap around the PyTorch `Function`, to be a real Python &quot;function&quot;, and</span>
        <span class="c1"># remove our extra tape outputs</span>
        <span class="k">def</span> <span class="nf">generatedPyTorchFunction</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kvs</span><span class="p">):</span>
            <span class="n">returns</span> <span class="o">=</span> <span class="n">GeneratedPyTorchFunction</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kvs</span><span class="p">)</span>
            <span class="n">returns_tuple</span> <span class="o">=</span> <span class="n">returns</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span>
                                                  <span class="n">Sequence</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">returns</span><span class="p">,)</span>
            <span class="n">returns_tuple</span> <span class="o">=</span> <span class="n">returns_tuple</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">returns</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">returns_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">returns_tuple</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">returns_tuple</span>

        <span class="c1"># If called inside a FreeTensor funcion, don&#39;t care about PyTorch, just</span>
        <span class="c1"># inline the transformed AST</span>
        <span class="k">return</span> <span class="n">staged_callable</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">generatedPyTorchFunction</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">optimize_to_pytorch</span><span class="p">,</span>
            <span class="n">tapes</span><span class="o">=</span><span class="n">tapes</span><span class="p">,</span>
            <span class="n">forward_schedule_callback</span><span class="o">=</span><span class="n">forward_schedule_callback</span><span class="p">,</span>
            <span class="n">backward_schedule_callback</span><span class="o">=</span><span class="n">backward_schedule_callback</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">default_dynamic_range</span><span class="o">=</span><span class="n">default_dynamic_range</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="freetensor.core.passes" class="doc doc-heading">
          <code>passes</code>


<a href="#freetensor.core.passes" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="freetensor.core.passes.lower" class="doc doc-heading">
<code class="highlight language-python"><span class="n">lower</span><span class="p">(</span><span class="n">ast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_passes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.core.passes.lower" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Lower an AST using a series of passes</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>ast</code></td>
          <td>
                <code>AST</code>
          </td>
          <td><p>The AST to be lowered. Can be a <code>Func</code> or a <code>Stmt</code>. If not specified, a
partial function of <code>lower</code> will be returned, which can be used as a
decorator</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>target</code></td>
          <td>
                <code><span title="freetensor.core.driver.Target">Target</span>(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Lower the AST to a target with target-specific passes, then the AST can
be used for codegen. If not set, use the default Target in Config</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>skip_passes</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[str](<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Skip some pass for testing or debugging. Names in <code>skip_passes</code> are in
underscore_style, as in Python. Please note that some passes will not be
skipped even specified in these parameter, because they are indirectly
called in some other passes</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>verbose</code></td>
          <td>
                <code>int(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>0 = print nothing. 1 = print the lowered AST. 2 = print AST after every
single passes</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/passes.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="n">ast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
          <span class="n">target</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ffi</span><span class="o">.</span><span class="n">Target</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">skip_passes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Lower an AST using a series of passes</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ast : AST</span>
<span class="sd">        The AST to be lowered. Can be a `Func` or a `Stmt`. If not specified, a</span>
<span class="sd">        partial function of `lower` will be returned, which can be used as a</span>
<span class="sd">        decorator</span>
<span class="sd">    target : Target (Optional)</span>
<span class="sd">        Lower the AST to a target with target-specific passes, then the AST can</span>
<span class="sd">        be used for codegen. If not set, use the default Target in Config</span>
<span class="sd">    skip_passes : Sequence[str] (Optional)</span>
<span class="sd">        Skip some pass for testing or debugging. Names in `skip_passes` are in</span>
<span class="sd">        underscore_style, as in Python. Please note that some passes will not be</span>
<span class="sd">        skipped even specified in these parameter, because they are indirectly</span>
<span class="sd">        called in some other passes</span>
<span class="sd">    verbose : int (Optional)</span>
<span class="sd">        0 = print nothing. 1 = print the lowered AST. 2 = print AST after every</span>
<span class="sd">        single passes</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">ast</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
                         <span class="nb">set</span><span class="p">()</span> <span class="k">if</span> <span class="n">skip_passes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">set</span><span class="p">(</span><span class="n">skip_passes</span><span class="p">),</span>
                         <span class="mi">0</span> <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_lower</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_lower</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_lower</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">skip_passes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_lower</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_lower</span><span class="p">,</span> <span class="n">skip_passes</span><span class="o">=</span><span class="n">skip_passes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_lower</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_lower</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_lower</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="freetensor.core.staging" class="doc doc-heading">
          <code>staging</code>


<a href="#freetensor.core.staging" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">
  
      <p>A staging framework to support the FreeTensor frontend.</p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="freetensor.core.staging.AllowShortcutScope" class="doc doc-heading">
        <code>AllowShortcutScope</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#freetensor.core.staging.AllowShortcutScope" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">

  
      <p>Allow return scope.
This is a context manager that allows return in statically deterministic control
flow.</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AllowShortcutScope</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Allow return scope.</span>
<span class="sd">    This is a context manager that allows return in statically deterministic control</span>
<span class="sd">    flow.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">overload</span><span class="p">:</span> <span class="n">StagingOverload</span>
    <span class="n">should_allow</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overload</span><span class="o">.</span><span class="n">is_shortcut_allowed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overload</span><span class="o">.</span><span class="n">is_shortcut_allowed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_allow</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_class</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overload</span><span class="o">.</span><span class="n">is_shortcut_allowed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.staging.BreakException" class="doc doc-heading">
        <code>BreakException</code>


<a href="#freetensor.core.staging.BreakException" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code>Exception</code></p>

  
      <p>Exception to be raised by StagingOverload.break_stmt.
Breaks from a for loop.</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">BreakException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Exception to be raised by StagingOverload.break_stmt.</span>
<span class="sd">    Breaks from a for loop.&#39;&#39;&#39;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
        </details>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.staging.ContinueException" class="doc doc-heading">
        <code>ContinueException</code>


<a href="#freetensor.core.staging.ContinueException" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code>Exception</code></p>

  
      <p>Exception to be raised by StagingOverload.continue_stmt.
Continues a for loop.</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ContinueException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Exception to be raised by StagingOverload.continue_stmt.</span>
<span class="sd">    Continues a for loop.&#39;&#39;&#39;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
        </details>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.staging.ReturnException" class="doc doc-heading">
        <code>ReturnException</code>


<a href="#freetensor.core.staging.ReturnException" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code>Exception</code></p>

  
      <p>Exception to be raised by StagingOverload.return_stmt.
Holds a return value that will be passed through to the function wrapper.</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ReturnException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Exception to be raised by StagingOverload.return_stmt.</span>
<span class="sd">    Holds a return value that will be passed through to the function wrapper.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.staging.StagingError" class="doc doc-heading">
        <code>StagingError</code>


<a href="#freetensor.core.staging.StagingError" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code>Exception</code></p>

  
      <p>Error occurred during staging function execution (i.e. IR tree generation).</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">StagingError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Error occurred during staging function execution (i.e. IR tree generation).&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overload</span><span class="p">:</span> <span class="n">StagingOverload</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO: add output of StagingContext.call_stack</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_list</span><span class="p">(</span><span class="n">overload</span><span class="o">.</span><span class="n">debug_call_stack</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.staging.StagingOverload" class="doc doc-heading">
        <code>StagingOverload</code>


<a href="#freetensor.core.staging.StagingOverload" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">



        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">StagingOverload</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_shortcut_allowed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_call_stack</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">traceback</span><span class="o">.</span><span class="n">FrameSummary</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">custom_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Customized attribute accessor.</span>

<span class="sd">        The framework first looks for a Python native attribute. If not found, it looks</span>
<span class="sd">        for this overloaded custom attribute resolver.</span>

<span class="sd">        The default implementation provides no custom attribute.</span>
<span class="sd">        Can be overridden by subclasses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obj : Any</span>
<span class="sd">            Object to access attribute.</span>
<span class="sd">        attr : str</span>
<span class="sd">            Attribute name.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Any :</span>
<span class="sd">            The attribute value.</span>

<span class="sd">        Throws</span>
<span class="sd">        ------</span>
<span class="sd">        AttributeError :</span>
<span class="sd">            If the attribute is not found.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Metadata handler.</span>

<span class="sd">        A metadata line is a comment starting with `#! ` and followed by a metadata,</span>
<span class="sd">        represented as a string parameter.</span>

<span class="sd">        Defaults to a no-op.</span>
<span class="sd">        Can be overridden by subclasses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        content : str</span>
<span class="sd">            The metadata content.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">at_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Code position handler.</span>

<span class="sd">        Defaults to a no-op.</span>
<span class="sd">        Can be overridden by subclasses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Name of the file containing code for the next statement.</span>
<span class="sd">        lineno : int</span>
<span class="sd">            Line number of the next statement.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">StagingError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">allow_shortcut_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allow</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Opens a scope that allows shortcut control flows in a statically deterministic</span>
<span class="sd">        context. Need to be closed by `with` statement.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">AllowShortcutScope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allow</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">foreach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="nb">iter</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Customized foreach wrapper.</span>
<span class="sd">        If `value` is instance of `StagedIterable`, its regarded as a customized foreach</span>
<span class="sd">        behavior and used to generate code for the python for loop.</span>
<span class="sd">        Otherwise, we try to execute the loop as usual.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span> <span class="n">StagedIterable</span><span class="p">):</span>
            <span class="nb">iter</span><span class="o">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iter_var</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">body</span><span class="p">(</span><span class="n">iter_var</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">BreakException</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="n">ContinueException</span><span class="p">:</span>
                    <span class="k">continue</span>

    <span class="k">def</span> <span class="nf">unpack_assign_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Customized assign wrapper for one or more targets.</span>

<span class="sd">        If `values` is instance of `StagedUnpackAssignable`, it&#39;s regarded as a customized</span>
<span class="sd">        assign behavior and gets executed with all the assigned targets&#39; names. Otherwise,</span>
<span class="sd">        it calls `assign_stmt` with each sub-assignments.</span>

<span class="sd">        Please note that `names` can be nested tuples like `(&quot;a&quot;, (&quot;b&quot;, &quot;c&quot;))`.</span>

<span class="sd">        Please also note that `names` can also be a single string like &quot;a&quot; even if `values`</span>
<span class="sd">        is a tuple. There is no unpacking in this case</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">StagedUnpackAssignable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">values</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_stmt</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Number of return values does not match when unpacking&quot;</span><span class="p">)</span>
            <span class="n">returns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
                <span class="n">returns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unpack_assign_stmt</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">assign_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Customized assign wrapper.</span>
<span class="sd">        If `value` is instance of `StagedAssignable`, it&#39;s regarded as a customized</span>
<span class="sd">        assign behavior and gets executed with the assigned target variable name.</span>
<span class="sd">        This wrapper is used for initializing a variable.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">StagedAssignable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">if_then_else_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">then_body</span><span class="p">,</span> <span class="n">else_body</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;If-then-else statement staging tool.</span>
<span class="sd">        When predicate is deterministic in staging, only one branch is generated.</span>
<span class="sd">        Otherwise, a If node in IR is generated.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">StagedPredicate</span><span class="p">):</span>
            <span class="n">predicate</span><span class="o">.</span><span class="n">if_then_else_stmt</span><span class="p">(</span><span class="n">then_body</span><span class="p">,</span> <span class="n">else_body</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">predicate</span><span class="p">:</span>
                <span class="n">then_body</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">else_body</span><span class="p">:</span>
                <span class="n">else_body</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">if_then_else_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">then_expr</span><span class="p">,</span> <span class="n">else_expr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;If-then-else expression staging tool.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">StagedPredicate</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">predicate</span><span class="o">.</span><span class="n">if_then_else_expr</span><span class="p">(</span><span class="n">then_expr</span><span class="p">,</span> <span class="n">else_expr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">predicate</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">then_expr</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">else_expr</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">while_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpred</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;While statement staging tool.&#39;&#39;&#39;</span>
        <span class="n">first_pred</span> <span class="o">=</span> <span class="n">fpred</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_pred</span><span class="p">,</span> <span class="n">StagedPredicate</span><span class="p">):</span>
            <span class="n">first_pred</span><span class="o">.</span><span class="n">while_stmt</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">first_pred</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">body</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">BreakException</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="n">ContinueException</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">while</span> <span class="n">fpred</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">body</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">BreakException</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="n">ContinueException</span><span class="p">:</span>
                    <span class="k">continue</span>

    <span class="k">def</span> <span class="nf">assert_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Assert staging tool.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">StagedPredicate</span><span class="p">):</span>
            <span class="n">test</span><span class="o">.</span><span class="n">assert_stmt</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">test</span>

    <span class="k">def</span> <span class="nf">return_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">funcname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Return staging tool. Only allow return in static control flow.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shortcut_allowed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Return is only allowed in statically deterministic control flow.&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">StagedUnpackAssignable</span><span class="p">):</span>
            <span class="c1"># We don&#39;t know how many items are there, so no unpacking</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">funcname</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">StagedAssignable</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">funcname</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ReturnException</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">break_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Break staging tool. Only allow break in static control flow.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shortcut_allowed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Break is only allowed in statically deterministic control flow.&#39;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="n">BreakException</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">continue_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Continue staging tool. Only allow continue in static control flow.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shortcut_allowed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Continue is only allowed in statically deterministic control flow.&#39;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="n">ContinueException</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Load attribute staging tool. Allows customization of reading attributes.&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Have to use AttributeError again, since a custom attribute might have</span>
                <span class="c1"># a None value</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="n">successful</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">successful</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">successful</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">and_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">lazy_args</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">reducer</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fb</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">StagedPredicate</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">fb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This is not a simple logical and; it&#39;s equivalent to a if-then-else.</span>
                <span class="c1"># Thus, if a is True, fb() is returned, preserving the original value,</span>
                <span class="c1"># which might be a StagedPredicate.</span>
                <span class="k">return</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">fb</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">reducer</span><span class="p">,</span> <span class="n">lazy_args</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">or_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">lazy_args</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">reducer</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fb</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">StagedPredicate</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">fb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">a</span> <span class="ow">or</span> <span class="n">fb</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">reducer</span><span class="p">,</span> <span class="n">lazy_args</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">not_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">StagedPredicate</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">arg</span><span class="o">.</span><span class="n">logical_not</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="n">arg</span>

    <span class="k">def</span> <span class="nf">functiondef_decorator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">functiondef_wrapper</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">functiondef_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Function definition wrapper.</span>
<span class="sd">        This wrapper performs extra initialization and cleanup for function definition.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Push debug call stack with some random line number.</span>
            <span class="c1"># It will be updated by `mark_position` calls in the function.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug_call_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">FrameSummary</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="c1"># The called function can now return from itself, despite what the outer</span>
            <span class="c1"># control flow is.</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_shortcut_scope</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">ReturnException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># No return_stmt was called, naturally returns None</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Pop debug call stack.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug_call_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">wrapped</span>

    <span class="k">def</span> <span class="nf">annotate_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ty</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">StagedTypeAnnotation</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ty</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">mark_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># FrameSummary is immutable, so we have to initialize a new one with updated</span>
        <span class="c1"># line number.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_call_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">FrameSummary</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug_call_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug_call_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">at_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_call_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">debug_call_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">into_staging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">func</span><span class="p">,</span>
                     <span class="n">extra_locals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">src</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">extra_locals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_locals</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">src</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">ins</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="n">src</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">ins</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;staging:</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&gt;&#39;</span>

        <span class="c1"># Inject overload to extra_locals.</span>
        <span class="n">extra_locals</span><span class="p">[</span><span class="s1">&#39;__staging_overload__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># To transform a function, except essential AST transformation, we have to pass</span>
        <span class="c1"># the globals and locals (actually captured outer local variables) to the</span>
        <span class="c1"># transformed function properly.</span>
        <span class="c1"># Note that:</span>
        <span class="c1"># 1. We have to pass both globals and locals to `exec`.</span>
        <span class="c1"># 2. We cannot insert locals to the globals `dict`, otherwise it will pollute</span>
        <span class="c1">#    the globals `dict`.</span>
        <span class="c1"># 3. We cannot copy the globals `dict` before passing it to exec, otherwise the</span>
        <span class="c1">#    staged function cannot write to globals and get later updates in the global.</span>
        <span class="c1"># Thus, we have to pass the globals and locals to the transformed function</span>
        <span class="c1"># separately.</span>

        <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__closure__</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__closure__</span><span class="p">)</span>
            <span class="n">func_locals</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">name</span><span class="p">:</span> <span class="n">cell</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span>
                                                 <span class="n">func</span><span class="o">.</span><span class="vm">__closure__</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func_locals</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Translate `#! ` comments to metadata calls.</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">process_annotating_comments</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="c1"># Wrap the code if it has a indentation.</span>
        <span class="k">if</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span> <span class="ow">or</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="s1">&#39;if True:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">src</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">)</span>
            <span class="c1"># Replace with the real body to eliminate the faked if.</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span>
            <span class="c1"># Modify lineno to match with the location.</span>
            <span class="n">lineno</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="c1"># Replace the annotations with __staging_annotations__</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span>
        <span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">ReplaceAnnotations</span><span class="p">(</span>
            <span class="n">func</span><span class="o">.</span><span class="vm">__annotations__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">Transformer</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="c1"># Instead of passing the `func_local` directly to `exec`, we instead wrap the</span>
        <span class="c1"># staging function. This is to workaround an issue of CPython. (See</span>
        <span class="c1"># https://github.com/python/cpython/issues/86084).</span>

        <span class="c1"># The sketch is:</span>
        <span class="c1"># ```</span>
        <span class="c1"># def __freetensor_staging_wrapper__(__freetensor_extra_locals__,</span>
        <span class="c1">#                                    __freetensor_local_cells__):</span>
        <span class="c1">#     some_extra_local = __freetensor_extra_locals__[&#39;some_extra_local&#39;]</span>
        <span class="c1">#     some_captured = None</span>
        <span class="c1">#</span>
        <span class="c1">#     def original_func():</span>
        <span class="c1">#         nonlocal some_captured</span>
        <span class="c1">#         some_captured = __freetensor_local_cells__.some_captured</span>
        <span class="c1">#         try:</span>
        <span class="c1">#             ...  # original function body</span>
        <span class="c1">#         finally:</span>
        <span class="c1">#             __freetensor_local_cells__.some_captured = some_captured</span>
        <span class="c1">#</span>
        <span class="c1">#     return original_func</span>
        <span class="c1"># ```</span>
        <span class="c1"># Note that `__freetensor_local_cells__` is a `LocalsDictWrapper` object.</span>
        <span class="c1"># It in-turn accesses cell.cell_contents to get/set the value of the local</span>
        <span class="c1"># variable.</span>
        <span class="c1"># The `LocalsDictWrapper` is a helper class to reduce code generation complexity.</span>

        <span class="n">WRAPPER_NAME</span> <span class="o">=</span> <span class="s1">&#39;__freetensor_staging_wrapper__&#39;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span>

        <span class="c1"># Modify function body.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">func_locals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">([</span>
                <span class="c1"># Declare them as nonlocals to assign to outer scope.</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">Nonlocal</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">func_locals</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span>
            <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                <span class="c1"># Fetch latest values of the closure variables.</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">([</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">())],</span>
                           <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span>
                               <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;__freetensor_local_cells__&#39;</span><span class="p">,</span>
                                        <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span> <span class="n">name</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()))</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">func_locals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                <span class="c1"># Use a try-finally to ensure closure write back.</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">Try</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
                        <span class="n">handlers</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">orelse</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">finalbody</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">([</span>
                                <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span>
                                    <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;__freetensor_local_cells__&#39;</span><span class="p">,</span>
                                             <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span> <span class="n">name</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">())</span>
                            <span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()))</span>
                            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">func_locals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="p">])</span>
            <span class="p">])</span>
        <span class="n">tree</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">WRAPPER_NAME</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="n">posonlyargs</span><span class="o">=</span><span class="p">[],</span>
                                   <span class="n">args</span><span class="o">=</span><span class="p">[</span>
                                       <span class="n">ast</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="s1">&#39;__freetensor_extra_locals__&#39;</span><span class="p">,</span>
                                               <span class="kc">None</span><span class="p">),</span>
                                       <span class="n">ast</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="s1">&#39;__freetensor_local_cells__&#39;</span><span class="p">,</span>
                                               <span class="kc">None</span><span class="p">),</span>
                                       <span class="n">ast</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="s1">&#39;__staging_annotations__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                                   <span class="p">],</span>
                                   <span class="n">vararg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">kwonlyargs</span><span class="o">=</span><span class="p">[],</span>
                                   <span class="n">kw_defaults</span><span class="o">=</span><span class="p">[],</span>
                                   <span class="n">kwarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">defaults</span><span class="o">=</span><span class="p">[]),</span>
                <span class="n">body</span><span class="o">=</span><span class="p">[</span>
                    <span class="c1"># Captured closure variables are not fetched here, only declared.</span>
                    <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">([</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">())],</span>
                               <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">func_locals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                    <span class="c1"># Extra locals are fetched here.</span>
                    <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">([</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">())],</span>
                               <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">(</span>
                                   <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;__freetensor_extra_locals__&#39;</span><span class="p">,</span>
                                            <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
                                   <span class="n">ast_index</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">name</span><span class="p">)),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()))</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">extra_locals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">]</span> <span class="o">+</span> <span class="n">tree</span><span class="o">.</span><span class="n">body</span> <span class="o">+</span>
                <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()))],</span>
                <span class="n">decorator_list</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">returns</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">fix_missing_locations</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">astor</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">astor</span><span class="o">.</span><span class="n">to_source</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">():</span>
                <span class="kn">from</span> <span class="nn">pygments</span> <span class="kn">import</span> <span class="n">highlight</span>
                <span class="kn">from</span> <span class="nn">pygments.lexers</span> <span class="kn">import</span> <span class="n">PythonLexer</span>
                <span class="kn">from</span> <span class="nn">pygments.formatters</span> <span class="kn">import</span> <span class="n">TerminalFormatter</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">highlight</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">PythonLexer</span><span class="p">(),</span>
                                <span class="n">TerminalFormatter</span><span class="p">(</span><span class="n">bg</span><span class="o">=</span><span class="s1">&#39;dark&#39;</span><span class="p">,</span> <span class="n">linenos</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
                      <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

            <span class="n">tree</span> <span class="o">=</span> <span class="n">source</span>  <span class="c1"># make debug info match dumped source</span>

        <span class="c1"># Create an empty locals dict to avoid polluting the original globals.</span>
        <span class="n">empty_locals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">exec</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;&lt;staging:</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">),</span>
             <span class="n">func</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">,</span> <span class="n">empty_locals</span><span class="p">)</span>
        <span class="n">f_wrapper</span> <span class="o">=</span> <span class="n">empty_locals</span><span class="p">[</span><span class="n">WRAPPER_NAME</span><span class="p">]</span>
        <span class="c1"># Pass the closure to the wrapper and retrieve the staging function with</span>
        <span class="c1"># correct captured variables.</span>
        <span class="n">f_staging</span> <span class="o">=</span> <span class="n">f_wrapper</span><span class="p">(</span><span class="n">extra_locals</span><span class="p">,</span> <span class="n">LocalsDictWrapper</span><span class="p">(</span><span class="n">func_locals</span><span class="p">),</span>
                              <span class="n">func</span><span class="o">.</span><span class="vm">__annotations__</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f_staging</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.allow_shortcut_scope" class="doc doc-heading">
<code class="highlight language-python"><span class="n">allow_shortcut_scope</span><span class="p">(</span><span class="n">allow</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.StagingOverload.allow_shortcut_scope" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Opens a scope that allows shortcut control flows in a statically deterministic
context. Need to be closed by <code>with</code> statement.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">allow_shortcut_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allow</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Opens a scope that allows shortcut control flows in a statically deterministic</span>
<span class="sd">    context. Need to be closed by `with` statement.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">AllowShortcutScope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allow</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.assert_stmt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">assert_stmt</span><span class="p">(</span><span class="n">test</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.StagingOverload.assert_stmt" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Assert staging tool.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">assert_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Assert staging tool.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">StagedPredicate</span><span class="p">):</span>
        <span class="n">test</span><span class="o">.</span><span class="n">assert_stmt</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">test</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.assign_stmt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">assign_stmt</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.StagingOverload.assign_stmt" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Customized assign wrapper.
If <code>value</code> is instance of <code>StagedAssignable</code>, it's regarded as a customized
assign behavior and gets executed with the assigned target variable name.
This wrapper is used for initializing a variable.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">assign_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Customized assign wrapper.</span>
<span class="sd">    If `value` is instance of `StagedAssignable`, it&#39;s regarded as a customized</span>
<span class="sd">    assign behavior and gets executed with the assigned target variable name.</span>
<span class="sd">    This wrapper is used for initializing a variable.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">StagedAssignable</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.at_position" class="doc doc-heading">
<code class="highlight language-python"><span class="n">at_position</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.StagingOverload.at_position" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Code position handler.</p>
<p>Defaults to a no-op.
Can be overridden by subclasses.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>filename</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Name of the file containing code for the next statement.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>lineno</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Line number of the next statement.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">at_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lineno</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Code position handler.</span>

<span class="sd">    Defaults to a no-op.</span>
<span class="sd">    Can be overridden by subclasses.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Name of the file containing code for the next statement.</span>
<span class="sd">    lineno : int</span>
<span class="sd">        Line number of the next statement.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.break_stmt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">break_stmt</span><span class="p">()</span></code>

<a href="#freetensor.core.staging.StagingOverload.break_stmt" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Break staging tool. Only allow break in static control flow.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">break_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Break staging tool. Only allow break in static control flow.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shortcut_allowed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Break is only allowed in statically deterministic control flow.&#39;</span>
        <span class="p">)</span>
    <span class="k">raise</span> <span class="n">BreakException</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.continue_stmt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">continue_stmt</span><span class="p">()</span></code>

<a href="#freetensor.core.staging.StagingOverload.continue_stmt" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Continue staging tool. Only allow continue in static control flow.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">continue_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Continue staging tool. Only allow continue in static control flow.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shortcut_allowed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Continue is only allowed in statically deterministic control flow.&#39;</span>
        <span class="p">)</span>
    <span class="k">raise</span> <span class="n">ContinueException</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.custom_attr" class="doc doc-heading">
<code class="highlight language-python"><span class="n">custom_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.StagingOverload.custom_attr" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Customized attribute accessor.</p>
<p>The framework first looks for a Python native attribute. If not found, it looks
for this overloaded custom attribute resolver.</p>
<p>The default implementation provides no custom attribute.
Can be overridden by subclasses.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>obj</code></td>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>Object to access attribute.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>attr</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Attribute name.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>Any</code></td>          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>The attribute value.</p></td>
        </tr>
    </tbody>
  </table>
      <h6 id="freetensor.core.staging.StagingOverload.custom_attr--throws">Throws<a class="headerlink" href="#freetensor.core.staging.StagingOverload.custom_attr--throws" title="Permanent link">&para;</a></h6>
<p>AttributeError :
    If the attribute is not found.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">custom_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Customized attribute accessor.</span>

<span class="sd">    The framework first looks for a Python native attribute. If not found, it looks</span>
<span class="sd">    for this overloaded custom attribute resolver.</span>

<span class="sd">    The default implementation provides no custom attribute.</span>
<span class="sd">    Can be overridden by subclasses.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : Any</span>
<span class="sd">        Object to access attribute.</span>
<span class="sd">    attr : str</span>
<span class="sd">        Attribute name.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Any :</span>
<span class="sd">        The attribute value.</span>

<span class="sd">    Throws</span>
<span class="sd">    ------</span>
<span class="sd">    AttributeError :</span>
<span class="sd">        If the attribute is not found.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.foreach" class="doc doc-heading">
<code class="highlight language-python"><span class="n">foreach</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">iter</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.StagingOverload.foreach" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Customized foreach wrapper.
If <code>value</code> is instance of <code>StagedIterable</code>, its regarded as a customized foreach
behavior and used to generate code for the python for loop.
Otherwise, we try to execute the loop as usual.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">foreach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="nb">iter</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Customized foreach wrapper.</span>
<span class="sd">    If `value` is instance of `StagedIterable`, its regarded as a customized foreach</span>
<span class="sd">    behavior and used to generate code for the python for loop.</span>
<span class="sd">    Otherwise, we try to execute the loop as usual.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span> <span class="n">StagedIterable</span><span class="p">):</span>
        <span class="nb">iter</span><span class="o">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">iter_var</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">body</span><span class="p">(</span><span class="n">iter_var</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">BreakException</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">ContinueException</span><span class="p">:</span>
                <span class="k">continue</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.functiondef_wrapper" class="doc doc-heading">
<code class="highlight language-python"><span class="n">functiondef_wrapper</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.StagingOverload.functiondef_wrapper" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Function definition wrapper.
This wrapper performs extra initialization and cleanup for function definition.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">functiondef_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function definition wrapper.</span>
<span class="sd">    This wrapper performs extra initialization and cleanup for function definition.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Push debug call stack with some random line number.</span>
        <span class="c1"># It will be updated by `mark_position` calls in the function.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_call_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">FrameSummary</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="c1"># The called function can now return from itself, despite what the outer</span>
        <span class="c1"># control flow is.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_shortcut_scope</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ReturnException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No return_stmt was called, naturally returns None</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Pop debug call stack.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_call_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">return</span> <span class="n">wrapped</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.if_then_else_expr" class="doc doc-heading">
<code class="highlight language-python"><span class="n">if_then_else_expr</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">then_expr</span><span class="p">,</span> <span class="n">else_expr</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.StagingOverload.if_then_else_expr" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>If-then-else expression staging tool.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">if_then_else_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">then_expr</span><span class="p">,</span> <span class="n">else_expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;If-then-else expression staging tool.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">StagedPredicate</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">predicate</span><span class="o">.</span><span class="n">if_then_else_expr</span><span class="p">(</span><span class="n">then_expr</span><span class="p">,</span> <span class="n">else_expr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">predicate</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">then_expr</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">else_expr</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.if_then_else_stmt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">if_then_else_stmt</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">then_body</span><span class="p">,</span> <span class="n">else_body</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.StagingOverload.if_then_else_stmt" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>If-then-else statement staging tool.
When predicate is deterministic in staging, only one branch is generated.
Otherwise, a If node in IR is generated.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">if_then_else_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">then_body</span><span class="p">,</span> <span class="n">else_body</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;If-then-else statement staging tool.</span>
<span class="sd">    When predicate is deterministic in staging, only one branch is generated.</span>
<span class="sd">    Otherwise, a If node in IR is generated.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">StagedPredicate</span><span class="p">):</span>
        <span class="n">predicate</span><span class="o">.</span><span class="n">if_then_else_stmt</span><span class="p">(</span><span class="n">then_body</span><span class="p">,</span> <span class="n">else_body</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">predicate</span><span class="p">:</span>
            <span class="n">then_body</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">else_body</span><span class="p">:</span>
            <span class="n">else_body</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.load_attr" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.StagingOverload.load_attr" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Load attribute staging tool. Allows customization of reading attributes.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Load attribute staging tool. Allows customization of reading attributes.&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Have to use AttributeError again, since a custom attribute might have</span>
            <span class="c1"># a None value</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="n">successful</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">successful</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">successful</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.metadata" class="doc doc-heading">
<code class="highlight language-python"><span class="n">metadata</span><span class="p">(</span><span class="n">content</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.StagingOverload.metadata" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Metadata handler.</p>
<p>A metadata line is a comment starting with <code>#!</code> and followed by a metadata,
represented as a string parameter.</p>
<p>Defaults to a no-op.
Can be overridden by subclasses.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>content</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The metadata content.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Metadata handler.</span>

<span class="sd">    A metadata line is a comment starting with `#! ` and followed by a metadata,</span>
<span class="sd">    represented as a string parameter.</span>

<span class="sd">    Defaults to a no-op.</span>
<span class="sd">    Can be overridden by subclasses.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    content : str</span>
<span class="sd">        The metadata content.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.return_stmt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">return_stmt</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">funcname</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.StagingOverload.return_stmt" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Return staging tool. Only allow return in static control flow.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">return_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">funcname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Return staging tool. Only allow return in static control flow.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shortcut_allowed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Return is only allowed in statically deterministic control flow.&#39;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">StagedUnpackAssignable</span><span class="p">):</span>
        <span class="c1"># We don&#39;t know how many items are there, so no unpacking</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">funcname</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">StagedAssignable</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">funcname</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">ReturnException</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.unpack_assign_stmt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">unpack_assign_stmt</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.StagingOverload.unpack_assign_stmt" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Customized assign wrapper for one or more targets.</p>
<p>If <code>values</code> is instance of <code>StagedUnpackAssignable</code>, it's regarded as a customized
assign behavior and gets executed with all the assigned targets' names. Otherwise,
it calls <code>assign_stmt</code> with each sub-assignments.</p>
<p>Please note that <code>names</code> can be nested tuples like <code>("a", ("b", "c"))</code>.</p>
<p>Please also note that <code>names</code> can also be a single string like "a" even if <code>values</code>
is a tuple. There is no unpacking in this case</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">unpack_assign_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Customized assign wrapper for one or more targets.</span>

<span class="sd">    If `values` is instance of `StagedUnpackAssignable`, it&#39;s regarded as a customized</span>
<span class="sd">    assign behavior and gets executed with all the assigned targets&#39; names. Otherwise,</span>
<span class="sd">    it calls `assign_stmt` with each sub-assignments.</span>

<span class="sd">    Please note that `names` can be nested tuples like `(&quot;a&quot;, (&quot;b&quot;, &quot;c&quot;))`.</span>

<span class="sd">    Please also note that `names` can also be a single string like &quot;a&quot; even if `values`</span>
<span class="sd">    is a tuple. There is no unpacking in this case</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">StagedUnpackAssignable</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">values</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_stmt</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Number of return values does not match when unpacking&quot;</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="n">returns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unpack_assign_stmt</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.StagingOverload.while_stmt" class="doc doc-heading">
<code class="highlight language-python"><span class="n">while_stmt</span><span class="p">(</span><span class="n">fpred</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.StagingOverload.while_stmt" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>While statement staging tool.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">while_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpred</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;While statement staging tool.&#39;&#39;&#39;</span>
    <span class="n">first_pred</span> <span class="o">=</span> <span class="n">fpred</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_pred</span><span class="p">,</span> <span class="n">StagedPredicate</span><span class="p">):</span>
        <span class="n">first_pred</span><span class="o">.</span><span class="n">while_stmt</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">first_pred</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">body</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">BreakException</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="n">ContinueException</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">while</span> <span class="n">fpred</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">body</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">BreakException</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">ContinueException</span><span class="p">:</span>
                <span class="k">continue</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.staging.TransformError" class="doc doc-heading">
        <code>TransformError</code>


<a href="#freetensor.core.staging.TransformError" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code>Exception</code></p>

  
      <p>Error occurred during AST transforming from python function to staging function
that generates IR tree.</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TransformError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Error occurred during AST transforming from python function to staging function</span>
<span class="sd">    that generates IR tree.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">base_lineno</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">error_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;At </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">base_lineno</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">error_node</span><span class="o">.</span><span class="n">lineno</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">    </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.staging.Transformer" class="doc doc-heading">
        <code>Transformer</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#freetensor.core.staging.Transformer" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code>ast.<span title="ast.NodeTransformer">NodeTransformer</span></code></p>



        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Transformer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_lineno</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">curr_func</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nonlocals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">):</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">new_node</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_node</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span>
                    <span class="n">call_helper</span><span class="p">(</span>
                        <span class="n">StagingOverload</span><span class="o">.</span><span class="n">mark_position</span><span class="p">,</span>
                        <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_lineno</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="p">]</span> <span class="o">+</span> <span class="n">new_node</span>
        <span class="k">return</span> <span class="n">new_node</span>

    <span class="k">def</span> <span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Rule:</span>
<span class="sd">        `lhs = rhs` -&gt; `lhs = unpack_assign_stmt(&#39;lhs&#39;, rhs)`</span>
<span class="sd">        `x.lhs = rhs` -&gt; `x.lhs = unpack_assign_stmt(&#39;lhs&#39;, rhs)`</span>
<span class="sd">        `a, (b, c) = (x, (y, z))` -&gt; `a, (b, c) = unpack_assign_stmt((&#39;a&#39;, (&#39;b&#39;, &#39;c&#39;)), (x, (y, z)))`</span>
<span class="sd">        `a = b = c` -&gt; `a = unpack_assign_stmt(&#39;a&#39;, c); b = unpack_assign_stmt(&#39;b&#39;, c)`</span>

<span class="sd">        If `unpack_assign_stmt` is not overloaded, `assign_stmt` will be called for each item</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">UnoverloadableExcept</span><span class="p">(</span><span class="ne">BaseException</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">recursive_get_names</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">):</span>
                <span class="c1"># Unpacking: (a, b) = c</span>
                <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">elts</span><span class="p">:</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recursive_get_names</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UnoverloadableExcept</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">do_visit_assign</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">recursive_get_names</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">([</span><span class="n">targets</span><span class="p">],</span>
                                  <span class="n">call_helper</span><span class="p">(</span>
                                      <span class="n">StagingOverload</span><span class="o">.</span><span class="n">unpack_assign_stmt</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span>
                                      <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">UnoverloadableExcept</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">([</span><span class="n">targets</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># If there are more than one item in `node.targets`, it means multiple</span>
        <span class="c1"># assignments like `a = b = c`. For unpacking like `(a, b) = c`, it</span>
        <span class="c1"># is represented as one tuple as a target item</span>
        <span class="n">new_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="n">new_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">do_visit_assign</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_nodes</span>

    <span class="k">def</span> <span class="nf">handleType_AnnAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">x_str</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">Ty</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">annotation</span>

        <span class="n">intermediate</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;freetensor__annotate__</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">intermediate_store</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">intermediate</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">())</span>
        <span class="n">intermediate_load</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">intermediate</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
        <span class="n">node</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">([</span><span class="n">intermediate_store</span><span class="p">],</span>
                       <span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">annotate_stmt</span><span class="p">,</span> <span class="n">x_str</span><span class="p">,</span> <span class="n">Ty</span><span class="p">)),</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">intermediate_load</span><span class="p">,</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">([</span><span class="n">x</span><span class="p">],</span> <span class="n">intermediate_load</span><span class="p">)],</span> <span class="p">[])</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_AnnAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Rule:</span>
<span class="sd">        `x: Ty` -&gt; ```</span>
<span class="sd">        freetensor__annotate__x = annotate_stmt(&#39;x&#39;, Ty)</span>
<span class="sd">        if freetensor__annotate__x:</span>
<span class="sd">            x = freetensor__annotate__x</span>
<span class="sd">        ```: pure annotation</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleType_AnnAssign</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_For</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">For</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Rule:</span>
<span class="sd">        ```</span>
<span class="sd">        for x in iter:</span>
<span class="sd">            body</span>
<span class="sd">        ```</span>
<span class="sd">        -&gt;</span>
<span class="sd">        ```</span>
<span class="sd">        def for_body(x):</span>
<span class="sd">            body</span>
<span class="sd">        foreach(&#39;x&#39;, iter, for_body)</span>
<span class="sd">        ```&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_node</span><span class="o">.</span><span class="n">orelse</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">NonlocalTransformingScope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">nonlocals</span><span class="p">:</span>
                <span class="c1"># While opening a fake function, For loops initiates an iter name as</span>
                <span class="c1"># well. Need to remove it from the outer nonlocals list to implement</span>
                <span class="c1"># shadowing. Only For loops behaves as such, so handle it specially here.</span>
                <span class="n">nonlocals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nonlocals</span><span class="p">)</span>

                <span class="k">def</span> <span class="nf">recursive_remove_id</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">nonlocals</span><span class="p">:</span>
                            <span class="n">nonlocals</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">elts</span><span class="p">:</span>
                            <span class="n">recursive_remove_id</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

                <span class="n">recursive_remove_id</span><span class="p">(</span><span class="n">old_node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
                <span class="n">nonlocals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nonlocals</span><span class="p">)</span>

                <span class="k">def</span> <span class="nf">recursive_get_names</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">elts</span><span class="p">:</span>
                            <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recursive_get_names</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>

                <span class="n">target_names</span> <span class="o">=</span> <span class="n">recursive_get_names</span><span class="p">(</span><span class="n">old_node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

                <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">For</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
                <span class="n">node</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">function_helper</span><span class="p">(</span><span class="s1">&#39;for_body&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;__item__&#39;</span><span class="p">],</span> <span class="p">[</span>
                        <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">],</span>
                                   <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;__item__&#39;</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()))</span>
                    <span class="p">]</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">nonlocals</span><span class="p">),</span>
                    <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span>
                        <span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">foreach</span><span class="p">,</span>
                                    <span class="n">target_names</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span>
                                    <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;for_body&#39;</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())))</span>
                <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_While</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">While</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Rule:</span>
<span class="sd">        ```</span>
<span class="sd">        while pred:</span>
<span class="sd">            body</span>
<span class="sd">        ```</span>
<span class="sd">        -&gt;</span>
<span class="sd">        ```</span>
<span class="sd">        def while_body():</span>
<span class="sd">            body</span>
<span class="sd">        while_stmt(lambda: pred, while_body)</span>
<span class="sd">        ```&#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="n">NonlocalTransformingScope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">nonlocals</span><span class="p">:</span>
            <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">While</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">function_helper</span><span class="p">(</span><span class="s1">&#39;while_body&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">nonlocals</span><span class="p">),</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span>
                    <span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">while_stmt</span><span class="p">,</span>
                                <span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">_EMPTY_ARGS</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">),</span>
                                <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;while_body&#39;</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())))</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_If</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Rule:</span>
<span class="sd">        ```</span>
<span class="sd">        if pred:</span>
<span class="sd">            body</span>
<span class="sd">        else:</span>
<span class="sd">            orelse</span>
<span class="sd">        ```</span>
<span class="sd">        -&gt;</span>
<span class="sd">        ```</span>
<span class="sd">        def then_body():</span>
<span class="sd">            body</span>
<span class="sd">        def else_body():</span>
<span class="sd">            orelse</span>
<span class="sd">        if_then_else_stmt(pred, then_body, else_body)</span>
<span class="sd">        ```</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">old_node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">NonlocalTransformingScope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">nonlocals</span><span class="p">:</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">function_helper</span><span class="p">(</span><span class="s1">&#39;then_body&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span>
                    <span class="n">z</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">old_node</span><span class="o">.</span><span class="n">body</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span><span class="n">y</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">y</span><span class="p">])</span>
                <span class="p">],</span> <span class="n">nonlocals</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="n">then_body</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;then_body&#39;</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">old_node</span><span class="o">.</span><span class="n">orelse</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">NonlocalTransformingScope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">nonlocals</span><span class="p">:</span>
                <span class="n">new_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">function_helper</span><span class="p">(</span><span class="s1">&#39;else_body&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span>
                        <span class="n">z</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">old_node</span><span class="o">.</span><span class="n">orelse</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span><span class="n">y</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">y</span><span class="p">])</span>
                    <span class="p">],</span> <span class="n">nonlocals</span><span class="p">))</span>
            <span class="n">else_body</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;else_body&#39;</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">else_body</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">new_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span>
                <span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">if_then_else_stmt</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">then_body</span><span class="p">,</span>
                            <span class="n">else_body</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">new_node</span>

    <span class="k">def</span> <span class="nf">visit_IfExp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">IfExp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Rule: `body if test else orelse` -&gt; `if_then_else_expr(test, body, orelse)`&#39;&#39;&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">if_then_else_expr</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">,</span>
                           <span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">_EMPTY_ARGS</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">),</span>
                           <span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">_EMPTY_ARGS</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">prev_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_func</span> <span class="o">=</span> <span class="n">old_node</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># nested functions follow original Python (shitty) scoping,</span>
        <span class="c1"># thus backup the nonlocals stack and prepare a clean one.</span>
        <span class="n">prev_nonlocals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonlocals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonlocals</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="n">NonlocalTransformingScope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># mark arguments as nonlocal</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">old_node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">args</span> <span class="o">+</span> <span class="n">old_node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kwonlyargs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nonlocals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">vararg</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nonlocals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">old_node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">vararg</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kwarg</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nonlocals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">old_node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kwarg</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>

            <span class="c1"># Transform the function body</span>
            <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
            <span class="c1"># Cleanup the decorators</span>
            <span class="n">node</span><span class="o">.</span><span class="n">decorator_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">functiondef_decorator</span><span class="p">,</span>
                            <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
            <span class="p">]</span>

            <span class="n">annotations_dict_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;__staging_annotations__</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">__&#39;</span>
            <span class="c1"># Handle the type annotations</span>
            <span class="n">node</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">stmt</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">posonlyargs</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">args</span>
                <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">annotation</span> <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleType_AnnAssign</span><span class="p">(</span>
                    <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span><span class="p">(</span>
                        <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">()),</span>
                        <span class="n">ast</span><span class="o">.</span><span class="n">Subscript</span><span class="p">(</span>
                            <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">annotations_dict_name</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
                            <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">arg</span><span class="p">),</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">]</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span>

            <span class="n">annotations_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Cleanup annotations; we don&#39;t need them any more</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">vararg</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kwarg</span>
            <span class="p">]</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">posonlyargs</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">args</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">kwonlyargs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">annotations_dict</span><span class="p">[</span><span class="n">arg</span><span class="o">.</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">annotation</span>
                    <span class="n">arg</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Write the annotations_dict</span>
            <span class="n">node</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">annotations_dict_name</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">())],</span>
                    <span class="n">ast</span><span class="o">.</span><span class="n">Dict</span><span class="p">([</span><span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">annotations_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span>
                             <span class="nb">list</span><span class="p">(</span><span class="n">annotations_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))),</span> <span class="n">node</span>
            <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">curr_func</span> <span class="o">=</span> <span class="n">prev_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonlocals</span> <span class="o">=</span> <span class="n">prev_nonlocals</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_Assert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assert</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">assert_stmt</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_BoolOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">And</span><span class="p">):</span>
            <span class="n">libfunc</span> <span class="o">=</span> <span class="n">StagingOverload</span><span class="o">.</span><span class="n">and_expr</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Or</span><span class="p">):</span>
            <span class="n">libfunc</span> <span class="o">=</span> <span class="n">StagingOverload</span><span class="o">.</span><span class="n">or_expr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">call_helper</span><span class="p">(</span><span class="n">libfunc</span><span class="p">,</span>
                           <span class="o">*</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">_EMPTY_ARGS</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_UnaryOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Not</span><span class="p">):</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">not_expr</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">operand</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_Compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Expand multiple comparison into `and` expression.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_node</span><span class="o">.</span><span class="n">comparators</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
        <span class="n">lhs</span> <span class="o">=</span> <span class="n">old_node</span><span class="o">.</span><span class="n">left</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">And</span><span class="p">(),</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old_node</span><span class="o">.</span><span class="n">ops</span><span class="p">,</span> <span class="n">old_node</span><span class="o">.</span><span class="n">comparators</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="p">[</span><span class="n">op</span><span class="p">],</span> <span class="p">[</span><span class="n">rhs</span><span class="p">]))</span>
            <span class="n">lhs</span> <span class="o">=</span> <span class="n">rhs</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;__staging_overload__&#39;</span><span class="p">):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">load_attr</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                   <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_Return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span>
            <span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">return_stmt</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_func</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_Lambda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">NonlocalTransformingScope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_comprehension</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">comprehension</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">NonlocalTransformingScope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">comprehension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span> <span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Store</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nonlocals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_AsyncFunctionDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AsyncFunctionDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">TransformError</span><span class="p">(</span><span class="s1">&#39;Async functions not supported.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">base_lineno</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_ClassDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">ClassDef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">TransformError</span><span class="p">(</span><span class="s1">&#39;Class definitions not supported.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">base_lineno</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Yield</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Yield</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">visit_YieldFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">YieldFrom</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">visit_Break</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Break</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">break_stmt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">visit_Continue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Continue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">continue_stmt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">visit_With</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">With</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">recursive_get_names</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nonlocals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">List</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">elts</span><span class="p">:</span>
                    <span class="n">recursive_get_names</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">optional_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">recursive_get_names</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">optional_vars</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.Transformer.visit_AnnAssign" class="doc doc-heading">
<code class="highlight language-python"><span class="n">visit_AnnAssign</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.Transformer.visit_AnnAssign" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Rule:
<code>x: Ty</code> -&gt; <code>freetensor__annotate__x = annotate_stmt('x', Ty)
if freetensor__annotate__x:
    x = freetensor__annotate__x</code>: pure annotation</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">visit_AnnAssign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Rule:</span>
<span class="sd">    `x: Ty` -&gt; ```</span>
<span class="sd">    freetensor__annotate__x = annotate_stmt(&#39;x&#39;, Ty)</span>
<span class="sd">    if freetensor__annotate__x:</span>
<span class="sd">        x = freetensor__annotate__x</span>
<span class="sd">    ```: pure annotation</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleType_AnnAssign</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">node</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.Transformer.visit_Assign" class="doc doc-heading">
<code class="highlight language-python"><span class="n">visit_Assign</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.Transformer.visit_Assign" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Rule:
<code>lhs = rhs</code> -&gt; <code>lhs = unpack_assign_stmt('lhs', rhs)</code>
<code>x.lhs = rhs</code> -&gt; <code>x.lhs = unpack_assign_stmt('lhs', rhs)</code>
<code>a, (b, c) = (x, (y, z))</code> -&gt; <code>a, (b, c) = unpack_assign_stmt(('a', ('b', 'c')), (x, (y, z)))</code>
<code>a = b = c</code> -&gt; <code>a = unpack_assign_stmt('a', c); b = unpack_assign_stmt('b', c)</code></p>
<p>If <code>unpack_assign_stmt</code> is not overloaded, <code>assign_stmt</code> will be called for each item</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Rule:</span>
<span class="sd">    `lhs = rhs` -&gt; `lhs = unpack_assign_stmt(&#39;lhs&#39;, rhs)`</span>
<span class="sd">    `x.lhs = rhs` -&gt; `x.lhs = unpack_assign_stmt(&#39;lhs&#39;, rhs)`</span>
<span class="sd">    `a, (b, c) = (x, (y, z))` -&gt; `a, (b, c) = unpack_assign_stmt((&#39;a&#39;, (&#39;b&#39;, &#39;c&#39;)), (x, (y, z)))`</span>
<span class="sd">    `a = b = c` -&gt; `a = unpack_assign_stmt(&#39;a&#39;, c); b = unpack_assign_stmt(&#39;b&#39;, c)`</span>

<span class="sd">    If `unpack_assign_stmt` is not overloaded, `assign_stmt` will be called for each item</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">UnoverloadableExcept</span><span class="p">(</span><span class="ne">BaseException</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">recursive_get_names</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">):</span>
            <span class="c1"># Unpacking: (a, b) = c</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">elts</span><span class="p">:</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recursive_get_names</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnoverloadableExcept</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">do_visit_assign</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">recursive_get_names</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">([</span><span class="n">targets</span><span class="p">],</span>
                              <span class="n">call_helper</span><span class="p">(</span>
                                  <span class="n">StagingOverload</span><span class="o">.</span><span class="n">unpack_assign_stmt</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span>
                                  <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">UnoverloadableExcept</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">([</span><span class="n">targets</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># If there are more than one item in `node.targets`, it means multiple</span>
    <span class="c1"># assignments like `a = b = c`. For unpacking like `(a, b) = c`, it</span>
    <span class="c1"># is represented as one tuple as a target item</span>
    <span class="n">new_nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
        <span class="n">new_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">do_visit_assign</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">new_nodes</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.Transformer.visit_Compare" class="doc doc-heading">
<code class="highlight language-python"><span class="n">visit_Compare</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.Transformer.visit_Compare" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Expand multiple comparison into <code>and</code> expression.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">visit_Compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Expand multiple comparison into `and` expression.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_node</span><span class="o">.</span><span class="n">comparators</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
    <span class="n">lhs</span> <span class="o">=</span> <span class="n">old_node</span><span class="o">.</span><span class="n">left</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">And</span><span class="p">(),</span> <span class="p">[])</span>
    <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old_node</span><span class="o">.</span><span class="n">ops</span><span class="p">,</span> <span class="n">old_node</span><span class="o">.</span><span class="n">comparators</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="p">[</span><span class="n">op</span><span class="p">],</span> <span class="p">[</span><span class="n">rhs</span><span class="p">]))</span>
        <span class="n">lhs</span> <span class="o">=</span> <span class="n">rhs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.Transformer.visit_For" class="doc doc-heading">
<code class="highlight language-python"><span class="n">visit_For</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.Transformer.visit_For" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Rule:</p>
<pre><code>for x in iter:
    body
</code></pre>
<p>-&gt;</p>
<pre><code>def for_body(x):
    body
foreach('x', iter, for_body)
</code></pre>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">visit_For</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">For</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Rule:</span>
<span class="sd">    ```</span>
<span class="sd">    for x in iter:</span>
<span class="sd">        body</span>
<span class="sd">    ```</span>
<span class="sd">    -&gt;</span>
<span class="sd">    ```</span>
<span class="sd">    def for_body(x):</span>
<span class="sd">        body</span>
<span class="sd">    foreach(&#39;x&#39;, iter, for_body)</span>
<span class="sd">    ```&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_node</span><span class="o">.</span><span class="n">orelse</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">NonlocalTransformingScope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">nonlocals</span><span class="p">:</span>
            <span class="c1"># While opening a fake function, For loops initiates an iter name as</span>
            <span class="c1"># well. Need to remove it from the outer nonlocals list to implement</span>
            <span class="c1"># shadowing. Only For loops behaves as such, so handle it specially here.</span>
            <span class="n">nonlocals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nonlocals</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">recursive_remove_id</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">nonlocals</span><span class="p">:</span>
                        <span class="n">nonlocals</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">elts</span><span class="p">:</span>
                        <span class="n">recursive_remove_id</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

            <span class="n">recursive_remove_id</span><span class="p">(</span><span class="n">old_node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
            <span class="n">nonlocals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nonlocals</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">recursive_get_names</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">elts</span><span class="p">:</span>
                        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recursive_get_names</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>

            <span class="n">target_names</span> <span class="o">=</span> <span class="n">recursive_get_names</span><span class="p">(</span><span class="n">old_node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

            <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">For</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">function_helper</span><span class="p">(</span><span class="s1">&#39;for_body&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;__item__&#39;</span><span class="p">],</span> <span class="p">[</span>
                    <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">],</span>
                               <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;__item__&#39;</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()))</span>
                <span class="p">]</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">nonlocals</span><span class="p">),</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span>
                    <span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">foreach</span><span class="p">,</span>
                                <span class="n">target_names</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span>
                                <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;for_body&#39;</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())))</span>
            <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">node</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.Transformer.visit_If" class="doc doc-heading">
<code class="highlight language-python"><span class="n">visit_If</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.Transformer.visit_If" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Rule:</p>
<pre><code>if pred:
    body
else:
    orelse
</code></pre>
<p>-&gt;</p>
<pre><code>def then_body():
    body
def else_body():
    orelse
if_then_else_stmt(pred, then_body, else_body)
</code></pre>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">visit_If</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Rule:</span>
<span class="sd">    ```</span>
<span class="sd">    if pred:</span>
<span class="sd">        body</span>
<span class="sd">    else:</span>
<span class="sd">        orelse</span>
<span class="sd">    ```</span>
<span class="sd">    -&gt;</span>
<span class="sd">    ```</span>
<span class="sd">    def then_body():</span>
<span class="sd">        body</span>
<span class="sd">    def else_body():</span>
<span class="sd">        orelse</span>
<span class="sd">    if_then_else_stmt(pred, then_body, else_body)</span>
<span class="sd">    ```</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">old_node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">NonlocalTransformingScope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">nonlocals</span><span class="p">:</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">function_helper</span><span class="p">(</span><span class="s1">&#39;then_body&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span>
                <span class="n">z</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">old_node</span><span class="o">.</span><span class="n">body</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span><span class="n">y</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">y</span><span class="p">])</span>
            <span class="p">],</span> <span class="n">nonlocals</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="n">then_body</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;then_body&#39;</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">old_node</span><span class="o">.</span><span class="n">orelse</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">NonlocalTransformingScope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">nonlocals</span><span class="p">:</span>
            <span class="n">new_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">function_helper</span><span class="p">(</span><span class="s1">&#39;else_body&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span>
                    <span class="n">z</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">old_node</span><span class="o">.</span><span class="n">orelse</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span><span class="n">y</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">y</span><span class="p">])</span>
                <span class="p">],</span> <span class="n">nonlocals</span><span class="p">))</span>
        <span class="n">else_body</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;else_body&#39;</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">else_body</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">new_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span>
            <span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">if_then_else_stmt</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">then_body</span><span class="p">,</span>
                        <span class="n">else_body</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">new_node</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.Transformer.visit_IfExp" class="doc doc-heading">
<code class="highlight language-python"><span class="n">visit_IfExp</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.Transformer.visit_IfExp" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Rule: <code>body if test else orelse</code> -&gt; <code>if_then_else_expr(test, body, orelse)</code></p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">visit_IfExp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">IfExp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Rule: `body if test else orelse` -&gt; `if_then_else_expr(test, body, orelse)`&#39;&#39;&#39;</span>
    <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">if_then_else_expr</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">,</span>
                       <span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">_EMPTY_ARGS</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">),</span>
                       <span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">_EMPTY_ARGS</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">orelse</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">node</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h5 id="freetensor.core.staging.Transformer.visit_While" class="doc doc-heading">
<code class="highlight language-python"><span class="n">visit_While</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.Transformer.visit_While" class="headerlink" title="Permanent link">&para;</a></h5>


  <div class="doc doc-contents ">
  
      <p>Rule:</p>
<pre><code>while pred:
    body
</code></pre>
<p>-&gt;</p>
<pre><code>def while_body():
    body
while_stmt(lambda: pred, while_body)
</code></pre>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">visit_While</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">While</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Rule:</span>
<span class="sd">    ```</span>
<span class="sd">    while pred:</span>
<span class="sd">        body</span>
<span class="sd">    ```</span>
<span class="sd">    -&gt;</span>
<span class="sd">    ```</span>
<span class="sd">    def while_body():</span>
<span class="sd">        body</span>
<span class="sd">    while_stmt(lambda: pred, while_body)</span>
<span class="sd">    ```&#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="n">NonlocalTransformingScope</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">nonlocals</span><span class="p">:</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">While</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">old_node</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">function_helper</span><span class="p">(</span><span class="s1">&#39;while_body&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">nonlocals</span><span class="p">),</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span>
                <span class="n">call_helper</span><span class="p">(</span><span class="n">StagingOverload</span><span class="o">.</span><span class="n">while_stmt</span><span class="p">,</span>
                            <span class="n">ast</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">_EMPTY_ARGS</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">),</span>
                            <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;while_body&#39;</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">())))</span>
        <span class="p">]</span>
    <span class="k">return</span> <span class="n">node</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h4 id="freetensor.core.staging.call_helper" class="doc doc-heading">
<code class="highlight language-python"><span class="n">call_helper</span><span class="p">(</span><span class="n">callee</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.call_helper" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Call helper that generates a python AST Call node with given callee (overload
member) and arguments AST node.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">call_helper</span><span class="p">(</span><span class="n">callee</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Call helper that generates a python AST Call node with given callee (overload</span>
<span class="sd">    member) and arguments AST node.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;__staging_overload__&#39;</span><span class="p">,</span>
                               <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span> <span class="n">callee</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Load</span><span class="p">()),</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">keyword</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.staging.function_helper" class="doc doc-heading">
<code class="highlight language-python"><span class="n">function_helper</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">nonlocals</span><span class="p">)</span></code>

<a href="#freetensor.core.staging.function_helper" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Function helper that generates a python AST FunctionDef node with given name,
arguments name, and body.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/staging.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">function_helper</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">body</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">stmt</span><span class="p">],</span>
                    <span class="n">nonlocals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Function helper that generates a python AST FunctionDef node with given name,</span>
<span class="sd">    arguments name, and body.&#39;&#39;&#39;</span>
    <span class="n">nonlocal_body</span> <span class="o">=</span> <span class="p">([</span><span class="n">ast</span><span class="o">.</span><span class="n">Nonlocal</span><span class="p">(</span><span class="n">nonlocals</span><span class="p">)]</span>
                     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonlocals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="n">body</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                           <span class="n">args</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span>
                               <span class="n">args</span><span class="o">=</span><span class="p">[],</span>
                               <span class="n">vararg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">kwarg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">posonlyargs</span><span class="o">=</span><span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">arg</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">],</span>
                               <span class="n">defaults</span><span class="o">=</span><span class="p">[],</span>
                               <span class="n">kwonlyargs</span><span class="o">=</span><span class="p">[],</span>
                               <span class="n">kw_defaults</span><span class="o">=</span><span class="p">[]),</span>
                           <span class="n">body</span><span class="o">=</span><span class="n">nonlocal_body</span><span class="p">,</span>
                           <span class="n">returns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">decorator_list</span><span class="o">=</span><span class="p">[])</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="freetensor.core.stmt" class="doc doc-heading">
          <code>stmt</code>


<a href="#freetensor.core.stmt" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">
  
      <p>Facility to build AST statements</p>
<p>Classes and functions in this module are internally used by <code>transformer</code> to construct ASTs.
They are also used by some internal tests. API of these classes and functions are subject to changes.
End users are encouraged to use <code>transformer</code>, instead of this module.</p>
<p>Classes and functions in this module are all in BigCamel naming style, to distinguish from
expressions in <code>expr.py</code></p>

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h4 id="freetensor.core.stmt.Assert" class="doc doc-heading">
        <code>Assert</code>


<a href="#freetensor.core.stmt.Assert" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">

  
      <p>Scope used to create an Assert node</p>
<p>This scope is internally used by <code>transformer</code> and tests</p>
<p>E.g.:</p>
<pre><code>with Assert(i &gt; 0):
    ... # Assertion body
</code></pre>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/stmt.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Assert</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Scope used to create an Assert node</span>

<span class="sd">    This scope is internally used by `transformer` and tests</span>

<span class="sd">    E.g.:</span>

<span class="sd">    ```</span>
<span class="sd">    with Assert(i &gt; 0):</span>
<span class="sd">        ... # Assertion body</span>
<span class="sd">    ```</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cond</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cond</span> <span class="o">=</span> <span class="n">cond</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Do not generate an AST node</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Do not suppress the exception</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">make_stmt</span><span class="p">()</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
        <span class="n">top</span><span class="o">.</span><span class="n">append_stmt</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">makeAssert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">top</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()))</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.stmt.Else" class="doc doc-heading">
        <code>Else</code>


<a href="#freetensor.core.stmt.Else" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">

  
      <p>Scope used to create an else branch of an If node</p>
<p>This scope is internally used by <code>transformer</code> and tests</p>
<p>E.g.:</p>
<pre><code>with If(i &gt; 0):
    ... # True branch
with Else():
    ... # Else branch
</code></pre>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/stmt.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Else</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Scope used to create an else branch of an If node</span>

<span class="sd">    This scope is internally used by `transformer` and tests</span>

<span class="sd">    E.g.:</span>

<span class="sd">    ```</span>
<span class="sd">    with If(i &gt; 0):</span>
<span class="sd">        ... # True branch</span>
<span class="sd">    with Else():</span>
<span class="sd">        ... # Else branch</span>
<span class="sd">    ```</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Do not generate an AST node</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Do not suppress the exception</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">make_stmt</span><span class="p">()</span>
        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">append_if_else_stmt</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.stmt.For" class="doc doc-heading">
        <code>For</code>


<a href="#freetensor.core.stmt.For" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">

  
      <p>Scope used to create a For node</p>
<p>This scope is internally used by <code>transformer</code> and tests</p>
<p>E.g.:</p>
<pre><code>with For('i', 0, n) as i:
    ... # Loop body
</code></pre>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/stmt.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">For</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Scope used to create a For node</span>

<span class="sd">    This scope is internally used by `transformer` and tests</span>

<span class="sd">    E.g.:</span>

<span class="sd">    ```</span>
<span class="sd">    with For(&#39;i&#39;, 0, n) as i:</span>
<span class="sd">        ... # Loop body</span>
<span class="sd">    ```</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">iter_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">begin</span><span class="p">,</span>
                 <span class="n">end</span><span class="p">,</span>
                 <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">no_deps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">prefer_libs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter_var</span> <span class="o">=</span> <span class="n">iter_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin</span> <span class="o">=</span> <span class="n">begin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_deps</span> <span class="o">=</span> <span class="n">no_deps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefer_libs</span> <span class="o">=</span> <span class="n">prefer_libs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">borrowed_vardefs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ffi</span><span class="o">.</span><span class="n">all_reads</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">borrowed_vardefs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">open_vardefs</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">borrowed_vardefs</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">lend_out</span><span class="p">()</span>
        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ffi</span><span class="o">.</span><span class="n">makeVar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_var</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">borrowed_vardefs</span><span class="p">:</span>
            <span class="n">item</span><span class="o">.</span><span class="n">reclaim</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exc_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Do not generate an AST node</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Do not suppress the exception</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">make_stmt</span><span class="p">()</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
        <span class="n">top</span><span class="o">.</span><span class="n">append_for_stmt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_var</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
                            <span class="n">body</span><span class="p">,</span>
                            <span class="n">metadata</span><span class="o">=</span><span class="n">ffi</span><span class="o">.</span><span class="n">SourceMetadata</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">])</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">no_deps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">no_deps</span><span class="p">,</span>
                            <span class="n">prefer_libs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prefer_libs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.stmt.If" class="doc doc-heading">
        <code>If</code>


<a href="#freetensor.core.stmt.If" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">

  
      <p>Scope used to create an If node</p>
<p>This scope is internally used by <code>transformer</code> and tests</p>
<p>E.g.:</p>
<pre><code>with If(i &gt; 0):
    ... # Branch body
</code></pre>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/stmt.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">If</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Scope used to create an If node</span>

<span class="sd">    This scope is internally used by `transformer` and tests</span>

<span class="sd">    E.g.:</span>

<span class="sd">    ```</span>
<span class="sd">    with If(i &gt; 0):</span>
<span class="sd">        ... # Branch body</span>
<span class="sd">    ```</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cond</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cond</span> <span class="o">=</span> <span class="n">cond</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Do not generate an AST node</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Do not suppress the exception</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">make_stmt</span><span class="p">()</span>
        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">append_if_then_stmt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.stmt.Invoke" class="doc doc-heading">
        <code>Invoke</code>


<a href="#freetensor.core.stmt.Invoke" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">

  
      <p>Inlined invocation of another AST</p>
<p><code>Invoke</code> is used as a scope (<code>with Invoke(...) as returned_vars</code>), so that variables returned by
the callee can be used in the socpe</p>
<p><code>Invoke</code> can be used for invoking a gradient function, which has already been lowered as an AST.
Please note that once a user function has been lowered as an AST, the dimensionalities of its
tensors get fixed. Therefore, to invoke ordinary user functions, please use <code>inline</code> in <code>transformer</code>
instead, which supports generic types</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/stmt.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Invoke</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Inlined invocation of another AST</span>

<span class="sd">    `Invoke` is used as a scope (`with Invoke(...) as returned_vars`), so that variables returned by</span>
<span class="sd">    the callee can be used in the socpe</span>

<span class="sd">    `Invoke` can be used for invoking a gradient function, which has already been lowered as an AST.</span>
<span class="sd">    Please note that once a user function has been lowered as an AST, the dimensionalities of its</span>
<span class="sd">    tensors get fixed. Therefore, to invoke ordinary user functions, please use `inline` in `transformer`</span>
<span class="sd">    instead, which supports generic types</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">ret_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                 <span class="n">func</span><span class="p">:</span> <span class="n">ffi</span><span class="o">.</span><span class="n">Func</span><span class="p">,</span>
                 <span class="n">args</span><span class="p">:</span> <span class="n">Sequence</span> <span class="o">=</span> <span class="p">[],</span>
                 <span class="n">kvs</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kvs</span> <span class="o">=</span> <span class="n">kvs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">returns</span> <span class="o">=</span> <span class="n">ffi</span><span class="o">.</span><span class="n">strip_returns</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vardefs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Outer to inner</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ret</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ret_names</span><span class="p">,</span> <span class="n">returns</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vardefs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_VarDef</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;cache&quot;</span><span class="p">,</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">mtype</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">varrefs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ret_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vardef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vardefs</span><span class="p">:</span>
            <span class="n">varref</span> <span class="o">=</span> <span class="n">vardef</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
            <span class="n">varrefs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varref</span><span class="p">)</span>
            <span class="n">ret_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varref</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">append_stmt</span><span class="p">(</span>
            <span class="n">ffi</span><span class="o">.</span><span class="n">inlined_invoke</span><span class="p">(</span><span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kvs</span><span class="p">,</span> <span class="n">ret_names</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">varrefs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">varrefs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">varrefs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">vardef</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vardefs</span><span class="p">):</span>
            <span class="n">vardef</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.stmt.NamedScope" class="doc doc-heading">
        <code>NamedScope</code>


<a href="#freetensor.core.stmt.NamedScope" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">

  
      <p>Scope used to create an StmtSeq node with an explicit labels</p>
<p>E.g.:</p>
<pre><code>with NamedScope():
    ... # body
</code></pre>
<p>This scope is used for testing only. StmtSeq nodes can be deleted in many lowering passes</p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/stmt.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">NamedScope</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Scope used to create an StmtSeq node with an explicit labels</span>

<span class="sd">    E.g.:</span>

<span class="sd">    ```</span>
<span class="sd">    with NamedScope():</span>
<span class="sd">        ... # body</span>
<span class="sd">    ```</span>

<span class="sd">    This scope is used for testing only. StmtSeq nodes can be deleted in many lowering passes</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">labels</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Do not generate an AST node</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Do not suppress the exception</span>
        <span class="n">finished_scope</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">finished_scope</span><span class="o">.</span><span class="n">make_stmt</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">append_stmt</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="freetensor.core.stmt.UserGradStaged" class="doc doc-heading">
        <code>UserGradStaged</code>


<a href="#freetensor.core.stmt.UserGradStaged" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">

  
      <p>Internal staged implementation of <code>UserGrad</code></p>


        <details class="quote">
          <summary>Source code in <code>python/freetensor/core/stmt.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">UserGradStaged</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Internal staged implementation of `UserGrad`</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">VarRef</span><span class="p">],</span> <span class="o">**</span><span class="n">kvs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ori_vars</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_defs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;stmt_range&#39;</span> <span class="ow">in</span> <span class="n">kvs</span><span class="p">:</span>
            <span class="n">stmt_range</span> <span class="o">=</span> <span class="n">kvs</span><span class="p">[</span><span class="s1">&#39;stmt_range&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt_range</span><span class="p">,</span> <span class="n">StmtRange</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ori_stmts</span> <span class="o">=</span> <span class="n">stmt_range</span><span class="o">.</span><span class="n">make</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;`stmt_range` should be a `StmtRange` for `UserGrad`&quot;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">kvs</span><span class="p">[</span><span class="s1">&#39;stmt_range&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ori_stmts</span> <span class="o">=</span> <span class="p">{</span><span class="n">ctx_stack</span><span class="o">.</span><span class="n">get_last_stmt_id</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kvs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized parameter `</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">` of `UserGrad`&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Make `VarDef` scopes for the gradients</span>
        <span class="n">grad_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ori_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ori_vars</span><span class="p">:</span>
            <span class="n">grad_def</span> <span class="o">=</span> <span class="n">VarDef</span><span class="p">(</span><span class="n">ori_var</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.grad&quot;</span><span class="p">,</span> <span class="n">ori_var</span><span class="o">.</span><span class="n">full_shape</span><span class="p">,</span>
                              <span class="n">ori_var</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s2">&quot;cache&quot;</span><span class="p">,</span> <span class="n">ori_var</span><span class="o">.</span><span class="n">mtype</span><span class="p">)</span>
            <span class="n">grad_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_def</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grad_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_def</span><span class="p">)</span>

        <span class="c1"># Make a context, which is used for popping out the body we need</span>
        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">grad_vars</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="c1"># Pop out the body we need</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">make_stmt</span><span class="p">()</span>

        <span class="c1"># Although we are discarding the gradient `VarDef` scopes, we still need to close</span>
        <span class="c1"># them, to restore ctx_stack. After that, we pop out the `VarDef` statement</span>
        <span class="k">for</span> <span class="n">grad_def</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grad_defs</span><span class="p">):</span>
            <span class="n">grad_def</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exc_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Do not generate an AST node</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Do not suppress the exception</span>
        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">stmt_seq</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="c1"># Record the body to context</span>
        <span class="n">ctx_stack</span><span class="o">.</span><span class="n">user_grads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ffi</span><span class="o">.</span><span class="n">StmtSetToUserGrad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ori_stmts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>


<div class="doc doc-object doc-function">



<h4 id="freetensor.core.stmt.Any" class="doc doc-heading">
<code class="highlight language-python"><span class="n">Any</span><span class="p">()</span></code>

<a href="#freetensor.core.stmt.Any" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Create an Any node (only for testing)</p>
<p>Any nodes matches any statement nodes in <code>ast.match</code></p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/stmt.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">Any</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create an Any node (only for testing)</span>

<span class="sd">    Any nodes matches any statement nodes in `ast.match`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">append_stmt</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">makeAny</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.stmt.Eval" class="doc doc-heading">
<code class="highlight language-python"><span class="n">Eval</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></code>

<a href="#freetensor.core.stmt.Eval" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Create an Eval node</p>
<p>This scope is internally used by <code>transformer</code> and tests</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/stmt.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">Eval</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create an Eval node</span>

<span class="sd">    This scope is internally used by `transformer` and tests</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">top</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
    <span class="n">top</span><span class="o">.</span><span class="n">append_stmt</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">makeEval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">top</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.stmt.MarkLabel" class="doc doc-heading">
<code class="highlight language-python"><span class="n">MarkLabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></code>

<a href="#freetensor.core.stmt.MarkLabel" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Mark the ID of the following statement</p>
<p>This scope is internally used by <code>transformer</code> and tests</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/stmt.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">MarkLabel</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mark the ID of the following statement</span>

<span class="sd">    This scope is internally used by `transformer` and tests</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.stmt.MarkVersion" class="doc doc-heading">
<code class="highlight language-python"><span class="n">MarkVersion</span><span class="p">(</span><span class="n">tape_name</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span></code>

<a href="#freetensor.core.stmt.MarkVersion" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Create an MarkVersion node (only for custom gradient)</p>
<p>This node is only used for custom gradient. See <code>UserGrad</code>.</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/stmt.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">MarkVersion</span><span class="p">(</span><span class="n">tape_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="n">VarRef</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create an MarkVersion node (only for custom gradient)</span>

<span class="sd">    This node is only used for custom gradient. See `UserGrad`.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">top</span> <span class="o">=</span> <span class="n">ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="p">()</span>
    <span class="n">top</span><span class="o">.</span><span class="n">append_stmt</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">makeMarkVersion</span><span class="p">(</span><span class="n">tape_name</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                        <span class="n">top</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.core.stmt.VarDef" class="doc doc-heading">
<code class="highlight language-python"><span class="n">VarDef</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kvs</span><span class="p">)</span></code>

<a href="#freetensor.core.stmt.VarDef" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>A factory function that creates a VarDef or a series of nested <code>VarDef</code>s</p>
<p>This scope is internally used by <code>transformer</code> and tests</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/core/stmt.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">VarDef</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kvs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A factory function that creates a VarDef or a series of nested `VarDef`s</span>

<span class="sd">    This scope is internally used by `transformer` and tests</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_VarsDef</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_VarDef</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kvs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="freetensor.libop" class="doc doc-heading">
          <code>libop</code>


<a href="#freetensor.libop" class="headerlink" title="Permanent link">&para;</a></h2>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="freetensor.libop.constant" class="doc doc-heading">
          <code>constant</code>


<a href="#freetensor.libop.constant" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="freetensor.libop.constant.zeros" class="doc doc-heading">
<code class="highlight language-python"><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mtype</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.libop.constant.zeros" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Create a zero tensor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>shape</code></td>
          <td>
                <code>Sequence[Expr] or Var</code>
          </td>
          <td><p>Shape of the variable. A variable can be created using a literal shape,
or another fixed-length VarRef as a shape</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dtype</code></td>
          <td>
                <code>str or DataType</code>
          </td>
          <td><p>Data type of the variable</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>mtype</code></td>
          <td>
                <code>str or MemType (Optional)</code>
          </td>
          <td><p>Memory type of the variable. If omitted, the main memory type of the
default Target in config will be used</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>VarRef</code></td>          <td>
          </td>
          <td><p>The zero tensor</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/libop/constant.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@core</span><span class="o">.</span><span class="n">inline</span>
<span class="k">def</span> <span class="nf">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create a zero tensor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shape : Sequence[Expr] or Var</span>
<span class="sd">        Shape of the variable. A variable can be created using a literal shape,</span>
<span class="sd">        or another fixed-length VarRef as a shape</span>
<span class="sd">    dtype : str or DataType</span>
<span class="sd">        Data type of the variable</span>
<span class="sd">    mtype : str or MemType (Optional)</span>
<span class="sd">        Memory type of the variable. If omitted, the main memory type of the</span>
<span class="sd">        default Target in config will be used</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef :</span>
<span class="sd">        The zero tensor</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mtype</span><span class="p">)</span>
    <span class="c1">#! label: recur</span>
    <span class="n">zeros_</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.libop.constant.zeros_" class="doc doc-heading">
<code class="highlight language-python"><span class="n">zeros_</span><span class="p">(</span><span class="n">y</span><span class="p">)</span></code>

<a href="#freetensor.libop.constant.zeros_" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Fill zeros to a tensor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>y</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The tensor to fill</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/libop/constant.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@core</span><span class="o">.</span><span class="n">inline</span>
<span class="k">def</span> <span class="nf">zeros_</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Fill zeros to a tensor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    y : VarRef</span>
<span class="sd">        The tensor to fill</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">y</span><span class="p">[()]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">zero_value</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#! label: L_elem</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="c1">#! label: recur</span>
            <span class="n">zeros_</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="freetensor.libop.element_wise" class="doc doc-heading">
          <code>element_wise</code>


<a href="#freetensor.libop.element_wise" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="freetensor.libop.element_wise.binary_op" class="doc doc-heading">
<code class="highlight language-python"><span class="n">binary_op</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></code>

<a href="#freetensor.libop.element_wise.binary_op" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>(Broadcasted) any element-wise operation on two tensors and return the result</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>op</code></td>
          <td>
                <code>Callable</code>
          </td>
          <td><p>The operation applied to each item</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>a</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>Left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>b</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>Right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The result tensor</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/libop/element_wise.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@core</span><span class="o">.</span><span class="n">inline</span>
<span class="k">def</span> <span class="nf">binary_op</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    (Broadcasted) any element-wise operation on two tensors and return the result</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    op : Callable</span>
<span class="sd">        The operation applied to each item</span>
<span class="sd">    a : VarRef</span>
<span class="sd">        Left-hand-side operand</span>
<span class="sd">    b : VarRef</span>
<span class="sd">        Right-hand-side operand</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef</span>
<span class="sd">        The result tensor</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#! label: out</span>
    <span class="c1"># NOTE: We only inference base data type, to avoid confusion in case the result</span>
    <span class="c1"># tensor is further assigned by users with other sign data types</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
        <span class="n">broadcast_shape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
        <span class="n">core</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
            <span class="n">op</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span> <span class="n">core</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">a</span><span class="p">)),</span>
               <span class="n">core</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span> <span class="n">core</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">b</span><span class="p">))))</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
        <span class="n">core</span><span class="o">.</span><span class="n">same_mtype</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">mtype</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">core</span><span class="o">.</span><span class="n">mtype</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>
    <span class="c1">#! label: recur</span>
    <span class="n">binary_op_</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.libop.element_wise.binary_op_" class="doc doc-heading">
<code class="highlight language-python"><span class="n">binary_op_</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span></code>

<a href="#freetensor.libop.element_wise.binary_op_" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>(Broadcasted) any element-wise operation on two tensors. The result is written to another tensor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>op</code></td>
          <td>
                <code>Callable</code>
          </td>
          <td><p>The operation applied to each item</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>a</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>Left-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>b</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>Right-hand-side operand</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>out</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The result tensor</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/libop/element_wise.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@core</span><span class="o">.</span><span class="n">inline</span>
<span class="k">def</span> <span class="nf">binary_op_</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    (Broadcasted) any element-wise operation on two tensors. The result is written to another tensor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    op : Callable</span>
<span class="sd">        The operation applied to each item</span>
<span class="sd">    a : VarRef</span>
<span class="sd">        Left-hand-side operand</span>
<span class="sd">    b : VarRef</span>
<span class="sd">        Right-hand-side operand</span>
<span class="sd">    out : VarRef</span>
<span class="sd">        The result tensor</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[()]</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#! label: L_elem</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">core</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1">#! label: recur</span>
                <span class="n">binary_op_</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">core</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">core</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1">#! label: recur</span>
                <span class="n">binary_op_</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">b</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">assert</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="c1">#! label: recur</span>
                <span class="n">binary_op_</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.libop.element_wise.unary_op" class="doc doc-heading">
<code class="highlight language-python"><span class="n">unary_op</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>

<a href="#freetensor.libop.element_wise.unary_op" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Any element-wise operation on a tensor and return the result</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>op</code></td>
          <td>
                <code>Callable</code>
          </td>
          <td><p>The operation applied to each item</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>x</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The input tensor</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The result tensor</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/libop/element_wise.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@core</span><span class="o">.</span><span class="n">inline</span>
<span class="k">def</span> <span class="nf">unary_op</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Any element-wise operation on a tensor and return the result</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    op : Callable</span>
<span class="sd">        The operation applied to each item</span>
<span class="sd">    x : VarRef</span>
<span class="sd">        The input tensor</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef</span>
<span class="sd">        The result tensor</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#! label: y</span>
    <span class="c1"># NOTE: We only inference base data type, to avoid confusion in case the result</span>
    <span class="c1"># tensor is further assigned by users with other sign data types</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">copy_shape</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                   <span class="n">core</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">op</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span> <span class="n">core</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
                   <span class="n">core</span><span class="o">.</span><span class="n">mtype</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="c1">#! label: recur</span>
    <span class="n">unary_op_</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.libop.element_wise.unary_op_" class="doc doc-heading">
<code class="highlight language-python"><span class="n">unary_op_</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></code>

<a href="#freetensor.libop.element_wise.unary_op_" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Any element-wise operation on a tensor. The result is written to another tensor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>op</code></td>
          <td>
                <code>Callable</code>
          </td>
          <td><p>The operation applied to each item</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>x</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The input tensor</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>out</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The result tensor</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/libop/element_wise.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@core</span><span class="o">.</span><span class="n">inline</span>
<span class="k">def</span> <span class="nf">unary_op_</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Any element-wise operation on a tensor. The result is written to another tensor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    op : Callable</span>
<span class="sd">        The operation applied to each item</span>
<span class="sd">    x : VarRef</span>
<span class="sd">        The input tensor</span>
<span class="sd">    out : VarRef</span>
<span class="sd">        The result tensor</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">y</span><span class="p">[()]</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1">#! label: L_elem</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
            <span class="c1">#! label: recur</span>
            <span class="n">unary_op_</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="freetensor.libop.pooling" class="doc doc-heading">
          <code>pooling</code>


<a href="#freetensor.libop.pooling" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="freetensor.libop.pooling.global_avg_pool" class="doc doc-heading">
<code class="highlight language-python"><span class="n">global_avg_pool</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></code>

<a href="#freetensor.libop.pooling.global_avg_pool" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Global averaging pooling. The result is returned</p>
<p>Parameters follow ONNX convention. Currently only 2-D pooling is supported</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/libop/pooling.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@core</span><span class="o">.</span><span class="n">inline</span>
<span class="k">def</span> <span class="nf">global_avg_pool</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Global averaging pooling. The result is returned</span>

<span class="sd">    Parameters follow ONNX convention. Currently only 2-D pooling is supported</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">n_spatial_dim</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Currently only 2-D pooling is supported (TODO)</span>

    <span class="n">Y</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">mtype</span><span class="p">)</span>
    <span class="c1">#! label: recur</span>
    <span class="n">global_avg_pool_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Y</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.libop.pooling.global_avg_pool_" class="doc doc-heading">
<code class="highlight language-python"><span class="n">global_avg_pool_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span></code>

<a href="#freetensor.libop.pooling.global_avg_pool_" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Global averaging pooling. The result is written to another tensor</p>
<p>Parameters follow ONNX convention. Currently only 2-D pooling is supported</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/libop/pooling.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@core</span><span class="o">.</span><span class="n">inline</span>
<span class="k">def</span> <span class="nf">global_avg_pool_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Global averaging pooling. The result is written to another tensor</span>

<span class="sd">    Parameters follow ONNX convention. Currently only 2-D pooling is supported</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">n_spatial_dim</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Currently only 2-D pooling is supported (TODO)</span>
    <span class="c1">#! label: L_n</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
        <span class="c1">#! label: L_c</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
            <span class="c1">#! label: init</span>
            <span class="n">Y</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1">#! label: L_h</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">2</span><span class="p">)):</span>
                <span class="c1">#! label: L_w</span>
                <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
                    <span class="c1">#! label: compute</span>
                    <span class="n">Y</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">+=</span> <span class="n">X</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">]</span>
            <span class="c1">#! label: flush</span>
            <span class="n">Y</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">/=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.libop.pooling.max_pool" class="doc doc-heading">
<code class="highlight language-python"><span class="n">max_pool</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">auto_pad</span><span class="o">=</span><span class="s1">&#39;NOTSET&#39;</span><span class="p">,</span> <span class="n">dilations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kernel_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.libop.pooling.max_pool" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Maximum pooling. The result is returned</p>
<p>Parameters follow ONNX convention. Currently only 2-D pooling is supported</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/libop/pooling.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@core</span><span class="o">.</span><span class="n">inline</span>
<span class="k">def</span> <span class="nf">max_pool</span><span class="p">(</span><span class="n">X</span><span class="p">,</span>
             <span class="n">auto_pad</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;NOTSET&#39;</span><span class="p">,</span>
             <span class="n">dilations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">kernel_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">pads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">strides</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Maximum pooling. The result is returned</span>

<span class="sd">    Parameters follow ONNX convention. Currently only 2-D pooling is supported</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">n_spatial_dim</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Currently only 2-D pooling is supported (TODO)</span>

    <span class="c1"># TODO: ceil_mode</span>
    <span class="c1"># TODO: return_indices</span>

    <span class="k">if</span> <span class="n">dilations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dilations</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_spatial_dim</span>
    <span class="k">if</span> <span class="n">strides</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># NOTE: strides default to 1 in ONNX, while default to kernel_shape in PyTorch</span>
        <span class="n">strides</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_spatial_dim</span>
    <span class="k">if</span> <span class="n">pads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">auto_pad</span> <span class="o">==</span> <span class="s1">&#39;VALID&#39;</span><span class="p">:</span>
            <span class="n">pads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">n_spatial_dim</span><span class="p">)))</span>
            <span class="n">pads</span> <span class="o">=</span> <span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pads</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">auto_pad</span> <span class="o">==</span> <span class="s1">&#39;SAME_UPPER&#39;</span><span class="p">:</span>
            <span class="n">pads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
                    <span class="n">calc_same_upper_pad</span><span class="p">(</span><span class="n">dil</span><span class="p">,</span> <span class="n">kern</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span> <span class="k">for</span> <span class="n">dil</span><span class="p">,</span> <span class="n">kern</span><span class="p">,</span> <span class="n">stride</span>
                    <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dilations</span><span class="p">,</span> <span class="n">kernel_shape</span><span class="p">,</span> <span class="n">strides</span><span class="p">)</span>
                <span class="p">]))</span>
            <span class="n">pads</span> <span class="o">=</span> <span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pads</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">auto_pad</span> <span class="o">==</span> <span class="s1">&#39;SAME_LOWER&#39;</span><span class="p">:</span>
            <span class="n">pads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
                    <span class="n">calc_same_lower_pad</span><span class="p">(</span><span class="n">dil</span><span class="p">,</span> <span class="n">kern</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span> <span class="k">for</span> <span class="n">dil</span><span class="p">,</span> <span class="n">kern</span><span class="p">,</span> <span class="n">stride</span>
                    <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dilations</span><span class="p">,</span> <span class="n">kernel_shape</span><span class="p">,</span> <span class="n">strides</span><span class="p">)</span>
                <span class="p">]))</span>
            <span class="n">pads</span> <span class="o">=</span> <span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pads</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;auto_pad should be set if pads is not specified&quot;</span>

    <span class="n">Y</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span>
        <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">calc_out_size</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dilations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">kernel_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">pads</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">calc_out_size</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">dilations</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">kernel_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pads</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                      <span class="n">pads</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">strides</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">mtype</span><span class="p">)</span>
    <span class="c1">#! label: recur</span>
    <span class="n">max_pool_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">auto_pad</span><span class="p">,</span> <span class="n">dilations</span><span class="p">,</span> <span class="n">kernel_shape</span><span class="p">,</span> <span class="n">pads</span><span class="p">,</span> <span class="n">strides</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Y</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.libop.pooling.max_pool_" class="doc doc-heading">
<code class="highlight language-python"><span class="n">max_pool_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">auto_pad</span><span class="o">=</span><span class="s1">&#39;NOTSET&#39;</span><span class="p">,</span> <span class="n">dilations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kernel_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#freetensor.libop.pooling.max_pool_" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Maximum pooling. The result is written to another tensor</p>
<p>Parameters follow ONNX convention. Currently only 2-D pooling is supported</p>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/libop/pooling.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@core</span><span class="o">.</span><span class="n">inline</span>
<span class="k">def</span> <span class="nf">max_pool_</span><span class="p">(</span><span class="n">X</span><span class="p">,</span>
              <span class="n">Y</span><span class="p">,</span>
              <span class="n">auto_pad</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;NOTSET&#39;</span><span class="p">,</span>
              <span class="n">dilations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">kernel_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">pads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">strides</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Maximum pooling. The result is written to another tensor</span>

<span class="sd">    Parameters follow ONNX convention. Currently only 2-D pooling is supported</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">n_spatial_dim</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Currently only 2-D pooling is supported (TODO)</span>

    <span class="c1"># TODO: ceil_mode</span>
    <span class="c1"># TODO: return_indices</span>

    <span class="k">if</span> <span class="n">dilations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dilations</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_spatial_dim</span>
    <span class="k">if</span> <span class="n">strides</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># NOTE: strides default to 1 in ONNX, while default to kernel_shape in PyTorch</span>
        <span class="n">strides</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_spatial_dim</span>
    <span class="k">if</span> <span class="n">pads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">auto_pad</span> <span class="o">==</span> <span class="s1">&#39;VALID&#39;</span><span class="p">:</span>
            <span class="n">pads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">n_spatial_dim</span><span class="p">)))</span>
            <span class="n">pads</span> <span class="o">=</span> <span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pads</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">auto_pad</span> <span class="o">==</span> <span class="s1">&#39;SAME_UPPER&#39;</span><span class="p">:</span>
            <span class="n">pads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
                    <span class="n">calc_same_upper_pad</span><span class="p">(</span><span class="n">dil</span><span class="p">,</span> <span class="n">kern</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span> <span class="k">for</span> <span class="n">dil</span><span class="p">,</span> <span class="n">kern</span><span class="p">,</span> <span class="n">stride</span>
                    <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dilations</span><span class="p">,</span> <span class="n">kernel_shape</span><span class="p">,</span> <span class="n">strides</span><span class="p">)</span>
                <span class="p">]))</span>
            <span class="n">pads</span> <span class="o">=</span> <span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pads</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">auto_pad</span> <span class="o">==</span> <span class="s1">&#39;SAME_LOWER&#39;</span><span class="p">:</span>
            <span class="n">pads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
                    <span class="n">calc_same_lower_pad</span><span class="p">(</span><span class="n">dil</span><span class="p">,</span> <span class="n">kern</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span> <span class="k">for</span> <span class="n">dil</span><span class="p">,</span> <span class="n">kern</span><span class="p">,</span> <span class="n">stride</span>
                    <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dilations</span><span class="p">,</span> <span class="n">kernel_shape</span><span class="p">,</span> <span class="n">strides</span><span class="p">)</span>
                <span class="p">]))</span>
            <span class="n">pads</span> <span class="o">=</span> <span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pads</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;auto_pad should be set if pads is not specified&quot;</span>

    <span class="c1"># yapf: disable</span>
    <span class="c1">#! label: L_n</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
        <span class="c1">#! label: L_c</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
            <span class="c1">#! label: L_h</span>
            <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">2</span><span class="p">)):</span>
                <span class="c1">#! label: L_w</span>
                <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
                    <span class="c1">#! label: init</span>
                    <span class="n">Y</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">min_value</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="c1">#! label: L_kh</span>
                    <span class="k">for</span> <span class="n">kh</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kernel_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="c1">#! label: L_kw</span>
                        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kernel_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="c1"># h_in = h * stride + kh * dilation - pad</span>
                            <span class="c1"># w_in = w * stride + kw * dilation - pad</span>
                            <span class="k">if</span> <span class="p">(</span>
                                    <span class="n">h</span> <span class="o">*</span> <span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">kh</span> <span class="o">*</span> <span class="n">dilations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span>
                                    <span class="n">h</span> <span class="o">*</span> <span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">kh</span> <span class="o">*</span> <span class="n">dilations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">and</span>
                                    <span class="n">w</span> <span class="o">*</span> <span class="n">strides</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">kw</span> <span class="o">*</span> <span class="n">dilations</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pads</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span>
                                    <span class="n">w</span> <span class="o">*</span> <span class="n">strides</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">kw</span> <span class="o">*</span> <span class="n">dilations</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pads</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
                                <span class="c1">#! label: compute</span>
                                <span class="n">Y</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                                    <span class="n">Y</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">],</span>
                                    <span class="n">X</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span>
                                        <span class="n">h</span> <span class="o">*</span> <span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">kh</span> <span class="o">*</span> <span class="n">dilations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="n">w</span> <span class="o">*</span> <span class="n">strides</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">kw</span> <span class="o">*</span> <span class="n">dilations</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pads</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="freetensor.libop.reduction" class="doc doc-heading">
          <code>reduction</code>


<a href="#freetensor.libop.reduction" class="headerlink" title="Permanent link">&para;</a></h3>

  <div class="doc doc-contents ">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h4 id="freetensor.libop.reduction.reduce_max" class="doc doc-heading">
<code class="highlight language-python"><span class="n">reduce_max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#freetensor.libop.reduction.reduce_max" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Maximum of a tensor through one or more dimensions and return the result</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>x</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The input tensor</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>axes</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[int](<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Which dimensions to reduce through. Defaults to None, standing for all dimensions,
i.e., reduce the tensor to a scalar. Negative axis means counting form the last dimension</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>keepdims</code></td>
          <td>
                <code>bool(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Keep the reduced dimensions as singleton dimensions. Defaults to True</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The result tensor</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/libop/reduction.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@core</span><span class="o">.</span><span class="n">inline</span>
<span class="k">def</span> <span class="nf">reduce_max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">keepdims</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Maximum of a tensor through one or more dimensions and return the result</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : VarRef</span>
<span class="sd">        The input tensor</span>
<span class="sd">    axes : Sequence[int] (Optional)</span>
<span class="sd">        Which dimensions to reduce through. Defaults to None, standing for all dimensions,</span>
<span class="sd">        i.e., reduce the tensor to a scalar. Negative axis means counting form the last dimension</span>
<span class="sd">    keepdims : bool (Optional)</span>
<span class="sd">        Keep the reduced dimensions as singleton dimensions. Defaults to True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef</span>
<span class="sd">        The result tensor</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#! label: impl</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">_general_reduce</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">min_value</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">x</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span>
                        <span class="n">keepdims</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.libop.reduction.reduce_max_" class="doc doc-heading">
<code class="highlight language-python"><span class="n">reduce_max_</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#freetensor.libop.reduction.reduce_max_" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Maximum of a tensor through one or more dimensions. The result is written to another tensor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>x</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The input tensor</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>y</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The result tensor</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>axes</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[int](<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Which dimensions to reduce through. Defaults to None, standing for all dimensions,
i.e., reduce the tensor to a scalar. Negative axis means counting form the last dimension</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>keepdims</code></td>
          <td>
                <code>bool(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Keep the reduced dimensions as singleton dimensions. Defaults to True</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/libop/reduction.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@core</span><span class="o">.</span><span class="n">inline</span>
<span class="k">def</span> <span class="nf">reduce_max_</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">keepdims</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Maximum of a tensor through one or more dimensions. The result is written to another tensor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : VarRef</span>
<span class="sd">        The input tensor</span>
<span class="sd">    y : VarRef</span>
<span class="sd">        The result tensor</span>
<span class="sd">    axes : Sequence[int] (Optional)</span>
<span class="sd">        Which dimensions to reduce through. Defaults to None, standing for all dimensions,</span>
<span class="sd">        i.e., reduce the tensor to a scalar. Negative axis means counting form the last dimension</span>
<span class="sd">    keepdims : bool (Optional)</span>
<span class="sd">        Keep the reduced dimensions as singleton dimensions. Defaults to True</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#! label: impl</span>
    <span class="n">_general_reduce_</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">min_value</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span>
                     <span class="n">keepdims</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.libop.reduction.reduce_min" class="doc doc-heading">
<code class="highlight language-python"><span class="n">reduce_min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#freetensor.libop.reduction.reduce_min" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Minimum of a tensor through one or more dimensions and return the result</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>x</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The input tensor</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>axes</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[int](<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Which dimensions to reduce through. Defaults to None, standing for all dimensions,
i.e., reduce the tensor to a scalar. Negative axis means counting form the last dimension</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>keepdims</code></td>
          <td>
                <code>bool(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Keep the reduced dimensions as singleton dimensions. Defaults to True</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The result tensor</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/libop/reduction.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@core</span><span class="o">.</span><span class="n">inline</span>
<span class="k">def</span> <span class="nf">reduce_min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">keepdims</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Minimum of a tensor through one or more dimensions and return the result</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : VarRef</span>
<span class="sd">        The input tensor</span>
<span class="sd">    axes : Sequence[int] (Optional)</span>
<span class="sd">        Which dimensions to reduce through. Defaults to None, standing for all dimensions,</span>
<span class="sd">        i.e., reduce the tensor to a scalar. Negative axis means counting form the last dimension</span>
<span class="sd">    keepdims : bool (Optional)</span>
<span class="sd">        Keep the reduced dimensions as singleton dimensions. Defaults to True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    VarRef</span>
<span class="sd">        The result tensor</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#! label: impl</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">_general_reduce</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">max_value</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">x</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span>
                        <span class="n">keepdims</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h4 id="freetensor.libop.reduction.reduce_min_" class="doc doc-heading">
<code class="highlight language-python"><span class="n">reduce_min_</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#freetensor.libop.reduction.reduce_min_" class="headerlink" title="Permanent link">&para;</a></h4>


  <div class="doc doc-contents ">
  
      <p>Minimum of a tensor through one or more dimensions. The result is written to another tensor</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>x</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The input tensor</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>y</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="freetensor.core.VarRef" href="#freetensor.core.expr.VarRef">VarRef</a></code>
          </td>
          <td><p>The result tensor</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>axes</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[int](<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Which dimensions to reduce through. Defaults to None, standing for all dimensions,
i.e., reduce the tensor to a scalar. Negative axis means counting form the last dimension</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>keepdims</code></td>
          <td>
                <code>bool(<span title="typing.Optional">Optional</span>)</code>
          </td>
          <td><p>Keep the reduced dimensions as singleton dimensions. Defaults to True</p></td>
          <td>
                <code>True</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>python/freetensor/libop/reduction.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@core</span><span class="o">.</span><span class="n">inline</span>
<span class="k">def</span> <span class="nf">reduce_min_</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">keepdims</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Minimum of a tensor through one or more dimensions. The result is written to another tensor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : VarRef</span>
<span class="sd">        The input tensor</span>
<span class="sd">    y : VarRef</span>
<span class="sd">        The result tensor</span>
<span class="sd">    axes : Sequence[int] (Optional)</span>
<span class="sd">        Which dimensions to reduce through. Defaults to None, standing for all dimensions,</span>
<span class="sd">        i.e., reduce the tensor to a scalar. Negative axis means counting form the last dimension</span>
<span class="sd">    keepdims : bool (Optional)</span>
<span class="sd">        Keep the reduced dimensions as singleton dimensions. Defaults to True</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#! label: impl</span>
    <span class="n">_general_reduce_</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">max_value</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span>
                     <span class="n">keepdims</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>


  </div>

  </div>

</div>


  </div>

  </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../guide/ad/" class="btn btn-neutral float-left" title="Automatic Differentiation"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../doxygen/html/" class="btn btn-neutral float-right" title="Internal C++ Interface">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../guide/ad/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../doxygen/html/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../javascripts/mathjax.js" defer></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
